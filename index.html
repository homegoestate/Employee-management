<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®åœ‹åœ°æ”¿|æ˜“ä¸åœ°æ”¿ - æ™ºæ…§æŒ‡æ®è‰™ (Nexus V5.11 Celebration)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .serif { font-family: 'Noto Serif TC', serif; }
        .brand-bg { background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%); } 
        .text-brand-gold { color: #facc15; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-radius: 1rem; transition: all 0.3s ease; }
        .input-modern { background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.5rem; transition: all 0.2s; }
        .input-modern:focus { background: #fff; border-color: #2563eb; outline: none; }
        .hidden-section { display: none; }
        
        .fade-in-up { animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* è–ªè³‡æ‹‰æ¢ */
        input[type=range] {
            -webkit-appearance: none; width: 100%; height: 6px; border-radius: 5px;
            background: #cbd5e1; outline: none; margin: 10px 0;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; 
            background: #2563eb; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        /* è–ªè³‡å½±éŸ¿æç¤ºå¡ */
        .impact-card { transition: all 0.3s ease; border-left: 4px solid; background-color: white; border: 1px solid #e2e8f0; }
        .impact-full { border-left-color: #22c55e; background-color: #f0fdf4; } 
        .impact-half { border-left-color: #f97316; background-color: #fff7ed; } 
        .impact-none { border-left-color: #ef4444; background-color: #fef2f2; } 

        .btn-punch:active { transform: scale(0.95); }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: bold; background-color: #f0f9ff; }
        .tab-inactive { color: #64748b; background-color: transparent; }
        .device-badge { font-family: monospace; font-size: 0.7rem; background: #e2e8f0; padding: 2px 6px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px; }

        /* Modal Overlay */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 95%; max-width: 900px; max-height: 90vh; border-radius: 1rem; padding: 0; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        
        /* Custom Scrollbar for feeds */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* LSA Badge */
        .lsa-badge { font-size: 0.65rem; background-color: #e0f2fe; color: #0369a1; padding: 2px 6px; border-radius: 4px; border: 1px solid #bae6fd; display: inline-block; margin-top: 4px; }
        
        /* Status Tags */
        .tag-late { background-color: #fee2e2; color: #991b1b; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; border: 1px solid #fecaca; }
        .tag-ot { background-color: #f3e8ff; color: #6b21a8; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; border: 1px solid #e9d5ff; }
        .tag-ok { background-color: #dcfce7; color: #166534; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; border: 1px solid #bbf7d0; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="brand-bg text-white sticky top-0 z-50 shadow-md">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white text-blue-900 rounded-lg flex items-center justify-center font-bold text-lg serif shadow-lg">å®</div>
                <div>
                    <h1 class="text-base md:text-lg font-bold tracking-wider serif">å®åœ‹åœ°æ”¿ | æ˜“ä¸åœ°æ”¿</h1>
                    <p class="text-[10px] text-blue-200 tracking-widest uppercase">Nexus V5.11 (Celebration)</p>
                </div>
            </div>
            <div class="flex bg-blue-900/50 rounded-full p-1">
                <button onclick="switchView('employee')" id="btnEmp" class="px-4 py-1.5 rounded-full text-xs md:text-sm font-medium transition-all bg-white text-blue-900 shadow-sm">åŒä»å°ˆå€</button>
                <button onclick="checkAdminLogin()" id="btnAdm" class="px-4 py-1.5 rounded-full text-xs md:text-sm font-medium text-blue-200 hover:text-white transition-all">ç®¡ç†å¾Œå°</button>
            </div>
        </div>
    </header>

    <main class="flex-grow p-4 md:p-6 max-w-7xl mx-auto w-full">
        <section id="loginSection" class="w-full glass-panel p-10 text-center max-w-lg mx-auto mt-12 fade-in-up">
            <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-2xl"><i class="fa-solid fa-mobile-screen-button"></i></div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">è£ç½®é©—è­‰ç³»çµ±</h2>
            <p class="text-slate-500 mb-4 text-sm">ç³»çµ±å°‡è‡ªå‹•è­˜åˆ¥æ‚¨çš„è£ç½®æ¬Šé™</p>
            
            <div class="bg-slate-100 p-2 rounded mb-6 text-xs text-slate-400 font-mono">
                æœ¬æ©Ÿ ID: <span id="myDeviceIdDisplay">åµæ¸¬ä¸­...</span>
            </div>

            <select id="empSelect" onchange="tryBindAndLogin()" class="w-full p-3 pl-4 text-lg input-modern cursor-pointer text-center font-bold text-slate-700 disabled:opacity-50 mb-4" disabled>
                <option value="">-- è³‡æ–™è¼‰å…¥ä¸­ --</option>
            </select>

            <div id="loginStatusMsg" class="text-sm text-blue-600 font-bold hidden">
                <i class="fa-solid fa-spinner fa-spin"></i> æ­£åœ¨é©—è­‰è£ç½®å®‰å…¨æ€§...
            </div>
        </section>

        <section id="employeeView" class="w-full space-y-6 hidden-section">
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in-up">
                <div class="lg:col-span-2 brand-bg rounded-2xl p-6 text-white relative overflow-hidden shadow-xl flex flex-col justify-center min-h-[160px]">
                    <div class="absolute top-0 right-0 bg-white/10 px-3 py-1 rounded-bl-lg text-[10px] font-bold tracking-widest uppercase text-blue-200">Official Notice</div>
                    <div class="relative z-10 flex flex-col md:flex-row items-start gap-4">
                        <div class="bg-white/10 p-3 rounded-xl backdrop-blur-sm shrink-0"><i class="fa-solid fa-bullhorn text-brand-gold text-2xl"></i></div>
                        <div class="w-full">
                            <div class="flex justify-between items-start">
                                <h3 id="displayBulletinTitle" class="font-bold text-xl text-brand-gold mb-2">...</h3>
                            </div>
                            <p id="displayBulletinContent" class="text-slate-100 text-sm leading-relaxed whitespace-pre-wrap opacity-90">...</p>
                            <div class="mt-4 text-[10px] text-blue-300 border-t border-blue-800 pt-2 flex justify-between">
                                <span><i class="fa-solid fa-user-tie mr-1"></i> ç®¡ç†è™•ç™¼å¸ƒ</span>
                                <span id="displayBulletinDate">--/--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1 glass-panel p-0 overflow-hidden flex flex-col h-auto lg:h-full border-t-4 border-green-500">
                    <div class="p-3 bg-slate-50 border-b border-slate-200 flex justify-between items-center shrink-0">
                        <h3 class="font-bold text-slate-700 text-sm"><i class="fa-solid fa-rss text-green-600 mr-2"></i> åœ˜éšŠå³æ™‚å‹•æ…‹</h3>
                        <span class="text-[10px] bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Approved</span>
                    </div>
                    <div class="flex-1 overflow-y-auto p-0 custom-scrollbar h-[200px] lg:h-auto" id="activityFeed">
                        <div class="p-4 text-center text-xs text-slate-400">ç›®å‰æ²’æœ‰å³å°‡ç™¼ç”Ÿçš„å‹•æ…‹</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="glass-panel p-6 border-l-4 border-blue-600 fade-in-up relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-blue-50 px-4 py-2 rounded-bl-xl border-b border-l border-blue-100 shadow-sm text-right">
                             <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">æ¨™æº–: 08:30 - 18:00</div>
                             <div class="text-xl font-black text-blue-700 font-mono" id="liveClock">00:00:00</div>
                             <div id="clockStatusBadge" class="text-[10px] font-bold text-slate-400 mt-1">æª¢æ¸¬ä¸­...</div>
                        </div>

                        <div class="flex justify-between items-center mb-8 mt-2">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2 text-lg">
                                <i class="fa-solid fa-location-dot text-blue-600"></i> å®šä½æ‰“å¡
                            </h3>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="handlePunch('ä¸Šç­')" class="btn-punch flex flex-col items-center justify-center p-4 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl shadow-lg shadow-blue-500/30 hover:shadow-xl">
                                <i class="fa-solid fa-sun text-2xl mb-2"></i><span class="font-bold">ä¸Šç­æ‰“å¡</span>
                                <span class="text-[10px] opacity-70 mt-1">é²åˆ°åŸºæº–: 08:30</span>
                            </button>
                            <button onclick="handlePunch('ä¸‹ç­')" class="btn-punch flex flex-col items-center justify-center p-4 bg-gradient-to-br from-orange-400 to-red-500 text-white rounded-xl shadow-lg shadow-orange-500/30 hover:shadow-xl">
                                <i class="fa-solid fa-moon text-2xl mb-2"></i><span class="font-bold">ä¸‹ç­æ‰“å¡</span>
                                <span class="text-[10px] opacity-70 mt-1">åŠ ç­èµ·å§‹: 18:00</span>
                            </button>
                        </div>
                    </div>

                    <div class="glass-panel p-6 border-t-4 border-brand-gold fade-in-up">
                        <div class="flex border-b border-gray-200 mb-4">
                            <button class="flex-1 py-2 text-center text-sm tab-active transition-colors" id="tab-leave" onclick="switchAppTab('leave')">è«‹å‡</button>
                            <button class="flex-1 py-2 text-center text-sm tab-inactive transition-colors" id="tab-car" onclick="switchAppTab('car')">å…¬å‹™è»Š</button>
                            <button class="flex-1 py-2 text-center text-sm tab-inactive transition-colors font-bold text-purple-600" id="tab-log" onclick="switchAppTab('log')">å·¥ä½œæ—¥èªŒ</button>
                        </div>

                        <form id="form-leave" onsubmit="handleLeaveSubmit(event)" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">å‡åˆ¥</label>
                                    <select id="leaveType" class="w-full p-2.5 input-modern" onchange="updateImpactInfo()">
                                        <option value="ç‰¹ä¼‘">ç‰¹ä¼‘ (å…¨è–ª)</option>
                                        <option value="ç—…å‡">ç—…å‡ (åŠè–ª)</option>
                                        <option value="äº‹å‡">äº‹å‡ (ç„¡è–ª)</option>
                                        <option value="è£œä¼‘">è£œä¼‘ (å…¨è–ª)</option>
                                        <option value="å©šå‡">å©šå‡ (å…¨è–ª)</option>
                                    </select>
                                </div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">æ—¥æœŸ</label><input type="date" id="leaveDate" class="w-full p-2.5 input-modern"></div>
                                <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 mb-1">å¤©æ•¸</label><input type="number" id="leaveDays" min="0.5" step="0.5" value="1" class="w-full p-2.5 input-modern" oninput="updateImpactInfo()"></div>
                                <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 mb-1">äº‹ç”±</label><input type="text" id="leaveReason" class="w-full p-2.5 input-modern" placeholder="ä¾‹ï¼šè™•ç†ç§äººäº‹å‹™"></div>
                            </div>
                            
                            <div id="impactCard" class="impact-card impact-full p-4 rounded-lg flex justify-between items-center mt-2">
                                <div>
                                    <div class="font-bold text-sm text-slate-700" id="impactTitle">å…¨è–ª</div>
                                    <div class="text-xs text-slate-500" id="impactDesc">å·¥è³‡ç…§çµ¦ï¼Œä¸æ‰£ç™¼è–ªè³‡ã€‚</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-slate-400">é ä¼°æ‰£è–ª</div>
                                    <div class="font-bold text-lg text-red-500">$<span id="impactAmount">0</span></div>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-[#06c755] hover:bg-[#05b34c] text-white font-bold py-3 rounded-lg shadow-lg transition flex justify-center items-center gap-2"><i class="fa-brands fa-line"></i> é€å‡ºä¸¦é€šçŸ¥ LINE ç¾¤çµ„</button>
                        </form>

                        <form id="form-car" onsubmit="handleCarSubmit(event)" class="space-y-4 hidden-section">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">é ç´„æ—¥æœŸ</label><input type="date" id="carDate" class="w-full p-2.5 input-modern"></div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">æ™‚é–“</label><input type="time" id="carTime" class="w-full p-2.5 input-modern"></div>
                                <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 mb-1">åœ°é» / ç”¨é€”</label><input type="text" id="carLocation" class="w-full p-2.5 input-modern" placeholder="ä¾‹ï¼šå‰å¾€å¸‚æ”¿åºœæ´½å…¬"></div>
                            </div>
                            <div class="bg-blue-50 text-blue-700 text-xs p-3 rounded">
                                <i class="fa-solid fa-circle-info mr-1"></i> å…¬å‹™è»Šéœ€ç¶“ç®¡ç†å“¡å¯©æ ¸ã€‚
                            </div>
                            <button type="submit" class="w-full bg-[#06c755] hover:bg-[#05b34c] text-white font-bold py-3 rounded-lg shadow-lg transition flex justify-center items-center gap-2"><i class="fa-brands fa-line"></i> é€å‡ºä¸¦é€šçŸ¥ LINE ç¾¤çµ„</button>
                        </form>

                        <form id="form-log" onsubmit="handleLogSubmit(event)" class="space-y-4 hidden-section">
                            <div class="flex justify-between items-end mb-2">
                                <div class="w-2/3">
                                    <label class="block text-xs font-bold text-slate-500 mb-1">åŒ¯å ±æ—¥æœŸ</label>
                                    <input type="date" id="logDate" class="w-full p-2 input-modern">
                                </div>
                                <button type="button" onclick="addNewTaskType()" class="text-xs bg-slate-800 text-white px-3 py-2 rounded hover:bg-slate-700 shadow"><i class="fa-solid fa-plus mr-1"></i> æ–°å¢é …ç›®</button>
                            </div>

                            <div class="space-y-2" id="logEntriesContainer">
                                <div class="text-center text-sm text-slate-400 py-4"><i class="fa-solid fa-spinner fa-spin"></i> è¼‰å…¥é¸é …ä¸­...</div>
                            </div>

                            <button type="submit" class="w-full bg-[#06c755] hover:bg-[#05b34c] text-white font-bold py-3 rounded-lg shadow-lg transition flex justify-center items-center gap-2 mt-4"><i class="fa-brands fa-line"></i> ç”¢ç”ŸåŒ¯å ±ä¸¦é€šçŸ¥ LINE</button>
                        </form>
                    </div>

                    <div class="glass-panel p-6 fade-in-up">
                        <h3 class="font-bold text-slate-700 mb-4 text-sm uppercase tracking-wider">æœ€è¿‘ç”³è«‹ç´€éŒ„</h3>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left"><tbody id="myRequestsTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                </div>

                <div class="space-y-6 lg:col-span-1">
                    <div class="glass-panel p-6 bg-slate-900 text-white fade-in-up">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold flex items-center gap-2"><i class="fa-solid fa-calculator text-brand-gold"></i> è–ªè³‡è©¦ç®—å„€è¡¨</h3></div>
                        
                        <div class="space-y-6">
                            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                                <label class="flex justify-between text-xs text-slate-400 mb-2">
                                    <span>è¨­å®šæœˆè–ª</span>
                                    <span class="text-brand-gold font-mono">$<span id="displaySalary">30,000</span></span>
                                </label>
                                <input type="range" id="salarySlider" min="27000" max="80000" step="500" value="30000" oninput="updateSalaryFromSlider(this.value)">
                                <input type="number" id="monthlySalary" value="30000" class="w-full bg-slate-900 border border-slate-600 rounded p-1 text-center text-white font-bold" oninput="updateSalaryFromInput(this.value)">
                            </div>

                            <div>
                                <div class="flex justify-between text-xs mb-1 text-slate-400"><span>å¹³æ—¥åŠ ç­ (å‰2hr)</span><span class="text-white font-bold"><span id="calcHours1Val">0</span> hr</span></div>
                                <input type="range" id="calcHours1" min="0" max="20" step="0.5" value="0" oninput="calculateOvertime()">
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1 text-slate-400"><span>å¹³æ—¥åŠ ç­ (ç¬¬3hrèµ·)</span><span class="text-white font-bold"><span id="calcHours2Val">0</span> hr</span></div>
                                <input type="range" id="calcHours2" min="0" max="20" step="0.5" value="0" oninput="calculateOvertime()">
                            </div>

                            <div class="mt-4 pt-4 border-t border-slate-700 space-y-2">
                                <div class="flex justify-between text-xs text-slate-400">
                                    <span>é ä¼°åŠ ç­è²» (+)</span>
                                    <span class="text-green-400 font-mono">$<span id="calcOtTotal">0</span></span>
                                </div>
                                <div class="flex justify-between text-xs text-slate-400">
                                    <span>è«‹å‡æ‰£è–ª (-)</span>
                                    <span class="text-red-400 font-mono">$<span id="calcDeduction">0</span></span>
                                </div>
                                <div class="flex justify-between items-end mt-2 pt-2 border-t border-slate-700/50">
                                    <span class="text-sm font-bold text-white">é ä¼°å¯¦é ˜</span>
                                    <div class="text-2xl font-black text-brand-gold font-mono">$<span id="calcFinalTotal">0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass-panel p-6 flex flex-col items-center text-center fade-in-up relative group">
                        <div class="absolute top-3 right-3 text-slate-300 hover:text-blue-500 cursor-pointer" onclick="toggleLegalInfo()" title="æŸ¥çœ‹å‹åŸºæ³•è¦å®š">
                            <i class="fa-solid fa-scale-balanced"></i>
                        </div>

                        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center text-2xl mb-2"><span id="dashboardAvatar">ğŸ‘¤</span></div>
                        <h2 id="dashboardName" class="text-xl font-bold text-slate-800">...</h2>
                        
                        <div class="flex flex-col items-center gap-1 mt-1">
                            <div class="text-xs font-mono text-slate-500 bg-slate-100 px-2 py-0.5 rounded border border-slate-200">
                                <i class="fa-regular fa-calendar-check mr-1"></i> å…¥è·ï¼š<span id="dashboardJoinDate">--</span>
                            </div>
                            <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-[10px] font-bold">
                                <i class="fa-solid fa-check-circle"></i> è£ç½®å·²é–å®š
                            </span>
                        </div>

                        <div class="mt-4 w-full grid grid-cols-2 gap-2 text-center">
                            <div class="bg-blue-50 p-2 rounded relative">
                                <div class="absolute -top-2 -left-1 bg-amber-400 text-white text-[9px] px-1 rounded shadow">é€±å¹´åˆ¶</div>
                                <div class="text-[10px] text-slate-400 uppercase mt-1">ç‰¹ä¼‘é¡åº¦ (ä¾å‹åŸºæ³•)</div>
                                <div class="font-bold text-blue-800" id="dashboardTotal">--</div>
                                <div class="lsa-badge" id="dashboardRule">è¨ˆç®—ä¸­...</div>
                            </div>
                            <div class="bg-green-50 p-2 rounded">
                                <div class="text-[10px] text-slate-400 uppercase mt-1">ç‰¹ä¼‘å‰©é¤˜</div>
                                <div class="font-bold text-green-600" id="dashboardRemaining">--</div>
                            </div>
                        </div>
                        <div class="mt-2 text-[10px] text-slate-400">
                             â€» æ¡ã€Œé€±å¹´åˆ¶ã€ï¼šæ–¼å€‹äººåˆ°è·æ—¥æ»¿é€±å¹´æ™‚è‡ªå‹•é‡ç½®é¡åº¦ã€‚
                        </div>
                        <div class="mt-2 text-xs text-slate-500">
                            è£œä¼‘é¤˜é¡: <span class="font-bold text-orange-600" id="dashboardComp">0</span> å¤©
                        </div>

                        <div id="legalInfoCard" class="hidden absolute inset-0 bg-white/95 backdrop-blur z-20 rounded-xl p-4 flex flex-col justify-center text-left border border-blue-200">
                            <h4 class="font-bold text-blue-800 mb-2 border-b pb-1">ğŸ“œ å‹åŸºæ³•ç¬¬38æ¢ (ç‰¹ä¼‘)</h4>
                            <ul class="text-xs space-y-1 text-slate-600 list-disc pl-4">
                                <li>6å€‹æœˆä»¥ä¸Š1å¹´æœªæ»¿ï¼š3æ—¥</li>
                                <li>1å¹´ä»¥ä¸Š2å¹´æœªæ»¿ï¼š7æ—¥</li>
                                <li>2å¹´ä»¥ä¸Š3å¹´æœªæ»¿ï¼š10æ—¥</li>
                                <li>3å¹´ä»¥ä¸Š5å¹´æœªæ»¿ï¼š14æ—¥</li>
                                <li>5å¹´ä»¥ä¸Š10å¹´æœªæ»¿ï¼š15æ—¥</li>
                                <li>10å¹´ä»¥ä¸Šï¼šæ¯ä¸€å¹´åŠ çµ¦1æ—¥ï¼Œä¸Šé™30æ—¥</li>
                            </ul>
                            <div class="mt-2 text-[10px] text-red-500">* æœ¬ç³»çµ±æ¡ã€Œé€±å¹´åˆ¶ã€ï¼Œæ–¼åˆ°è·æ—¥çµç®—ã€‚</div>
                            <button onclick="toggleLegalInfo()" class="mt-4 w-full bg-slate-100 text-slate-500 text-xs py-1 rounded hover:bg-slate-200">é—œé–‰èªªæ˜</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="adminView" class="hidden-section w-full fade-in-up">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 glass-panel p-6 border-t-4 border-blue-600">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-clipboard-check text-blue-600"></i> ç”³è«‹å¯©æ ¸ä¸­å¿ƒ 
                        <span id="pendingCountBadge" class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                    </h2>
                    <div class="overflow-x-auto"><table class="w-full text-left text-sm"><tbody id="approvalTableBody" class="divide-y divide-slate-100"></tbody></table></div>
                    <div id="noPendingMsg" class="text-center py-8 text-slate-400"><i class="fa-regular fa-circle-check text-4xl mb-2 text-slate-200"></i><p>ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„ç”³è«‹</p></div>
                </div>

                <div class="lg:col-span-1 glass-panel p-6 border-t-4 border-brand-gold">
                    <h2 class="text-lg font-bold text-slate-800 mb-4"><i class="fa-solid fa-bullhorn text-brand-gold mr-2"></i> ç½®é ‚å…¬å‘Šç®¡ç†</h2>
                    <input type="text" id="adminBulletinTitle" class="w-full p-2 mb-2 input-modern" placeholder="æ¨™é¡Œ">
                    <textarea id="adminBulletinContent" rows="4" class="w-full p-2 mb-2 input-modern" placeholder="å…§å®¹"></textarea>
                    <button onclick="saveBulletin()" class="w-full bg-slate-800 text-white p-2 rounded font-bold hover:bg-slate-700">æ›´æ–°ç½®é ‚ç™¼å¸ƒ</button>
                    <div class="mt-4 text-xs text-slate-400 p-2 bg-slate-50 rounded">
                        <i class="fa-solid fa-info-circle mr-1"></i> è«‹å‡/ç”¨è»Šè³‡è¨Šå°‡è‡ªå‹•é¡¯ç¤ºæ–¼ã€Œå‹•æ…‹ç‰†ã€ï¼Œç„¡éœ€åœ¨æ­¤ç™¼å¸ƒã€‚
                    </div>
                </div>

                <div class="lg:col-span-3 glass-panel p-6 border-t-4 border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-clock-rotate-left text-slate-700"></i> è€ƒå‹¤èˆ‡å ±è¡¨ä¸­å¿ƒ</h2>
                        <div class="flex gap-2">
                            <button onclick="exportLeaveRequests()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-2 rounded shadow flex items-center gap-1">
                                <i class="fa-solid fa-file-invoice"></i> åŒ¯å‡ºè«‹å‡æ˜ç´°(å«è¨»è¨˜)
                            </button>
                            <button onclick="exportAttendance()" class="bg-green-600 hover:bg-green-500 text-white text-xs px-3 py-2 rounded shadow flex items-center gap-1">
                                <i class="fa-solid fa-file-excel"></i> åŒ¯å‡ºæ‰“å¡ç´€éŒ„
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-60 overflow-y-auto custom-scrollbar">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-100 text-slate-500 text-xs">
                                <tr>
                                    <th class="p-2">å§“å</th>
                                    <th class="p-2">é¡å‹</th>
                                    <th class="p-2">æ™‚é–“</th>
                                    <th class="p-2">ç‹€æ…‹</th>
                                    <th class="p-2">å®šä½</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody" class="divide-y divide-slate-100 text-xs"></tbody>
                        </table>
                    </div>
                </div>

                <div class="lg:col-span-3 glass-panel p-6">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-users mr-1"></i> å“¡å·¥å…¨æ–¹ä½ç®¡ç† 
                        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded ml-2 font-normal">
                            <i class="fa-solid fa-scale-balanced mr-1"></i> ç¬¦åˆå‹åŸºæ³•é€±å¹´åˆ¶
                        </span>
                    </h2>
                    
                    <div class="flex flex-wrap gap-2 mb-4 bg-slate-50 p-3 rounded-lg border border-slate-200">
                        <input type="text" id="newAdminName" placeholder="æ–°é€²å“¡å·¥å§“å" class="flex-1 min-w-[120px] p-2 input-modern">
                        <select id="newAdminGender" class="w-20 p-2 input-modern"><option value="M">ç”·</option><option value="F">å¥³</option></select>
                        <div class="flex items-center gap-1">
                            <span class="text-xs text-slate-500">åˆ°è·:</span>
                            <input type="date" id="newAdminDate" class="w-36 p-2 input-modern">
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="text-xs text-slate-500">ç”Ÿæ—¥:</span>
                            <input type="date" id="newAdminBirthday" class="w-36 p-2 input-modern">
                        </div>
                        <button onclick="addEmployee()" class="bg-blue-600 text-white px-4 rounded font-bold hover:bg-blue-500">æ–°å¢</button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-100 text-slate-600 text-xs uppercase">
                                <tr>
                                    <th class="p-3">å§“å (å¯æ”¹)</th>
                                    <th class="p-3">è³‡æ–™ (åˆ°è·/ç”Ÿæ—¥)</th>
                                    <th class="p-3">ç‰¹ä¼‘æ¦‚æ³ (ç¸½/ç”¨/å‰©)</th>
                                    <th class="p-3 w-1/4">è£ç½®</th>
                                    <th class="p-3 text-right">ç®¡ç†</th>
                                </tr>
                            </thead>
                            <tbody id="adminTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <div id="historyModal" class="modal-overlay">
            <div class="modal-content">
                <div class="p-4 border-b bg-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800 text-lg"><i class="fa-solid fa-sliders mr-2"></i> å‡å‹¤æ•¸æ“šä¸­æ§å° - <span id="modalEmpName"></span></h3>
                    <button onclick="closeHistory()" class="text-slate-500 hover:text-red-500 text-xl"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-6 overflow-y-auto flex-1 bg-slate-50">
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg border border-blue-200 shadow-sm relative overflow-hidden">
                            <div class="absolute top-0 right-0 bg-blue-100 text-blue-800 text-[10px] px-2 py-1 font-bold">ç‰¹ä¼‘ (Annual)</div>
                            <div class="mt-2 space-y-2">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-slate-500">å·²ä½¿ç”¨å¤©æ•¸</span>
                                    <input type="number" id="adjAnnualUsed" class="border rounded w-16 text-center font-bold text-blue-700" step="0.5">
                                </div>
                                <div class="text-xs text-slate-400 text-right">ç³»çµ±è‡ªå‹•ç´¯è¨ˆ</div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg border border-orange-200 shadow-sm relative overflow-hidden">
                            <div class="absolute top-0 right-0 bg-orange-100 text-orange-800 text-[10px] px-2 py-1 font-bold">è£œä¼‘ (Comp)</div>
                            <div class="mt-2 space-y-2">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-slate-500">ç›®å‰é¤˜é¡</span>
                                    <input type="number" id="adjCompBalance" class="border rounded w-16 text-center font-bold text-orange-700" step="0.5">
                                </div>
                                <div class="text-xs text-slate-400 text-right">ç®¡ç†è€…æ‰‹å‹•ç™¼æ”¾</div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm relative overflow-hidden">
                            <div class="absolute top-0 right-0 bg-gray-100 text-gray-800 text-[10px] px-2 py-1 font-bold">ç—…/äº‹å‡</div>
                            <div class="mt-2 space-y-1">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-slate-500">ç—…å‡å·²ç”¨</span>
                                    <input type="number" id="adjSickUsed" class="border rounded w-16 text-center font-bold text-gray-700" step="0.5">
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-slate-500">äº‹å‡å·²ç”¨</span>
                                    <input type="number" id="adjPersonalUsed" class="border rounded w-16 text-center font-bold text-gray-700" step="0.5">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="saveAllAdjustments()" class="w-full bg-slate-800 text-white py-2 rounded mb-6 font-bold hover:bg-slate-700 shadow-md">
                        <i class="fa-solid fa-save mr-1"></i> å„²å­˜æ‰€æœ‰ä¿®æ­£
                    </button>

                    <h4 class="font-bold text-slate-700 mb-2">ğŸ“œ æ­·å²ç”³è«‹ç´€éŒ„ (ç‰¹ä¼‘æœƒç‰¹åˆ¥æ¨™ç¤º)</h4>
                    <div class="overflow-x-auto bg-white rounded-lg border border-slate-200">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100 text-xs text-slate-500 uppercase">
                                <tr>
                                    <th class="p-2">æ—¥æœŸ</th>
                                    <th class="p-2">é¡å‹</th>
                                    <th class="p-2">å…§å®¹</th>
                                    <th class="p-2">ç‹€æ…‹</th>
                                    <th class="p-2">æ—¥æ›†</th>
                                    <th class="p-2">è¨»è¨˜</th>
                                    <th class="p-2 text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCcSH0HQutt6rYcFWjCKOpTSWkBDeinyvw",
            authDomain: "homego-system.firebaseapp.com",
            databaseURL: "https://homego-system-default-rtdb.firebaseio.com",
            projectId: "homego-system",
            storageBucket: "homego-system.firebasestorage.app",
            messagingSenderId: "679007509034",
            appId: "1:679007509034:web:df50010c5ab8cd7f964153"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const ADMIN_PASSWORD = "8888";

        let employees = {};
        let requests = {};
        let attendance = {};
        let taskOptions = []; // Store global task options
        let bulletin = { title: "æ­¡è¿", content: "è³‡æ–™è®€å–ä¸­...", date: "" };
        let currentUserId = null;
        let currentDeduction = 0;
        let currentModalEmpId = null;

        // Default tasks if none in DB
        const DEFAULT_TASKS = ["åœ°æ”¿éæˆ¶", "è²¸æ¬¾", "çµæ¡ˆè³‡æ–™æ•´ç†", "éæ°´é›»", "ç”¨å°", "å°ä¿", "å¡—éŠ·"];

        // --- Device Fingerprint ---
        let myDeviceId = localStorage.getItem('hge_security_did');
        if (!myDeviceId) {
            myDeviceId = 'DID-' + Math.random().toString(36).substr(2, 6).toUpperCase() + '-' + Date.now().toString(36).substr(-4);
            localStorage.setItem('hge_security_did', myDeviceId);
        }
        document.getElementById('myDeviceIdDisplay').innerText = myDeviceId;

        // --- Clock & Smart Notification Logic ---
        const WORK_START = "08:30";
        const WORK_END = "18:00";

        function updateClockStatus() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW', {hour12: false});
            document.getElementById('liveClock').innerText = timeStr;

            // Simple comparison logic
            const timeVal = now.getHours() * 60 + now.getMinutes();
            const startVal = 8 * 60 + 30; // 08:30 = 510
            const endVal = 18 * 60;       // 18:00 = 1080

            const badge = document.getElementById('clockStatusBadge');
            
            // Logic for visual feedback
            if (timeVal < startVal) {
                badge.className = "text-[10px] font-bold text-green-600 mt-1";
                badge.innerText = "æ—©å®‰ï¼æº–æ™‚æ‰“å¡";
            } else if (timeVal >= startVal && timeVal < endVal) {
                // Working hours
                badge.className = "text-[10px] font-bold text-orange-600 mt-1";
                badge.innerText = "ä¸Šç­æ™‚é–“ (é²åˆ°åˆ¤å®šä¸­)";
            } else {
                badge.className = "text-[10px] font-bold text-purple-600 mt-1";
                badge.innerText = "ä¸‹ç­æ™‚é–“ (åŠ ç­åˆ¤å®šä¸­)";
            }
        }

        setInterval(updateClockStatus, 1000);

        // --- Legal Info Toggle ---
        window.toggleLegalInfo = () => {
            const card = document.getElementById('legalInfoCard');
            if(card.classList.contains('hidden')) {
                card.classList.remove('hidden');
                card.classList.add('flex');
            } else {
                card.classList.add('hidden');
                card.classList.remove('flex');
            }
        };

        // --- UI ---
        window.switchView = (view) => {
            document.getElementById('employeeView').classList.add('hidden-section');
            document.getElementById('adminView').classList.add('hidden-section');
            document.getElementById('loginSection').classList.add('hidden-section');
            const btnEmp = document.getElementById('btnEmp');
            const btnAdm = document.getElementById('btnAdm');

            if (view === 'employee') {
                document.getElementById('loginSection').classList.remove('hidden-section');
                currentUserId = null;
                updateEmpSelect();
                btnEmp.className = "px-4 py-1.5 rounded-full text-xs md:text-sm font-medium transition-all bg-white text-blue-900 shadow-sm";
                btnAdm.className = "px-4 py-1.5 rounded-full text-xs md:text-sm font-medium text-blue-200 hover:text-white transition-all";
            } else {
                document.getElementById('adminView').classList.remove('hidden-section');
                btnAdm.className = "px-4 py-1.5 rounded-full text-xs md:text-sm font-medium transition-all bg-white text-blue-900 shadow-sm";
                btnEmp.className = "px-4 py-1.5 rounded-full text-xs md:text-sm font-medium text-blue-200 hover:text-white transition-all";
            }
        };

        window.checkAdminLogin = () => {
            let pass = prompt("ğŸ” è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
            if (pass === ADMIN_PASSWORD) window.switchView('admin');
            else if (pass !== null) alert("ğŸš« å¯†ç¢¼éŒ¯èª¤");
        };

        window.switchAppTab = (tab) => {
            // Reset all tabs
            document.getElementById('tab-leave').className = 'flex-1 py-2 text-center text-sm tab-inactive transition-colors';
            document.getElementById('tab-car').className = 'flex-1 py-2 text-center text-sm tab-inactive transition-colors';
            document.getElementById('tab-log').className = 'flex-1 py-2 text-center text-sm tab-inactive transition-colors';
            
            // Activate selected
            const activeClass = 'flex-1 py-2 text-center text-sm tab-active transition-colors';
            if(tab === 'log') document.getElementById('tab-log').className = activeClass + ' font-bold text-purple-600';
            else document.getElementById('tab-' + tab).className = activeClass;

            // Hide/Show forms
            document.getElementById('form-leave').classList.add('hidden-section');
            document.getElementById('form-car').classList.add('hidden-section');
            document.getElementById('form-log').classList.add('hidden-section');
            document.getElementById(`form-${tab}`).classList.remove('hidden-section');
        };

        // --- Firebase ---
        onValue(ref(db), (snapshot) => {
            const data = snapshot.val() || {};
            employees = data.employees || {};
            requests = data.requests || {};
            attendance = data.attendance || {};
            bulletin = data.bulletin || { title: "å°šç„¡å…¬å‘Š", content: "", date: "" };
            
            // Sync Task Options
            const dbTasks = data.settings?.taskTypes || [];
            if (dbTasks.length === 0) {
                 set(ref(db, 'settings/taskTypes'), DEFAULT_TASKS);
                 taskOptions = DEFAULT_TASKS;
            } else {
                 taskOptions = dbTasks;
            }
            renderLogForm(); 
            
            // Check for Birthdays and Auto-Publish (if not done today)
            checkBirthdayEvents();

            updateEmpSelect();
            renderBulletin();
            renderActivityFeed();
            
            // Update dashboard real-time if logged in
            if (currentUserId) {
                 const emp = employees[currentUserId];
                 if(emp) {
                    const calc = calculateLeave(emp.joinDate);
                    const used = emp.stats?.annual || emp.usedLeave || 0; 
                    const comp = emp.stats?.comp || 0;
                    document.getElementById('dashboardRemaining').innerText = (calc.days - used) + " å¤©";
                    document.getElementById('dashboardTotal').innerText = calc.days + " å¤©";
                    document.getElementById('dashboardRule').innerText = calc.rule; // LSA Rule
                    document.getElementById('dashboardComp').innerText = comp;
                    document.getElementById('dashboardJoinDate').innerText = emp.joinDate;
                 }
            }
            renderAdminTable();
            renderApprovalQueue();
            renderAttendanceLog();
            
            const select = document.getElementById('empSelect');
            select.disabled = false;
        });

        // --- Birthday Auto-Notice Logic ---
        function checkBirthdayEvents() {
            const today = new Date();
            // Format today as MM-DD
            const todayStr = (today.getMonth() + 1).toString().padStart(2, '0') + '-' + today.getDate().toString().padStart(2, '0');
            
            let birthdayBoys = [];

            Object.values(employees).forEach(emp => {
                if(emp.birthday && emp.birthday.slice(5) === todayStr) {
                    birthdayBoys.push(emp.name);
                }
            });

            if(birthdayBoys.length > 0) {
                const title = "ğŸ‚ ç”Ÿæ—¥å¿«æ¨‚ï¼";
                // Only update DB if the bulletin date is NOT today (means it hasn't been updated for today's news yet)
                // This prevents overwriting if admin manually changed it back later today
                const todayFullStr = today.toLocaleDateString();

                if(bulletin.date !== todayFullStr) {
                     const names = birthdayBoys.join(' & ');
                     const content = `ä»Šå¤©æ˜¯ ${names} çš„ç”Ÿæ—¥ï¼\nç¥ç¦å·¥ä½œé †åˆ©ï¼Œèº«é«”å¥åº·ï¼\nå¤§å®¶åˆ¥å¿˜äº†é€ä¸Šç¥ç¦å”·ï½ ğŸ‰`;
                     
                     // Auto-publish to Firebase
                     set(ref(db, 'bulletin'), {
                        title: title,
                        content: content,
                        date: todayFullStr
                     });
                }
            }
        }

        // --- Work Log Logic ---
        function renderLogForm() {
            const container = document.getElementById('logEntriesContainer');
            if(!container) return;
            
            if (container.children.length > 1 && container.querySelector('select')) {
                const selects = container.querySelectorAll('select');
                selects.forEach(sel => {
                    const currentVal = sel.value;
                    sel.innerHTML = '<option value="">-- é¸æ“‡é …ç›® --</option>';
                    taskOptions.forEach(opt => {
                        sel.innerHTML += `<option value="${opt}">${opt}</option>`;
                    });
                    sel.value = currentVal;
                });
                return;
            }

            container.innerHTML = '';
            const timeSlots = [
                "09:00 ~ 10:00", "10:00 ~ 11:00", "11:00 ~ 12:00",
                "13:30 ~ 14:30", "14:30 ~ 15:30", "15:30 ~ 16:30", 
                "16:30 ~ 17:30", "17:30 ~ 18:30"
            ];

            timeSlots.forEach((slot, index) => {
                let optionsHtml = '<option value="">-- é¸æ“‡é …ç›® --</option>';
                taskOptions.forEach(opt => optionsHtml += `<option value="${opt}">${opt}</option>`);

                container.innerHTML += `
                    <div class="bg-white p-2 rounded border border-slate-200 flex flex-col md:flex-row gap-2 items-center shadow-sm">
                        <div class="text-xs font-bold text-slate-500 w-full md:w-24 bg-slate-50 p-1.5 rounded text-center">${slot}</div>
                        <select name="logTask" class="flex-1 p-1.5 text-sm border rounded w-full md:w-auto outline-none focus:border-blue-500">
                            ${optionsHtml}
                        </select>
                        <input type="text" name="logDetail" class="flex-1 p-1.5 text-sm border rounded w-full md:w-auto outline-none focus:border-blue-500" placeholder="æ¡ˆä»¶æ—¥æœŸ / å®¢æˆ¶åç¨±">
                        <input type="hidden" name="logTime" value="${slot}">
                    </div>
                `;
            });
        }

        window.addNewTaskType = async () => {
            const { value: newTask } = await Swal.fire({
                title: 'æ–°å¢å·¥ä½œé …ç›®',
                text: 'æ­¤é …ç›®å°‡åŒæ­¥é¡¯ç¤ºçµ¦æ‰€æœ‰åŒä»',
                input: 'text',
                inputPlaceholder: 'ä¾‹å¦‚ï¼šç¨…å‹™ç”³å ±',
                showCancelButton: true,
                confirmButtonColor: '#1e3a8a'
            });

            if (newTask) {
                if (taskOptions.includes(newTask)) return Swal.fire('å·²å­˜åœ¨', 'æ­¤é …ç›®å·²åœ¨åˆ—è¡¨ä¸­', 'warning');
                const newOptions = [...taskOptions, newTask];
                await set(ref(db, 'settings/taskTypes'), newOptions);
                Swal.fire('æˆåŠŸ', 'æ–°é …ç›®å·²åŒæ­¥è‡³å…¨é«”åŒä»', 'success');
            }
        };

        window.handleLogSubmit = (e) => {
            e.preventDefault();
            if (!currentUserId) return;
            const emp = employees[currentUserId];
            const date = document.getElementById('logDate').value;
            
            const entries = [];
            const rows = document.querySelectorAll('#logEntriesContainer > div');
            
            rows.forEach(row => {
                const time = row.querySelector('[name="logTime"]').value;
                const task = row.querySelector('[name="logTask"]').value;
                const detail = row.querySelector('[name="logDetail"]').value.trim();
                
                if (task) {
                    entries.push(`${time} ã€${task}ã€‘ ${detail}`);
                }
            });

            if (entries.length === 0) return Swal.fire('å…§å®¹ç©ºç™½', 'è«‹è‡³å°‘å¡«å¯«ä¸€å€‹æ™‚æ®µçš„å·¥ä½œå…§å®¹', 'warning');

            let msg = `ã€å·¥ä½œæ—¥èªŒã€‘${emp.name}\nğŸ“… æ—¥æœŸï¼š${date}\n------------------\n`;
            msg += entries.join('\n');
            msg += `\n------------------\n(Nexus V5.11 ç”Ÿæˆ)`;

            window.open('https://line.me/R/msg/text/?' + encodeURIComponent(msg));
        };

        // --- Google Calendar Helper ---
        window.getGoogleCalendarUrl = (reqId) => {
            const req = requests[reqId];
            if(!req) return '#';
            
            let title = "", details = "", start = "", end = "";
            
            if(req.category === 'car') {
                title = `å…¬å‹™è»Š: ${req.empName}`;
                details = `ç”¨é€”: ${req.location}`;
                start = `${req.date}T${req.time}:00`;
                let d = new Date(`${req.date}T${req.time}:00`);
                d.setHours(d.getHours() + 2);
                end = d.toISOString().replace(/-|:|\.\d\d\d/g,"").slice(0,15);
                start = start.replace(/-|:/g,"");
            } else {
                title = `${req.empName} - ${req.type}`;
                details = `äº‹ç”±: ${req.reason}`;
                start = req.date.replace(/-|:/g,"");
                end = start;
            }

            return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${start}/${end}&details=${encodeURIComponent(details)}&location=${encodeURIComponent('å…¬å¸')}`;
        };

        // --- Auth Logic ---
        function updateEmpSelect() {
            const select = document.getElementById('empSelect');
            select.innerHTML = '';
            let boundUser = null;
            Object.values(employees).forEach(emp => {
                if (emp.devices && emp.devices.includes(myDeviceId)) boundUser = emp;
            });

            if (boundUser) {
                const option = document.createElement('option');
                option.value = boundUser.id;
                option.innerText = `ğŸ”’ å·²ç¶å®šèº«åˆ†ï¼š${boundUser.name}`;
                select.appendChild(option);
                select.value = boundUser.id;
                if (!document.getElementById('loginSection').classList.contains('hidden-section')) {
                     document.getElementById('loginStatusMsg').classList.remove('hidden');
                     setTimeout(() => loadEmployeeDashboard(boundUser.id), 800);
                }
            } else {
                const defaultOpt = document.createElement('option');
                defaultOpt.value = "";
                defaultOpt.innerText = "-- è«‹é¸æ“‡æ‚¨çš„å§“å (é¦–æ¬¡éœ€ç¶å®š) --";
                select.appendChild(defaultOpt);
                Object.values(employees).forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.innerText = emp.name;
                    select.appendChild(option);
                });
            }
        }

        window.tryBindAndLogin = () => {
            const id = document.getElementById('empSelect').value;
            if (!id) return;
            const emp = employees[id];
            const currentDevices = emp.devices || [];

            if (currentDevices.includes(myDeviceId)) { loadEmployeeDashboard(id); return; }
            if (currentDevices.length >= 2) {
                Swal.fire({ icon: 'error', title: 'ç¶å®šå¤±æ•—', text: 'æ‚¨çš„å¸³è™Ÿå·²ç¶å®š 2 å°è£ç½®ã€‚è«‹è¯ç¹«ç®¡ç†å“¡è§£ç¶èˆŠè£ç½®ã€‚' });
                document.getElementById('empSelect').value = "";
                return;
            }

            Swal.fire({
                title: 'è£ç½®ç¶å®šç¢ºèª',
                html: `å³å°‡ç¶å®šæ­¤è£ç½®ç‚º <b>${emp.name}</b> çš„å°ˆç”¨è¨­å‚™ã€‚<br>ç¶å®šå¾Œç„¡æ³•åˆ‡æ›ç‚ºå…¶ä»–äººå“¡ã€‚<br><br>ç›®å‰å·²ç”¨é¡åº¦: ${currentDevices.length}/2`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#1e3a8a',
                confirmButtonText: 'ç¢ºèªç¶å®š'
            }).then((result) => {
                if (result.isConfirmed) {
                    const newDevices = [...currentDevices, myDeviceId];
                    update(ref(db, `employees/${id}`), { devices: newDevices }).then(() => {
                        Swal.fire('æˆåŠŸ', 'è£ç½®å·²ç¶å®š', 'success');
                        loadEmployeeDashboard(id);
                    });
                } else {
                    document.getElementById('empSelect').value = "";
                }
            });
        };

        window.loadEmployeeDashboard = (forcedId) => {
            const id = forcedId || document.getElementById('empSelect').value;
            if (!id) return;
            currentUserId = id;
            const emp = employees[id];
            
            if (emp) {
                const calc = calculateLeave(emp.joinDate);
                const used = emp.stats?.annual || emp.usedLeave || 0;
                const comp = emp.stats?.comp || 0;

                document.getElementById('dashboardName').innerText = emp.name;
                document.getElementById('dashboardAvatar').innerText = emp.gender === 'F' ? 'ğŸ‘©â€ğŸ’¼' : 'ğŸ‘¨â€ğŸ’¼';
                document.getElementById('dashboardTotal').innerText = calc.days + " å¤©";
                document.getElementById('dashboardRemaining').innerText = (calc.days - used) + " å¤©";
                document.getElementById('dashboardRule').innerText = calc.rule; // LSA Rule
                document.getElementById('dashboardComp').innerText = comp;
                document.getElementById('dashboardJoinDate').innerText = emp.joinDate;
                
                document.getElementById('loginSection').classList.add('hidden-section');
                document.getElementById('loginStatusMsg').classList.add('hidden');
                document.getElementById('employeeView').classList.remove('hidden-section');
                
                window.calculateOvertime();
                window.updateImpactInfo();
            }
        };

        window.handlePunch = (type) => {
            if (!currentUserId) return;
            const emp = employees[currentUserId];
            if (!emp.devices || !emp.devices.includes(myDeviceId)) return Swal.fire('å®‰å…¨è­¦å‘Š', 'æ­¤è£ç½®æœªç¶“æˆæ¬Š', 'error');
            if (!navigator.geolocation) return Swal.fire('éŒ¯èª¤', 'ä¸æ”¯æ´å®šä½', 'error');
            
            navigator.geolocation.getCurrentPosition((position) => {
                const now = new Date();
                
                // Attendance Logic (08:30 - 18:00)
                let status = "æ­£å¸¸";
                const nowMinutes = now.getHours() * 60 + now.getMinutes();
                const startLimit = 8 * 60 + 30; // 510
                const endLimit = 18 * 60;       // 1080

                if (type === 'ä¸Šç­' && nowMinutes > startLimit) status = "é²åˆ°";
                if (type === 'ä¸‹ç­' && nowMinutes > endLimit) status = "åŠ ç­";

                push(ref(db, 'attendance'), {
                    empId: currentUserId, empName: emp.name, type: type, timestamp: now.getTime(),
                    dateStr: now.toLocaleDateString(), timeStr: now.toLocaleTimeString(),
                    location: `${position.coords.latitude}, ${position.coords.longitude}`,
                    mapLink: `http://maps.google.com/?q=${position.coords.latitude},${position.coords.longitude}`,
                    deviceId: myDeviceId,
                    status: status // Added status
                });
                
                // Notification Alert (Visual)
                let alertTitle = 'æ‰“å¡æˆåŠŸ';
                let alertIcon = 'success';
                let alertText = `${type} @ ${now.toLocaleTimeString()}`;

                if (status === 'é²åˆ°') {
                    alertTitle = 'æ‰“å¡æˆåŠŸ (é²åˆ°)';
                    alertIcon = 'warning';
                    alertText += '\nå·²è¨˜éŒ„é²åˆ°ç‹€æ…‹';
                } else if (status === 'åŠ ç­') {
                    alertTitle = 'æ‰“å¡æˆåŠŸ (åŠ ç­)';
                    alertIcon = 'info';
                    alertText += '\nè¾›è‹¦äº†ï¼å·²è¨˜éŒ„åŠ ç­ç‹€æ…‹';
                }

                Swal.fire(alertTitle, alertText, alertIcon);
            });
        };

        // --- Salary ---
        window.updateSalaryFromSlider = (val) => {
            document.getElementById('monthlySalary').value = val;
            document.getElementById('displaySalary').innerText = parseInt(val).toLocaleString();
            calculateOvertime(); updateImpactInfo();
        };
        window.updateSalaryFromInput = (val) => {
            document.getElementById('salarySlider').value = val;
            document.getElementById('displaySalary').innerText = parseInt(val).toLocaleString();
            calculateOvertime(); updateImpactInfo();
        };

        window.calculateOvertime = () => {
            const salary = parseInt(document.getElementById('monthlySalary').value) || 0;
            const hourlyRate = Math.round(salary / 240);
            const h1 = parseFloat(document.getElementById('calcHours1').value);
            const h2 = parseFloat(document.getElementById('calcHours2').value);
            document.getElementById('calcHours1Val').innerText = h1;
            document.getElementById('calcHours2Val').innerText = h2;
            const otTotal = Math.round((h1 * hourlyRate * 1.34) + (h2 * hourlyRate * 1.67));
            document.getElementById('calcOtTotal').innerText = otTotal.toLocaleString();
            const final = salary + otTotal - currentDeduction;
            document.getElementById('calcDeduction').innerText = currentDeduction.toLocaleString();
            document.getElementById('calcFinalTotal').innerText = final.toLocaleString();
        };

        window.updateImpactInfo = () => {
            const type = document.getElementById('leaveType').value;
            const days = parseFloat(document.getElementById('leaveDays').value) || 0;
            const salary = parseInt(document.getElementById('monthlySalary').value) || 30000;
            const dailyRate = Math.round(salary / 30);
            const card = document.getElementById('impactCard');
            const title = document.getElementById('impactTitle');
            const desc = document.getElementById('impactDesc');
            
            card.classList.remove('impact-full', 'impact-half', 'impact-none');
            let deduction = 0;

            if (['ç‰¹ä¼‘','è£œä¼‘','å©šå‡'].includes(type)) {
                card.classList.add('impact-full'); title.innerText = "å…¨è–ª"; desc.innerText = "å·¥è³‡ç…§çµ¦";
            } else if (['ç—…å‡'].includes(type)) {
                card.classList.add('impact-half'); title.innerText = "åŠè–ª"; desc.innerText = "å·¥è³‡æŠ˜åŠ";
                deduction = Math.round(dailyRate * days * 0.5);
            } else {
                card.classList.add('impact-none'); title.innerText = "ç„¡è–ª"; desc.innerText = "ä¸çµ¦ä»˜å·¥è³‡";
                deduction = Math.round(dailyRate * days);
            }
            
            document.getElementById('impactAmount').innerText = deduction.toLocaleString();
            currentDeduction = deduction;
            window.calculateOvertime();
        };

        // --- Submissions ---
        window.handleLeaveSubmit = (e) => {
            e.preventDefault();
            if (!currentUserId) return;
            const emp = employees[currentUserId];
            const type = document.getElementById('leaveType').value;
            const days = parseFloat(document.getElementById('leaveDays').value);
            
            // Check Balances
            if (type === 'è£œä¼‘') {
                const balance = emp.stats?.comp || 0;
                if (balance < days) return Swal.fire('é¤˜é¡ä¸è¶³', `è£œä¼‘å‰©é¤˜ ${balance} å¤©ï¼Œç„¡æ³•ç”³è«‹ ${days} å¤©`, 'error');
            }
            if (type === 'ç‰¹ä¼‘') {
                const calc = calculateLeave(emp.joinDate);
                const used = emp.stats?.annual || emp.usedLeave || 0;
                const remaining = calc.days - used;
                if (remaining < days) return Swal.fire('é¤˜é¡ä¸è¶³', `ç‰¹ä¼‘å‰©é¤˜ ${remaining} å¤©ï¼Œç„¡æ³•ç”³è«‹ ${days} å¤©`, 'error');
            }

            const date = document.getElementById('leaveDate').value;
            const reason = document.getElementById('leaveReason').value;

            push(ref(db, 'requests'), {
                empId: currentUserId, empName: emp.name, category: 'leave',
                type, date, days, reason, status: 'pending', timestamp: Date.now()
            });

            const msg = `ã€è«‹å‡ç”³è«‹ã€‘\nğŸ‘¤ ${emp.name}\nğŸ“… ${date} (${days}å¤©)\nğŸ·ï¸ ${type}\nğŸ“ ${reason}`;
            window.open('https://line.me/R/msg/text/?' + encodeURIComponent(msg));
            Swal.fire('å·²é€å‡º', 'ç”³è«‹å·²æäº¤', 'success');
        };

        window.handleCarSubmit = (e) => {
            e.preventDefault();
            if (!currentUserId) return;
            const emp = employees[currentUserId];
            const date = document.getElementById('carDate').value;
            const time = document.getElementById('carTime').value;
            const location = document.getElementById('carLocation').value;

            push(ref(db, 'requests'), {
                empId: currentUserId, empName: emp.name, category: 'car',
                date, time, location, status: 'pending', timestamp: Date.now()
            });

            const msg = `ã€å…¬å‹™è»Šé ç´„ã€‘\nğŸ‘¤ ${emp.name}\nğŸ“… ${date} ${time}\nğŸ“ ${location}`;
            window.open('https://line.me/R/msg/text/?' + encodeURIComponent(msg));
            Swal.fire('å·²é€å‡º', 'ç”³è«‹å·²æäº¤', 'success');
        };

        // --- Admin Logic ---
        window.processRequest = (reqId, action) => {
            const req = requests[reqId]; 
            if (!req) return Swal.fire('éŒ¯èª¤', 'æ‰¾ä¸åˆ°è©²ç”³è«‹ç´€éŒ„', 'error');
            
            const actionText = action === 'approve' ? 'æ‰¹å‡†' : 'é§å›';
            
            Swal.fire({
                title: `ç¢ºèª${actionText}?`,
                text: `${req.empName} çš„ ${req.category === 'car' ? 'å…¬å‹™è»Š' : req.type} ç”³è«‹`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: action === 'approve' ? '#059669' : '#DC2626',
                confirmButtonText: 'ç¢ºèªåŸ·è¡Œ'
            }).then((result) => {
                if (result.isConfirmed) {
                    try {
                        if (action === 'approve' && req.category === 'leave') {
                            const emp = employees[req.empId];
                            if (!emp) return Swal.fire('æ“ä½œå¤±æ•—', 'æ‰¾ä¸åˆ°è©²å“¡å·¥', 'error');
                            
                            const stats = emp.stats || { annual: emp.usedLeave || 0, comp: 0, sick: 0, personal: 0 };
                            
                            if (req.type === 'ç‰¹ä¼‘') stats.annual = (stats.annual || 0) + req.days;
                            if (req.type === 'è£œä¼‘') stats.comp = (stats.comp || 0) - req.days;
                            if (req.type === 'ç—…å‡') stats.sick = (stats.sick || 0) + req.days;
                            if (req.type === 'äº‹å‡') stats.personal = (stats.personal || 0) + req.days;

                            update(ref(db, `employees/${req.empId}`), { 
                                stats: stats,
                                usedLeave: stats.annual
                            });
                        }
                        
                        update(ref(db, `requests/${reqId}`), { status: action === 'approve' ? 'approved' : 'rejected' })
                            .then(() => {
                                if(action === 'approve') {
                                    const calUrl = window.getGoogleCalendarUrl(reqId);
                                    Swal.fire({
                                        title: 'æ‰¹å‡†æˆåŠŸ',
                                        html: `
                                            <p class="text-sm text-slate-500 mb-4">ç”³è«‹å·²é€šéï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•åŠ å…¥è¡Œäº‹æ›†ï¼š</p>
                                            <a href="${calUrl}" target="_blank" class="block w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">
                                                <i class="fa-regular fa-calendar-plus mr-1"></i> åŠ å…¥ Google æ—¥æ›†
                                            </a>
                                        `,
                                        icon: 'success',
                                        showConfirmButton: false, 
                                        showCloseButton: true
                                    });
                                } else {
                                    Swal.fire('æˆåŠŸ', 'æ“ä½œå·²å®Œæˆ', 'success');
                                }
                            })
                            .catch(err => Swal.fire('éŒ¯èª¤', err.message, 'error'));
                            
                    } catch (e) {
                        console.error(e);
                        Swal.fire('ç³»çµ±éŒ¯èª¤', 'åŸ·è¡Œéç¨‹ç™¼ç”Ÿç•°å¸¸', 'error');
                    }
                }
            });
        };

        window.openHistory = (empId) => {
            const emp = employees[empId];
            if(!emp) return;
            currentModalEmpId = empId;
            document.getElementById('modalEmpName').innerText = emp.name;
            
            const stats = emp.stats || { annual: emp.usedLeave || 0, comp: 0, sick: 0, personal: 0 };
            document.getElementById('adjAnnualUsed').value = stats.annual;
            document.getElementById('adjCompBalance').value = stats.comp;
            document.getElementById('adjSickUsed').value = stats.sick;
            document.getElementById('adjPersonalUsed').value = stats.personal;
            
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            const myHistory = Object.entries(requests)
                .map(([key, val]) => ({...val, id: key}))
                .filter(r => r.empId === empId)
                .sort((a,b) => b.timestamp - a.timestamp); 
            
            if(myHistory.length === 0) tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-slate-400">å°šç„¡ç´€éŒ„</td></tr>';
            else {
                myHistory.forEach(req => {
                    let statusColor = req.status === 'approved' ? 'text-green-600 font-bold' : req.status === 'rejected' ? 'text-red-500 font-bold' : 'text-orange-500 font-bold';
                    const detail = req.category === 'car' ? `å…¬å‹™è»Š: ${req.location}` : `${req.type} (${req.days}å¤©)`;
                    const note = req.adminNote ? `<span class="bg-yellow-100 text-yellow-800 text-[10px] px-2 py-1 rounded">${req.adminNote}</span>` : '<span class="text-slate-300 text-[10px]">-</span>';
                    
                    const calUrl = window.getGoogleCalendarUrl(req.id);
                    const calBtn = req.status === 'approved' ? 
                        `<a href="${calUrl}" target="_blank" class="text-blue-500 hover:text-blue-700"><i class="fa-regular fa-calendar-plus"></i></a>` : 
                        '<span class="text-slate-200">-</span>';

                    // VISUAL FIX: Highlight Annual Leave
                    let rowStyle = "";
                    let typeBadge = req.type;
                    if (req.type === 'ç‰¹ä¼‘' && req.status === 'approved') {
                        rowStyle = "bg-blue-50";
                        typeBadge = `<span class="text-blue-600 font-black"><i class="fa-solid fa-star text-[10px] mr-1"></i>ç‰¹ä¼‘</span>`;
                    } else if (req.category === 'car') {
                        typeBadge = `ç”¨è»Š`;
                    }

                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-slate-50 ${rowStyle}">
                            <td class="p-2 text-xs">${req.date}</td>
                            <td class="p-2 text-xs">${typeBadge}</td>
                            <td class="p-2 text-sm text-slate-700">${detail}</td>
                            <td class="p-2 text-xs ${statusColor}">${req.status}</td>
                            <td class="p-2 text-center">${calBtn}</td>
                            <td class="p-2 cursor-pointer" onclick="window.editAdminNote('${req.id}')">${note} <i class="fa-solid fa-pen text-slate-300 text-[10px] ml-1"></i></td>
                            <td class="p-2 text-right"><button onclick="window.deleteHistoryItem('${req.id}')" class="text-red-400 hover:text-red-600 px-2"><i class="fa-solid fa-trash"></i></button></td>
                        </tr>`;
                });
            }
            document.getElementById('historyModal').style.display = 'flex';
        };

        window.closeHistory = () => { document.getElementById('historyModal').style.display = 'none'; };

        window.editAdminNote = async (reqId) => {
            const req = requests[reqId];
            const { value: text } = await Swal.fire({
                title: 'ç®¡ç†å“¡è¨»è¨˜',
                input: 'text',
                inputValue: req.adminNote || '',
                placeholder: 'ä¾‹å¦‚: å·²è£œè­‰æ˜...',
                showCancelButton: true
            });

            if (text !== undefined) {
                update(ref(db, `requests/${reqId}`), { adminNote: text })
                    .then(() => {
                        window.openHistory(currentModalEmpId);
                    });
            }
        };

        window.saveAllAdjustments = () => {
            if(!currentModalEmpId) return;
            const stats = {
                annual: parseFloat(document.getElementById('adjAnnualUsed').value) || 0,
                comp: parseFloat(document.getElementById('adjCompBalance').value) || 0,
                sick: parseFloat(document.getElementById('adjSickUsed').value) || 0,
                personal: parseFloat(document.getElementById('adjPersonalUsed').value) || 0
            };
            update(ref(db, `employees/${currentModalEmpId}`), { stats: stats, usedLeave: stats.annual })
                .then(() => Swal.fire('æ›´æ–°æˆåŠŸ', 'æ‰€æœ‰å‡å‹¤æ•¸æ“šå·²æ ¡æ­£', 'success'));
        };

        window.deleteHistoryItem = (reqId) => {
            Swal.fire({ title: 'ç¢ºå®šåˆªé™¤?', text: 'åˆªé™¤å¾Œä¸å½±éŸ¿å·²æ‰£é™¤çš„é¡åº¦ (éœ€æ‰‹å‹•æ ¡æ­£)', icon: 'warning', showCancelButton: true, confirmButtonText: 'åˆªé™¤' }).then((result) => {
                if(result.isConfirmed) remove(ref(db, `requests/${reqId}`)).then(() => window.openHistory(currentModalEmpId));
            });
        };

        window.saveBulletin = () => {
            set(ref(db, 'bulletin'), {
                title: document.getElementById('adminBulletinTitle').value,
                content: document.getElementById('adminBulletinContent').value,
                date: new Date().toLocaleDateString()
            });
            Swal.fire('æˆåŠŸ', 'ç½®é ‚å…¬å‘Šå·²æ›´æ–°', 'success');
        };

        window.addEmployee = () => {
            const name = document.getElementById('newAdminName').value;
            const gender = document.getElementById('newAdminGender').value;
            const date = document.getElementById('newAdminDate').value;
            const birthday = document.getElementById('newAdminBirthday').value; // Get Birthday
            
            if(!name || !date) return Swal.fire('è³‡æ–™ä¸å®Œæ•´');
            
            const newRef = push(ref(db, 'employees'));
            set(newRef, { 
                id: newRef.key, 
                name, 
                gender, 
                joinDate: date, 
                birthday: birthday, // Save Birthday
                usedLeave: 0, 
                devices: [], 
                stats: {annual:0, comp:0, sick:0, personal:0} 
            });
            document.getElementById('newAdminName').value = '';
            Swal.fire('æˆåŠŸ', 'å“¡å·¥å·²æ–°å¢', 'success');
        };

        window.updateEmpName = (id, newName) => { if(confirm(`ç¢ºå®šæ›´æ”¹å§“åç‚º ${newName}?`)) update(ref(db, `employees/${id}`), { name: newName }); };
        window.updateEmpDate = (id, newDate) => { update(ref(db, `employees/${id}`), { joinDate: newDate }); };
        window.updateEmpBirthday = (id, newDate) => { update(ref(db, `employees/${id}`), { birthday: newDate }); }; // New function
        window.deleteEmployee = (id) => { if(confirm("ç¢ºå®šåˆªé™¤æ­¤å“¡å·¥?")) remove(ref(db, `employees/${id}`)); };
        window.unbindDevice = (empId, deviceIndex) => {
            const emp = employees[empId];
            Swal.fire({ title: 'ç¢ºèªè§£é™¤ç¶å®š?', icon: 'warning', showCancelButton: true, confirmButtonText: 'ç§»é™¤' }).then((result) => {
                if (result.isConfirmed) {
                    const newDevices = [...emp.devices];
                    newDevices.splice(deviceIndex, 1);
                    update(ref(db, `employees/${empId}`), { devices: newDevices });
                    Swal.fire('å·²ç§»é™¤', '', 'success');
                }
            });
        };

        // --- Render Helpers ---
        function renderApprovalQueue() {
            const tbody = document.getElementById('approvalTableBody');
            const noMsg = document.getElementById('noPendingMsg');
            const badge = document.getElementById('pendingCountBadge');
            tbody.innerHTML = '';
            
            const pendingReqs = Object.entries(requests)
                .map(([key, val]) => ({ ...val, id: key }))
                .filter(r => r.status === 'pending')
                .sort((a,b) => a.timestamp - b.timestamp);
            
            if (pendingReqs.length > 0) {
                noMsg.classList.add('hidden');
                badge.innerText = pendingReqs.length;
                badge.classList.remove('hidden');
                pendingReqs.forEach(req => {
                    const isCar = req.category === 'car';
                    const icon = isCar ? '<i class="fa-solid fa-car"></i>' : '<i class="fa-solid fa-user-clock"></i>';
                    const typeLabel = isCar ? 'å…¬å‹™è»Š' : req.type;
                    const detail = isCar ? `${req.time} @ ${req.location}` : `${req.days} å¤© | ${req.reason}`;
                    const rowClass = isCar ? 'border-l-4 border-l-brand-gold' : 'border-l-4 border-l-blue-500';

                    tbody.innerHTML += `
                        <tr class="bg-white border-b hover:bg-slate-50 ${rowClass}">
                            <td class="p-3 font-bold text-slate-700 flex items-center gap-2">${icon} ${req.empName}</td>
                            <td class="p-3">
                                <div class="font-bold text-slate-800">${typeLabel}</div>
                                <div class="text-xs text-slate-500">${req.date}</div>
                            </td>
                            <td class="p-3 text-sm text-slate-600">${detail}</td>
                            <td class="p-3 text-right space-x-1">
                                <button onclick="window.processRequest('${req.id}', 'approve')" class="text-green-600 hover:bg-green-100 p-1 rounded"><i class="fa-solid fa-check"></i></button>
                                <button onclick="window.processRequest('${req.id}', 'reject')" class="text-red-600 hover:bg-red-100 p-1 rounded"><i class="fa-solid fa-xmark"></i></button>
                            </td>
                        </tr>`;
                });
            } else {
                noMsg.classList.remove('hidden');
                badge.classList.add('hidden');
            }
        }

        function renderAdminTable() {
            const tbody = document.getElementById('adminTableBody');
            tbody.innerHTML = '';
            Object.values(employees).forEach(emp => {
                const devices = emp.devices || [];
                let deviceHtml = devices.map((did, idx) => `<span class="device-badge cursor-pointer hover:bg-red-200 hover:text-red-800" onclick="window.unbindDevice('${emp.id}', ${idx})">ğŸ“± ${did.substr(0,4)}...</span>`).join(' ');
                if (devices.length === 0) deviceHtml = '<span class="text-xs text-slate-300">æœªç¶å®š</span>';

                const calc = calculateLeave(emp.joinDate);
                const stats = emp.stats || { annual: emp.usedLeave || 0, comp: 0 };
                const remaining = calc.days - stats.annual;

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 border-b">
                        <td class="p-3"><input type="text" value="${emp.name}" onchange="window.updateEmpName('${emp.id}', this.value)" class="border rounded px-2 py-1 w-20 text-sm font-bold text-slate-700 focus:border-blue-500 outline-none"></td>
                        <td class="p-3">
                            <div class="flex flex-col gap-1">
                                <div class="flex items-center gap-1 text-xs">
                                    <span class="text-slate-400">åˆ°è·:</span>
                                    <input type="date" value="${emp.joinDate}" onchange="window.updateEmpDate('${emp.id}', this.value)" class="text-xs text-slate-600 bg-transparent border-none outline-none p-0 cursor-pointer hover:text-blue-500">
                                </div>
                                <div class="flex items-center gap-1 text-xs">
                                    <span class="text-slate-400">ç”Ÿæ—¥:</span>
                                    <input type="date" value="${emp.birthday || ''}" onchange="window.updateEmpBirthday('${emp.id}', this.value)" class="text-xs text-slate-600 bg-transparent border-none outline-none p-0 cursor-pointer hover:text-blue-500">
                                </div>
                            </div>
                        </td>
                        <td class="p-3">
                            <div class="flex items-center gap-2 text-xs">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">ç¸½:${calc.days}</span>
                                <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded">ç”¨:${stats.annual}</span>
                                <span class="font-bold text-sm ${remaining<0?'text-red-500':'text-green-600'}">å‰©:${remaining}</span>
                            </div>
                        </td>
                        <td class="p-3">${deviceHtml}</td>
                        <td class="p-3 text-right space-x-1">
                             <button onclick="window.openHistory('${emp.id}')" class="bg-white border border-slate-200 text-slate-600 text-xs px-2 py-1 rounded hover:bg-slate-50 shadow-sm" title="ç´€éŒ„èˆ‡æ ¡æ­£"><i class="fa-solid fa-pen-to-square"></i></button>
                             <button onclick="window.deleteEmployee('${emp.id}')" class="text-slate-300 hover:text-red-500 px-2" title="åˆªé™¤å“¡å·¥"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        // --- CORE: Labor Standards Act Calculation (Article 38) ---
        function calculateLeave(joinDate) {
            const now = new Date();
            const start = new Date(joinDate);
            // Precise year calculation (including leap years)
            const years = (now - start) / (1000 * 60 * 60 * 24 * 365.25);
            let days = 0;
            let rule = "";

            if (years < 0.5) { 
                days = 0; 
                rule = "æœªæ»¿åŠå¹´ (0å¤©)";
            } else if (years >= 0.5 && years < 1) { 
                days = 3; 
                rule = "æ»¿åŠå¹´æœªæ»¿ä¸€å¹´ (3å¤©)";
            } else if (years >= 1 && years < 2) { 
                days = 7; 
                rule = "æ»¿1å¹´ (7å¤©)";
            } else if (years >= 2 && years < 3) { 
                days = 10; 
                rule = "æ»¿2å¹´ (10å¤©)";
            } else if (years >= 3 && years < 5) { 
                days = 14; 
                rule = "æ»¿3å¹´ (14å¤©)";
            } else if (years >= 5 && years < 10) { 
                days = 15; 
                rule = "æ»¿5å¹´ (15å¤©)";
            } else if (years >= 10) { 
                // Article 38: 15 days + 1 day for every year over 10, max 30
                days = Math.min(30, 15 + Math.floor(years - 10));
                rule = `æ»¿${Math.floor(years)}å¹´ (${days}å¤©)`;
            }
            
            return { years: years.toFixed(1), days: days, rule: rule };
        }

        function renderBulletin() {
            document.getElementById('displayBulletinTitle').innerText = bulletin.title;
            document.getElementById('displayBulletinContent').innerText = bulletin.content;
            document.getElementById('displayBulletinDate').innerText = bulletin.date;
        }
        
        function renderActivityFeed() {
            const feedContainer = document.getElementById('activityFeed');
            const now = new Date();
            const activeReqs = Object.values(requests)
                .filter(r => r.status === 'approved')
                .filter(r => new Date(r.date) >= new Date(now.setHours(0,0,0,0))) 
                .sort((a,b) => new Date(a.date) - new Date(b.date)) 
                .slice(0, 10); 

            if (activeReqs.length === 0) {
                feedContainer.innerHTML = '<div class="p-4 text-center text-xs text-slate-400">æœªä¾† 7 å¤©å…§ç„¡è«‹å‡æˆ–ç”¨è»Šç´€éŒ„</div>';
                return;
            }

            feedContainer.innerHTML = '';
            activeReqs.forEach(r => {
                const isCar = r.category === 'car';
                const icon = isCar ? 'fa-car' : 'fa-user-clock';
                const colorClass = isCar ? 'text-brand-gold' : 'text-blue-500';
                const bgClass = isCar ? 'bg-yellow-50' : 'bg-blue-50';
                const desc = isCar ? `${r.time} å» ${r.location}` : `${r.type} (${r.days}å¤©)`;

                feedContainer.innerHTML += `
                    <div class="p-3 border-b border-slate-100 flex items-start gap-3 hover:bg-slate-50 transition">
                        <div class="w-8 h-8 rounded-full ${bgClass} flex items-center justify-center shrink-0">
                            <i class="fa-solid ${icon} ${colorClass} text-xs"></i>
                        </div>
                        <div>
                            <div class="text-xs font-bold text-slate-700 flex items-center gap-1">
                                ${r.empName}
                                <span class="text-[10px] font-normal text-slate-400 bg-slate-100 px-1 rounded">${r.date.slice(5)}</span>
                            </div>
                            <div class="text-xs text-slate-500 mt-0.5">${desc}</div>
                        </div>
                    </div>
                `;
            });
        }

        function renderAttendanceLog() {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';
            Object.values(attendance).sort((a,b) => b.timestamp - a.timestamp).forEach(log => {
                let statusBadge = '<span class="tag-ok">æ­£å¸¸</span>';
                if(log.status === 'é²åˆ°') statusBadge = '<span class="tag-late">é²åˆ°</span>';
                if(log.status === 'åŠ ç­') statusBadge = '<span class="tag-ot">åŠ ç­</span>';
                // Backward compatibility for old records
                if(!log.status) {
                     if(log.type === 'ä¸Šç­' && parseInt(log.timeStr.replace(':','')) > 830) statusBadge = '<span class="tag-late">é²åˆ°</span>';
                     else if(log.type === 'ä¸‹ç­' && parseInt(log.timeStr.replace(':','')) > 1800) statusBadge = '<span class="tag-ot">åŠ ç­</span>';
                }

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 border-b">
                        <td class="p-2 font-bold text-slate-700">${log.empName}</td>
                        <td class="p-2 ${log.type==='ä¸Šç­'?'text-blue-600':'text-orange-600'}">${log.type}</td>
                        <td class="p-2 text-slate-500">${log.dateStr} ${log.timeStr}</td>
                        <td class="p-2">${statusBadge}</td>
                        <td class="p-2"><a href="${log.mapLink}" target="_blank" class="text-blue-500"><i class="fa-solid fa-map-location-dot"></i></a></td>
                    </tr>`;
            });
        }
        
        window.exportAttendance = () => {
             const logs = Object.values(attendance).sort((a,b) => b.timestamp - a.timestamp);
             if (logs.length === 0) return Swal.fire('å°šç„¡è³‡æ–™');
             let csv = "\uFEFFå§“å,é¡å‹,æ—¥æœŸ,æ™‚é–“,ç‹€æ…‹,åœ°åœ–\n";
             logs.forEach(l => csv += `${l.empName},${l.type},${l.dateStr},${l.timeStr},${l.status || ''},${l.mapLink}\n`);
             const link = document.createElement("a");
             link.href = URL.createObjectURL(new Blob([csv], { type: "text/csv;charset=utf-8;" }));
             link.download = "è€ƒå‹¤ç´€éŒ„.csv";
             link.click();
        };

        window.exportLeaveRequests = () => {
            const reqs = Object.values(requests).filter(r => r.category === 'leave').sort((a,b) => b.timestamp - a.timestamp);
            if (reqs.length === 0) return Swal.fire('å°šç„¡è«‹å‡è³‡æ–™');
            
            let csv = "\uFEFFå§“å,æ—¥æœŸ,å‡åˆ¥,å¤©æ•¸,äº‹ç”±,ç‹€æ…‹,ç®¡ç†å“¡è¨»è¨˜\n";
            reqs.forEach(r => {
                const note = r.adminNote ? r.adminNote.replace(/,/g, ' ') : ''; 
                const reason = r.reason ? r.reason.replace(/,/g, ' ') : '';
                csv += `${r.empName},${r.date},${r.type},${r.days},${reason},${r.status},${note}\n`;
            });
            
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: "text/csv;charset=utf-8;" }));
            link.download = `è«‹å‡æ˜ç´°åŒ¯å‡º_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        };

        document.getElementById('leaveDate').valueAsDate = new Date();
        document.getElementById('carDate').valueAsDate = new Date();
        document.getElementById('logDate').valueAsDate = new Date();
    </script>
</body>
</html>