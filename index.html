<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®åœ‹åœ°æ”¿|æ˜“ä¸åœ°æ”¿ - æ™ºæ…§æŒ‡æ®è‰™ (Nexus V5.17 Time-Sync)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .serif { font-family: 'Noto Serif TC', serif; }
        .brand-bg { background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%); } 
        .text-brand-gold { color: #facc15; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-radius: 1rem; transition: all 0.3s ease; }
        .input-modern { background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.5rem; transition: all 0.2s; }
        .input-modern:focus { background: #fff; border-color: #2563eb; outline: none; }
        .hidden-section { display: none; }
        
        .fade-in-up { animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* è–ªè³‡æ‹‰æ¢ */
        input[type=range] { -webkit-appearance: none; width: 100%; height: 6px; border-radius: 5px; background: #cbd5e1; outline: none; margin: 10px 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #2563eb; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }

        .impact-card { transition: all 0.3s ease; border-left: 4px solid; background-color: white; border: 1px solid #e2e8f0; }
        .impact-full { border-left-color: #22c55e; background-color: #f0fdf4; } 
        .impact-half { border-left-color: #f97316; background-color: #fff7ed; } 
        .impact-none { border-left-color: #ef4444; background-color: #fef2f2; } 

        .btn-punch:active { transform: scale(0.95); }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: bold; background-color: #f0f9ff; }
        .tab-inactive { color: #64748b; background-color: transparent; }
        .device-badge { font-family: monospace; font-size: 0.7rem; background: #e2e8f0; padding: 2px 6px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 95%; max-width: 900px; max-height: 90vh; border-radius: 1rem; padding: 0; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .lsa-badge { font-size: 0.65rem; background-color: #e0f2fe; color: #0369a1; padding: 2px 6px; border-radius: 4px; border: 1px solid #bae6fd; display: inline-block; margin-top: 4px; }
        
        .tag-late { background-color: #fee2e2; color: #991b1b; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; border: 1px solid #fecaca; }
        .tag-ot { background-color: #f3e8ff; color: #6b21a8; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; border: 1px solid #e9d5ff; }
        .tag-ok { background-color: #dcfce7; color: #166534; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; border: 1px solid #bbf7d0; }

        /* Avatar Hover Effect */
        .avatar-hover-container { position: relative; cursor: pointer; transition: transform 0.2s; }
        .avatar-hover-container:active { transform: scale(0.95); }
        .avatar-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.4); border-radius: 9999px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
        .avatar-hover-container:hover .avatar-overlay { opacity: 1; }

        /* Leave Type Toggle */
        .leave-mode-btn { border: 1px solid #cbd5e1; color: #64748b; background: white; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; flex: 1; transition: all 0.2s; }
        .leave-mode-active { background-color: #eff6ff; border-color: #2563eb; color: #2563eb; font-weight: bold; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="brand-bg text-white sticky top-0 z-50 shadow-md">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white text-blue-900 rounded-lg flex items-center justify-center font-bold text-lg serif shadow-lg">å®</div>
                <div>
                    <h1 class="text-base md:text-lg font-bold tracking-wider serif">å®åœ‹åœ°æ”¿ | æ˜“ä¸åœ°æ”¿</h1>
                    <p class="text-[10px] text-blue-200 tracking-widest uppercase">Nexus V5.17 (Time-Sync)</p>
                </div>
            </div>
            <div class="flex bg-blue-900/50 rounded-full p-1">
                <button onclick="switchView('employee')" id="btnEmp" class="px-4 py-1.5 rounded-full text-xs md:text-sm font-medium transition-all bg-white text-blue-900 shadow-sm">åŒä»å°ˆå€</button>
                <button onclick="checkAdminLogin()" id="btnAdm" class="px-4 py-1.5 rounded-full text-xs md:text-sm font-medium text-blue-200 hover:text-white transition-all">ç®¡ç†å¾Œå°</button>
            </div>
        </div>
    </header>

    <main class="flex-grow p-4 md:p-6 max-w-7xl mx-auto w-full">
        <section id="loginSection" class="w-full glass-panel p-10 text-center max-w-lg mx-auto mt-12 fade-in-up">
            <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-2xl"><i class="fa-solid fa-mobile-screen-button"></i></div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">è£ç½®é©—è­‰ç³»çµ±</h2>
            <p class="text-slate-500 mb-4 text-sm">ç³»çµ±å°‡è‡ªå‹•è­˜åˆ¥æ‚¨çš„è£ç½®æ¬Šé™ (ä¸Šé™ 3 å°)</p>
            
            <div class="bg-slate-100 p-2 rounded mb-6 text-xs text-slate-400 font-mono">
                æœ¬æ©Ÿ ID: <span id="myDeviceIdDisplay">åµæ¸¬ä¸­...</span>
            </div>

            <select id="empSelect" onchange="tryBindAndLogin()" class="w-full p-3 pl-4 text-lg input-modern cursor-pointer text-center font-bold text-slate-700 disabled:opacity-50 mb-4" disabled>
                <option value="">-- è³‡æ–™è¼‰å…¥ä¸­ --</option>
            </select>

            <div id="loginStatusMsg" class="text-sm text-blue-600 font-bold hidden">
                <i class="fa-solid fa-spinner fa-spin"></i> æ­£åœ¨é©—è­‰è£ç½®å®‰å…¨æ€§...
            </div>
        </section>

        <section id="employeeView" class="w-full space-y-6 hidden-section">
            <input type="file" id="avatarInput" accept="image/*" class="hidden" onchange="handleAvatarChange(event)">
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in-up">
                <div class="lg:col-span-2 brand-bg rounded-2xl p-6 text-white relative overflow-hidden shadow-xl flex flex-col justify-center min-h-[160px]">
                    <div class="absolute top-0 right-0 bg-white/10 px-3 py-1 rounded-bl-lg text-[10px] font-bold tracking-widest uppercase text-blue-200">Official Notice</div>
                    <div class="relative z-10 flex flex-col md:flex-row items-start gap-4">
                        <div class="bg-white/10 p-3 rounded-xl backdrop-blur-sm shrink-0"><i class="fa-solid fa-bullhorn text-brand-gold text-2xl"></i></div>
                        <div class="w-full">
                            <div class="flex justify-between items-start">
                                <h3 id="displayBulletinTitle" class="font-bold text-xl text-brand-gold mb-2">...</h3>
                            </div>
                            <p id="displayBulletinContent" class="text-slate-100 text-sm leading-relaxed whitespace-pre-wrap opacity-90">...</p>
                            <div class="mt-4 text-[10px] text-blue-300 border-t border-blue-800 pt-2 flex justify-between">
                                <span><i class="fa-solid fa-user-tie mr-1"></i> ç®¡ç†è™•ç™¼å¸ƒ</span>
                                <span id="displayBulletinDate">--/--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1 glass-panel p-0 overflow-hidden flex flex-col h-auto lg:h-full border-t-4 border-green-500">
                    <div class="p-3 bg-slate-50 border-b border-slate-200 flex justify-between items-center shrink-0">
                        <h3 class="font-bold text-slate-700 text-sm"><i class="fa-solid fa-rss text-green-600 mr-2"></i> åœ˜éšŠå³æ™‚å‹•æ…‹</h3>
                        <span class="text-[10px] bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Approved</span>
                    </div>
                    <div class="flex-1 overflow-y-auto p-0 custom-scrollbar h-[200px] lg:h-auto" id="activityFeed">
                        <div class="p-4 text-center text-xs text-slate-400">ç›®å‰æ²’æœ‰å³å°‡ç™¼ç”Ÿçš„å‹•æ…‹</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="glass-panel p-6 border-l-4 border-blue-600 fade-in-up relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-blue-50 px-4 py-2 rounded-bl-xl border-b border-l border-blue-100 shadow-sm text-right">
                             <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">æ¨™æº–: 08:30 - 18:00</div>
                             <div class="text-xl font-black text-blue-700 font-mono" id="liveClock">00:00:00</div>
                             <div id="clockStatusBadge" class="text-[10px] font-bold text-slate-400 mt-1">æª¢æ¸¬ä¸­...</div>
                        </div>

                        <div class="flex justify-between items-center mb-8 mt-2">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2 text-lg">
                                <i class="fa-solid fa-location-dot text-blue-600"></i> å®šä½æ‰“å¡
                            </h3>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="handlePunch('ä¸Šç­')" class="btn-punch flex flex-col items-center justify-center p-4 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl shadow-lg shadow-blue-500/30 hover:shadow-xl">
                                <i class="fa-solid fa-sun text-2xl mb-2"></i><span class="font-bold">ä¸Šç­æ‰“å¡</span>
                                <span class="text-[10px] opacity-70 mt-1">é²åˆ°åŸºæº–: 08:30</span>
                            </button>
                            <button onclick="handlePunch('ä¸‹ç­')" class="btn-punch flex flex-col items-center justify-center p-4 bg-gradient-to-br from-orange-400 to-red-500 text-white rounded-xl shadow-lg shadow-orange-500/30 hover:shadow-xl">
                                <i class="fa-solid fa-moon text-2xl mb-2"></i><span class="font-bold">ä¸‹ç­æ‰“å¡</span>
                                <span class="text-[10px] opacity-70 mt-1">åŠ ç­èµ·å§‹: 18:00</span>
                            </button>
                        </div>
                    </div>

                    <div class="glass-panel p-6 border-t-4 border-brand-gold fade-in-up">
                        <div class="flex border-b border-gray-200 mb-4">
                            <button class="flex-1 py-2 text-center text-sm tab-active transition-colors" id="tab-leave" onclick="switchAppTab('leave')">è«‹å‡</button>
                            <button class="flex-1 py-2 text-center text-sm tab-inactive transition-colors" id="tab-car" onclick="switchAppTab('car')">å…¬å‹™è»Š</button>
                            <button class="flex-1 py-2 text-center text-sm tab-inactive transition-colors font-bold text-purple-600" id="tab-log" onclick="switchAppTab('log')">å·¥ä½œæ—¥èªŒ</button>
                        </div>

                        <form id="form-leave" onsubmit="handleLeaveSubmit(event)" class="space-y-4">
                            <div class="flex gap-2 mb-2">
                                <button type="button" id="btnModeDay" class="leave-mode-btn leave-mode-active" onclick="switchLeaveMode('day')">
                                    <i class="fa-regular fa-calendar mr-1"></i> å…¨å¤©å–®ä½
                                </button>
                                <button type="button" id="btnModeTime" class="leave-mode-btn" onclick="switchLeaveMode('time')">
                                    <i class="fa-regular fa-clock mr-1"></i> å°æ™‚ (å€é–“)
                                </button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">å‡åˆ¥</label>
                                    <select id="leaveType" class="w-full p-2.5 input-modern" onchange="updateImpactInfo()">
                                        <option value="ç‰¹ä¼‘">ç‰¹ä¼‘ (å…¨è–ª)</option>
                                        <option value="ç—…å‡">ç—…å‡ (åŠè–ª)</option>
                                        <option value="äº‹å‡">äº‹å‡ (ç„¡è–ª)</option>
                                        <option value="è£œä¼‘">è£œä¼‘ (å…¨è–ª)</option>
                                        <option value="å©šå‡">å©šå‡ (å…¨è–ª)</option>
                                    </select>
                                </div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">æ—¥æœŸ</label><input type="date" id="leaveDate" class="w-full p-2.5 input-modern"></div>
                                
                                <div id="inputDayMode" class="md:col-span-2">
                                    <label class="block text-xs font-bold text-slate-500 mb-1">å¤©æ•¸</label>
                                    <input type="number" id="leaveDays" min="0.5" step="0.5" value="1" class="w-full p-2.5 input-modern" oninput="updateImpactInfo()">
                                </div>

                                <div id="inputTimeMode" class="hidden md:col-span-2 grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">é–‹å§‹æ™‚é–“</label>
                                        <input type="time" id="leaveStartTime" class="w-full p-2.5 input-modern" onchange="calcTimeDiff()">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">çµæŸæ™‚é–“</label>
                                        <input type="time" id="leaveEndTime" class="w-full p-2.5 input-modern" onchange="calcTimeDiff()">
                                    </div>
                                    <div class="col-span-2 text-xs text-blue-600 bg-blue-50 p-2 rounded text-center">
                                        é è¨ˆæ™‚æ•¸: <span id="timeDiffDisplay" class="font-bold">0</span> å°æ™‚ 
                                        <span class="text-slate-400 ml-1">(è‡ªå‹•æ›ç®—å¤©æ•¸)</span>
                                    </div>
                                </div>

                                <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 mb-1">äº‹ç”±</label><input type="text" id="leaveReason" class="w-full p-2.5 input-modern" placeholder="ä¾‹ï¼šè™•ç†ç§äººäº‹å‹™"></div>
                            </div>
                            
                            <div id="impactCard" class="impact-card impact-full p-4 rounded-lg flex justify-between items-center mt-2">
                                <div>
                                    <div class="font-bold text-sm text-slate-700" id="impactTitle">å…¨è–ª</div>
                                    <div class="text-xs text-slate-500" id="impactDesc">å·¥è³‡ç…§çµ¦ï¼Œä¸æ‰£ç™¼è–ªè³‡ã€‚</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-slate-400">é ä¼°æ‰£è–ª</div>
                                    <div class="font-bold text-lg text-red-500">$<span id="impactAmount">0</span></div>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-[#06c755] hover:bg-[#05b34c] text-white font-bold py-3 rounded-lg shadow-lg transition flex justify-center items-center gap-2"><i class="fa-brands fa-line"></i> é€å‡ºä¸¦é€šçŸ¥ LINE ç¾¤çµ„</button>
                        </form>

                        <form id="form-car" onsubmit="handleCarSubmit(event)" class="space-y-4 hidden-section">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">é ç´„æ—¥æœŸ</label><input type="date" id="carDate" class="w-full p-2.5 input-modern"></div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">æ™‚é–“</label><input type="time" id="carTime" class="w-full p-2.5 input-modern"></div>
                                <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 mb-1">åœ°é» / ç”¨é€”</label><input type="text" id="carLocation" class="w-full p-2.5 input-modern" placeholder="ä¾‹ï¼šå‰å¾€å¸‚æ”¿åºœæ´½å…¬"></div>
                            </div>
                            <div class="bg-blue-50 text-blue-700 text-xs p-3 rounded">
                                <i class="fa-solid fa-circle-info mr-1"></i> å…¬å‹™è»Šéœ€ç¶“ç®¡ç†å“¡å¯©æ ¸ã€‚
                            </div>
                            <button type="submit" class="w-full bg-[#06c755] hover:bg-[#05b34c] text-white font-bold py-3 rounded-lg shadow-lg transition flex justify-center items-center gap-2"><i class="fa-brands fa-line"></i> é€å‡ºä¸¦é€šçŸ¥ LINE ç¾¤çµ„</button>
                        </form>

                        <form id="form-log" onsubmit="handleLogSubmit(event)" class="space-y-4 hidden-section">
                            <div class="flex justify-between items-end mb-2">
                                <div class="w-2/3">
                                    <label class="block text-xs font-bold text-slate-500 mb-1">åŒ¯å ±æ—¥æœŸ</label>
                                    <input type="date" id="logDate" class="w-full p-2 input-modern">
                                </div>
                                <button type="button" onclick="addNewTaskType()" class="text-xs bg-slate-800 text-white px-3 py-2 rounded hover:bg-slate-700 shadow"><i class="fa-solid fa-plus mr-1"></i> æ–°å¢é …ç›®</button>
                            </div>

                            <div class="space-y-2" id="logEntriesContainer">
                                <div class="text-center text-sm text-slate-400 py-4"><i class="fa-solid fa-spinner fa-spin"></i> è¼‰å…¥é¸é …ä¸­...</div>
                            </div>

                            <button type="submit" class="w-full bg-[#06c755] hover:bg-[#05b34c] text-white font-bold py-3 rounded-lg shadow-lg transition flex justify-center items-center gap-2 mt-4"><i class="fa-brands fa-line"></i> ç”¢ç”ŸåŒ¯å ±ä¸¦é€šçŸ¥ LINE</button>
                        </form>
                    </div>

                    <div class="glass-panel p-6 fade-in-up">
                        <h3 class="font-bold text-slate-700 mb-4 text-sm uppercase tracking-wider">æœ€è¿‘ç”³è«‹ç´€éŒ„</h3>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left"><tbody id="myRequestsTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                </div>

                <div class="space-y-6 lg:col-span-1">
                    <div class="glass-panel p-6 bg-slate-900 text-white fade-in-up">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold flex items-center gap-2"><i class="fa-solid fa-calculator text-brand-gold"></i> è–ªè³‡è©¦ç®—å„€è¡¨</h3></div>
                        
                        <div class="space-y-6">
                            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                                <label class="flex justify-between text-xs text-slate-400 mb-2">
                                    <span>è¨­å®šæœˆè–ª</span>
                                    <span class="text-brand-gold font-mono">$<span id="displaySalary">30,000</span></span>
                                </label>
                                <input type="range" id="salarySlider" min="27000" max="80000" step="500" value="30000" oninput="updateSalaryFromSlider(this.value)">
                                <input type="number" id="monthlySalary" value="30000" class="w-full bg-slate-900 border border-slate-600 rounded p-1 text-center text-white font-bold" oninput="updateSalaryFromInput(this.value)">
                            </div>

                            <div>
                                <div class="flex justify-between text-xs mb-1 text-slate-400"><span>å¹³æ—¥åŠ ç­ (å‰2hr)</span><span class="text-white font-bold"><span id="calcHours1Val">0</span> hr</span></div>
                                <input type="range" id="calcHours1" min="0" max="20" step="0.5" value="0" oninput="calculateOvertime()">
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1 text-slate-400"><span>å¹³æ—¥åŠ ç­ (ç¬¬3hrèµ·)</span><span class="text-white font-bold"><span id="calcHours2Val">0</span> hr</span></div>
                                <input type="range" id="calcHours2" min="0" max="20" step="0.5" value="0" oninput="calculateOvertime()">
                            </div>

                            <div class="mt-4 pt-4 border-t border-slate-700 space-y-2">
                                <div class="flex justify-between text-xs text-slate-400">
                                    <span>é ä¼°åŠ ç­è²» (+)</span>
                                    <span class="text-green-400 font-mono">$<span id="calcOtTotal">0</span></span>
                                </div>
                                <div class="flex justify-between text-xs text-slate-400">
                                    <span>è«‹å‡æ‰£è–ª (-)</span>
                                    <span class="text-red-400 font-mono">$<span id="calcDeduction">0</span></span>
                                </div>
                                <div class="flex justify-between items-end mt-2 pt-2 border-t border-slate-700/50">
                                    <span class="text-sm font-bold text-white">é ä¼°å¯¦é ˜</span>
                                    <div class="text-2xl font-black text-brand-gold font-mono">$<span id="calcFinalTotal">0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass-panel p-6 flex flex-col items-center text-center fade-in-up relative group">
                        <div class="absolute top-3 right-3 text-slate-300 hover:text-blue-500 cursor-pointer" onclick="toggleLegalInfo()" title="æŸ¥çœ‹å‹åŸºæ³•è¦å®š">
                            <i class="fa-solid fa-scale-balanced"></i>
                        </div>

                        <div class="avatar-hover-container w-20 h-20 mb-2 relative" onclick="triggerAvatarUpload()">
                            <img id="dashboardAvatarImg" src="" class="w-full h-full rounded-full object-cover border-4 border-white shadow-lg bg-slate-100 hidden">
                            <div id="dashboardAvatarPlaceholder" class="w-full h-full bg-slate-100 rounded-full flex items-center justify-center text-3xl text-slate-300 border-4 border-white shadow-lg">
                                ğŸ‘¤
                            </div>
                            <div class="avatar-overlay">
                                <i class="fa-solid fa-camera text-white"></i>
                            </div>
                        </div>

                        <h2 id="dashboardName" class="text-xl font-bold text-slate-800">...</h2>
                        
                        <div class="flex flex-col items-center gap-1 mt-1">
                            <div class="text-xs font-mono text-slate-500 bg-slate-100 px-3 py-1 rounded-lg border border-slate-200 shadow-sm">
                                <i class="fa-regular fa-calendar-check mr-1"></i> 
                                å…¥è·ï¼š<span id="dashboardJoinDate" class="font-bold">--</span>
                                <span id="dashboardTenure" class="ml-2 bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded text-[10px] font-bold">--</span>
                            </div>
                            <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-[10px] font-bold mt-1">
                                <i class="fa-solid fa-check-circle"></i> è£ç½®å·²é–å®š
                            </span>
                        </div>

                        <div class="mt-4 w-full grid grid-cols-2 gap-2 text-center">
                            <div class="bg-blue-50 p-2 rounded relative">
                                <div class="absolute -top-2 -left-1 bg-amber-400 text-white text-[9px] px-1 rounded shadow">é€±å¹´åˆ¶</div>
                                <div class="text-[10px] text-slate-400 uppercase mt-1">ç‰¹ä¼‘é¡åº¦ (ä¾å‹åŸºæ³•)</div>
                                <div class="font-bold text-blue-800" id="dashboardTotal">--</div>
                                <div class="lsa-badge" id="dashboardRule">è¨ˆç®—ä¸­...</div>
                            </div>
                            <div class="bg-green-50 p-2 rounded">
                                <div class="text-[10px] text-slate-400 uppercase mt-1">ç‰¹ä¼‘å‰©é¤˜</div>
                                <div class="font-bold text-green-600" id="dashboardRemaining">--</div>
                            </div>
                        </div>
                        <div class="mt-2 text-[10px] text-slate-400">
                             â€» æ¡ã€Œé€±å¹´åˆ¶ã€ï¼šæ–¼å€‹äººåˆ°è·æ—¥æ»¿é€±å¹´æ™‚è‡ªå‹•é‡ç½®é¡åº¦ã€‚
                        </div>
                        <div class="mt-2 text-xs text-slate-500">
                            è£œä¼‘é¤˜é¡: <span class="font-bold text-orange-600" id="dashboardComp">0</span> å¤©
                        </div>

                        <div id="legalInfoCard" class="hidden absolute inset-0 bg-white/95 backdrop-blur z-20 rounded-xl p-4 flex flex-col justify-center text-left border border-blue-200">
                            <h4 class="font-bold text-blue-800 mb-2 border-b pb-1">ğŸ“œ å‹åŸºæ³•ç¬¬38æ¢ (ç‰¹ä¼‘)</h4>
                            <ul class="text-xs space-y-1 text-slate-600 list-disc pl-4">
                                <li>6å€‹æœˆä»¥ä¸Š1å¹´æœªæ»¿ï¼š3æ—¥</li>
                                <li>1å¹´ä»¥ä¸Š2å¹´æœªæ»¿ï¼š7æ—¥</li>
                                <li>2å¹´ä»¥ä¸Š3å¹´æœªæ»¿ï¼š10æ—¥</li>
                                <li>3å¹´ä»¥ä¸Š5å¹´æœªæ»¿ï¼š14æ—¥</li>
                                <li>5å¹´ä»¥ä¸Š10å¹´æœªæ»¿ï¼š15æ—¥</li>
                                <li>10å¹´ä»¥ä¸Šï¼šæ¯ä¸€å¹´åŠ çµ¦1æ—¥ï¼Œä¸Šé™30æ—¥</li>
                            </ul>
                            <div class="mt-2 text-[10px] text-red-500">* æœ¬ç³»çµ±æ¡ã€Œé€±å¹´åˆ¶ã€ï¼Œæ–¼åˆ°è·æ—¥çµç®—ã€‚</div>
                            <button onclick="toggleLegalInfo()" class="mt-4 w-full bg-slate-100 text-slate-500 text-xs py-1 rounded hover:bg-slate-200">é—œé–‰èªªæ˜</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="adminView" class="hidden-section w-full fade-in-up">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 glass-panel p-6 border-t-4 border-blue-600">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-clipboard-check text-blue-600"></i> ç”³è«‹å¯©æ ¸ä¸­å¿ƒ 
                        <span id="pendingCountBadge" class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                    </h2>
                    <div class="overflow-x-auto"><table class="w-full text-left text-sm"><tbody id="approvalTableBody" class="divide-y divide-slate-100"></tbody></table></div>
                    <div id="noPendingMsg" class="text-center py-8 text-slate-400"><i class="fa-regular fa-circle-check text-4xl mb-2 text-slate-200"></i><p>ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„ç”³è«‹</p></div>
                </div>

                <div class="lg:col-span-1 glass-panel p-6 border-t-4 border-brand-gold">
                    <h2 class="text-lg font-bold text-slate-800 mb-4"><i class="fa-solid fa-bullhorn text-brand-gold mr-2"></i> ç½®é ‚å…¬å‘Šç®¡ç†</h2>
                    <input type="text" id="adminBulletinTitle" class="w-full p-2 mb-2 input-modern" placeholder="æ¨™é¡Œ">
                    <textarea id="adminBulletinContent" rows="4" class="w-full p-2 mb-2 input-modern" placeholder="å…§å®¹"></textarea>
                    <button onclick="saveBulletin()" class="w-full bg-slate-800 text-white p-2 rounded font-bold hover:bg-slate-700">æ›´æ–°ç½®é ‚ç™¼å¸ƒ</button>
                    <div class="mt-4 text-xs text-slate-400 p-2 bg-slate-50 rounded">
                        <i class="fa-solid fa-info-circle mr-1"></i> è«‹å‡/ç”¨è»Šè³‡è¨Šå°‡è‡ªå‹•é¡¯ç¤ºæ–¼ã€Œå‹•æ…‹ç‰†ã€ï¼Œç„¡éœ€åœ¨æ­¤ç™¼å¸ƒã€‚
                    </div>
                </div>

                <div class="lg:col-span-3 glass-panel p-6 border-t-4 border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-clock-rotate-left text-slate-700"></i> è€ƒå‹¤èˆ‡å ±è¡¨ä¸­å¿ƒ</h2>
                        <div class="flex gap-2">
                            <button onclick="exportLeaveRequests()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-2 rounded shadow flex items-center gap-1">
                                <i class="fa-solid fa-file-invoice"></i> åŒ¯å‡ºè«‹å‡æ˜ç´°(å«è¨»è¨˜)
                            </button>
                            <button onclick="exportAttendance()" class="bg-green-600 hover:bg-green-500 text-white text-xs px-3 py-2 rounded shadow flex items-center gap-1">
                                <i class="fa-solid fa-file-excel"></i> åŒ¯å‡ºæ‰“å¡ç´€éŒ„
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-60 overflow-y-auto custom-scrollbar">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-100 text-slate-500 text-xs">
                                <tr>
                                    <th class="p-2">å§“å</th>
                                    <th class="p-2">é¡å‹</th>
                                    <th class="p-2">æ™‚é–“</th>
                                    <th class="p-2">ç‹€æ…‹</th>
                                    <th class="p-2">å®šä½</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody" class="divide-y divide-slate-100 text-xs"></tbody>
                        </table>
                    </div>
                </div>

                <div class="lg:col-span-3 glass-panel p-6">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-users mr-1"></i> å“¡å·¥å…¨æ–¹ä½ç®¡ç† 
                        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded ml-2 font-normal">
                            <i class="fa-solid fa-scale-balanced mr-1"></i> ç¬¦åˆå‹åŸºæ³•é€±å¹´åˆ¶
                        </span>
                    </h2>
                    
                    <div class="flex flex-wrap gap-2 mb-4 bg-slate-50 p-3 rounded-lg border border-slate-200">
                        <input type="text" id="newAdminName" placeholder="æ–°é€²å“¡å·¥å§“å" class="flex-1 min-w-[120px] p-2 input-modern">
                        <select id="newAdminGender" class="w-20 p-2 input-modern"><option value="M">ç”·</option><option value="F">å¥³</option></select>
                        <div class="flex items-center gap-1">
                            <span class="text-xs text-slate-500">åˆ°è·:</span>
                            <input type="date" id="newAdminDate" class="w-36 p-2 input-modern">
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="text-xs text-slate-500">ç”Ÿæ—¥:</span>
                            <input type="date" id="newAdminBirthday" class="w-36 p-2 input-modern">
                        </div>
                        <button onclick="addEmployee()" class="bg-blue-600 text-white px-4 rounded font-bold hover:bg-blue-500">æ–°å¢</button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-100 text-slate-600 text-xs uppercase">
                                <tr>
                                    <th class="p-3">å§“å (å¯æ”¹)</th>
                                    <th class="p-3">è³‡æ–™ (åˆ°è·/è³‡æ­·/ç”Ÿæ—¥)</th>
                                    <th class="p-3">ç‰¹ä¼‘æ¦‚æ³ (ç¸½/ç”¨/å‰©)</th>
                                    <th class="p-3 w-1/4">è£ç½®</th>
                                    <th class="p-3 text-right">ç®¡ç†</th>
                                </tr>
                            </thead>
                            <tbody id="adminTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <div id="historyModal" class="modal-overlay">
            <div class="modal-content">
                <div class="p-4 border-b bg-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800 text-lg"><i class="fa-solid fa-sliders mr-2"></i> å‡å‹¤æ•¸æ“šä¸­æ§å° - <span id="modalEmpName"></span></h3>
                    <button onclick="closeHistory()" class="text-slate-500 hover:text-red-500 text-xl"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-6 overflow-y-auto flex-1 bg-slate-50">
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg border border-blue-200 shadow-sm relative overflow-hidden">
                            <div class="absolute top-0 right-0 bg-blue-100 text-blue-800 text-[10px] px-2 py-1 font-bold">ç‰¹ä¼‘ (Annual)</div>
                            <div class="mt-2 space-y-2">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-slate-500">å·²ä½¿ç”¨å¤©æ•¸</span>
                                    <input type="number" id="adjAnnualUsed" class="border rounded w-16 text-center font-bold text-blue-700" step="0.125">
                                </div>
                                <div class="text-xs text-slate-400 text-right">ç³»çµ±è‡ªå‹•ç´¯è¨ˆ</div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg border border-orange-200 shadow-sm relative overflow-hidden">
                            <div class="absolute top-0 right-0 bg-orange-100 text-orange-800 text-[10px] px-2 py-1 font-bold">è£œä¼‘ (Comp)</div>
                            <div class="mt-2 space-y-2">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-slate-500">ç›®å‰é¤˜é¡</span>
                                    <input type="number" id="adjCompBalance" class="border rounded w-16 text-center font-bold text-orange-700" step="0.125">
                                </div>
                                <div class="text-xs text-slate-400 text-right">ç®¡ç†è€…æ‰‹å‹•ç™¼æ”¾</div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm relative overflow-hidden">
                            <div class="absolute top-0 right-0 bg-gray-100 text-gray-800 text-[10px] px-2 py-1 font-bold">ç—…/äº‹å‡</div>
                            <div class="mt-2 space-y-1">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-slate-500">ç—…å‡å·²ç”¨</span>
                                    <input type="number" id="adjSickUsed" class="border rounded w-16 text-center font-bold text-gray-700" step="0.125">
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-slate-500">äº‹å‡å·²ç”¨</span>
                                    <input type="number" id="adjPersonalUsed" class="border rounded w-16 text-center font-bold text-gray-700" step="0.125">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="saveAllAdjustments()" class="w-full bg-slate-800 text-white py-2 rounded mb-6 font-bold hover:bg-slate-700 shadow-md">
                        <i class="fa-solid fa-save mr-1"></i> å„²å­˜æ‰€æœ‰ä¿®æ­£
                    </button>

                    <h4 class="font-bold text-slate-700 mb-2">ğŸ“œ æ­·å²ç”³è«‹ç´€éŒ„ (ç‰¹ä¼‘æœƒç‰¹åˆ¥æ¨™ç¤º)</h4>
                    <div class="overflow-x-auto bg-white rounded-lg border border-slate-200">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100 text-xs text-slate-500 uppercase">
                                <tr>
                                    <th class="p-2">æ—¥æœŸ</th>
                                    <th class="p-2">é¡å‹</th>
                                    <th class="p-2">å…§å®¹</th>
                                    <th class="p-2">ç‹€æ…‹</th>
                                    <th class="p-2">æ—¥æ›†</th>
                                    <th class="p-2">è¨»è¨˜</th>
                                    <th class="p-2 text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCcSH0HQutt6rYcFWjCKOpTSWkBDeinyvw",
            authDomain: "homego-system.firebaseapp.com",
            databaseURL: "https://homego-system-default-rtdb.firebaseio.com",
            projectId: "homego-system",
            storageBucket: "homego-system.firebasestorage.app",
            messagingSenderId: "679007509034",
            appId: "1:679007509034:web:df50010c5ab8cd7f964153"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const ADMIN_PASSWORD = "8888";

        let employees = {};
        let requests = {};
        let attendance = {};
        let taskOptions = []; 
        let bulletin = { title: "æ­¡è¿", content: "è³‡æ–™è®€å–ä¸­...", date: "" };
        let currentUserId = null;
        let currentDeduction = 0;
        let currentModalEmpId = null;
        let leaveMode = 'day'; // 'day' or 'time'

        const DEFAULT_TASKS = ["åœ°æ”¿éæˆ¶", "è²¸æ¬¾", "çµæ¡ˆè³‡æ–™æ•´ç†", "éæ°´é›»", "ç”¨å°", "å°ä¿", "å¡—éŠ·"];

        // --- Device Fingerprint ---
        let myDeviceId = localStorage.getItem('hge_security_did');
        if (!myDeviceId) {
            myDeviceId = 'DID-' + Math.random().toString(36).substr(2, 6).toUpperCase() + '-' + Date.now().toString(36).substr(-4);
            localStorage.setItem('hge_security_did', myDeviceId);
        }
        document.getElementById('myDeviceIdDisplay').innerText = myDeviceId;

        // --- Clock Logic ---
        const WORK_START = "08:30";
        const WORK_END = "18:00";

        function updateClockStatus() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW', {hour12: false});
            document.getElementById('liveClock').innerText = timeStr;

            const timeVal = now.getHours() * 60 + now.getMinutes();
            const startVal = 8 * 60 + 30; 
            const endVal = 18 * 60;       

            const badge = document.getElementById('clockStatusBadge');
            if (timeVal < startVal) {
                badge.className = "text-[10px] font-bold text-green-600 mt-1";
                badge.innerText = "æ—©å®‰ï¼æº–æ™‚æ‰“å¡";
            } else if (timeVal >= startVal && timeVal < endVal) {
                badge.className = "text-[10px] font-bold text-orange-600 mt-1";
                badge.innerText = "ä¸Šç­æ™‚é–“ (é²åˆ°åˆ¤å®šä¸­)";
            } else {
                badge.className = "text-[10px] font-bold text-purple-600 mt-1";
                badge.innerText = "ä¸‹ç­æ™‚é–“ (åŠ ç­åˆ¤å®šä¸­)";
            }
        }
        setInterval(updateClockStatus, 1000);

        window.toggleLegalInfo = () => {
            const card = document.getElementById('legalInfoCard');
            if(card.classList.contains('hidden')) {
                card.classList.remove('hidden'); card.classList.add('flex');
            } else {
                card.classList.add('hidden'); card.classList.remove('flex');
            }
        };

        // --- UI Navigation ---
        window.switchView = (view) => {
            document.getElementById('employeeView').classList.add('hidden-section');
            document.getElementById('adminView').classList.add('hidden-section');
            document.getElementById('loginSection').classList.add('hidden-section');
            const btnEmp = document.getElementById('btnEmp');
            const btnAdm = document.getElementById('btnAdm');

            if (view === 'employee') {
                document.getElementById('loginSection').classList.remove('hidden-section');
                currentUserId = null;
                updateEmpSelect();
                btnEmp.className = "px-4 py-1.5 rounded-full text-xs md:text-sm font-medium transition-all bg-white text-blue-900 shadow-sm";
                btnAdm.className = "px-4 py-1.5 rounded-full text-xs md:text-sm font-medium text-blue-200 hover:text-white transition-all";
            } else {
                document.getElementById('adminView').classList.remove('hidden-section');
                btnAdm.className = "px-4 py-1.5 rounded-full text-xs md:text-sm font-medium transition-all bg-white text-blue-900 shadow-sm";
                btnEmp.className = "px-4 py-1.5 rounded-full text-xs md:text-sm font-medium text-blue-200 hover:text-white transition-all";
            }
        };

        window.checkAdminLogin = async () => {
            const { value: pass } = await Swal.fire({
                title: 'ç®¡ç†å“¡é©—è­‰',
                input: 'password',
                inputPlaceholder: 'è«‹è¼¸å…¥å¯†ç¢¼',
                confirmButtonText: 'ç™»å…¥',
                confirmButtonColor: '#1e3a8a',
                showCancelButton: true
            });

            if (pass === ADMIN_PASSWORD) window.switchView('admin');
            else if (pass) Swal.fire('éŒ¯èª¤', 'å¯†ç¢¼ä¸æ­£ç¢º', 'error');
        };

        window.switchAppTab = (tab) => {
            document.getElementById('tab-leave').className = 'flex-1 py-2 text-center text-sm tab-inactive transition-colors';
            document.getElementById('tab-car').className = 'flex-1 py-2 text-center text-sm tab-inactive transition-colors';
            document.getElementById('tab-log').className = 'flex-1 py-2 text-center text-sm tab-inactive transition-colors';
            const activeClass = 'flex-1 py-2 text-center text-sm tab-active transition-colors';
            if(tab === 'log') document.getElementById('tab-log').className = activeClass + ' font-bold text-purple-600';
            else document.getElementById('tab-' + tab).className = activeClass;
            document.getElementById('form-leave').classList.add('hidden-section');
            document.getElementById('form-car').classList.add('hidden-section');
            document.getElementById('form-log').classList.add('hidden-section');
            document.getElementById(`form-${tab}`).classList.remove('hidden-section');
        };

        // --- Data Listeners ---
        onValue(ref(db), (snapshot) => {
            const data = snapshot.val() || {};
            employees = data.employees || {};
            requests = data.requests || {};
            attendance = data.attendance || {};
            bulletin = data.bulletin || { title: "å°šç„¡å…¬å‘Š", content: "", date: "" };
            
            const dbTasks = data.settings?.taskTypes || [];
            if (dbTasks.length === 0) {
                 set(ref(db, 'settings/taskTypes'), DEFAULT_TASKS);
                 taskOptions = DEFAULT_TASKS;
            } else {
                 taskOptions = dbTasks;
            }
            renderLogForm(); 
            checkBirthdayEvents();
            updateEmpSelect();
            renderBulletin();
            renderActivityFeed();
            
            if (currentUserId) {
                 const emp = employees[currentUserId];
                 if(emp) {
                    const calc = calculateLeave(emp.joinDate);
                    const used = emp.stats?.annual || 0; 
                    const comp = emp.stats?.comp || 0;
                    document.getElementById('dashboardRemaining').innerText = (calc.days - used) + " å¤©";
                    document.getElementById('dashboardTotal').innerText = calc.days + " å¤©";
                    document.getElementById('dashboardRule').innerText = calc.rule;
                    document.getElementById('dashboardComp').innerText = comp;
                    
                    // UPDATED: Bind Join Date & Tenure correctly
                    const tenure = calculateTenure(emp.joinDate);
                    document.getElementById('dashboardJoinDate').innerText = emp.joinDate || "æœªè¨­å®š";
                    document.getElementById('dashboardTenure').innerText = tenure;
                    
                    // Render Avatar
                    const avatarImg = document.getElementById('dashboardAvatarImg');
                    const avatarPlace = document.getElementById('dashboardAvatarPlaceholder');
                    if (emp.avatar) {
                        avatarImg.src = emp.avatar;
                        avatarImg.classList.remove('hidden');
                        avatarPlace.classList.add('hidden');
                    } else {
                        avatarImg.classList.add('hidden');
                        avatarPlace.classList.remove('hidden');
                    }
                 }
            }
            renderAdminTable();
            renderApprovalQueue();
            renderAttendanceLog();
            document.getElementById('empSelect').disabled = false;
        });

        function checkBirthdayEvents() {
            const today = new Date();
            const todayStr = (today.getMonth() + 1).toString().padStart(2, '0') + '-' + today.getDate().toString().padStart(2, '0');
            let birthdayBoys = [];
            Object.values(employees).forEach(emp => {
                if(emp.birthday && emp.birthday.slice(5) === todayStr) birthdayBoys.push(emp.name);
            });
            if(birthdayBoys.length > 0 && bulletin.date !== today.toLocaleDateString()) {
                set(ref(db, 'bulletin'), {
                    title: "ğŸ‚ ç”Ÿæ—¥å¿«æ¨‚ï¼",
                    content: `ä»Šå¤©æ˜¯ ${birthdayBoys.join(' & ')} çš„ç”Ÿæ—¥ï¼\nç¥ç¦å·¥ä½œé †åˆ©ï¼Œèº«é«”å¥åº·ï¼ğŸ‰`,
                    date: today.toLocaleDateString()
                });
            }
        }

        // --- Avatar Logic ---
        window.triggerAvatarUpload = () => {
            document.getElementById('avatarInput').click();
        };

        window.handleAvatarChange = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Resize to 300x300 for database efficiency
                    const MAX_WIDTH = 300;
                    const scaleSize = MAX_WIDTH / Math.max(img.width, img.height);
                    canvas.width = img.width * scaleSize;
                    canvas.height = img.height * scaleSize;
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Compress to JPEG 0.7 quality
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    
                    update(ref(db, `employees/${currentUserId}`), { avatar: dataUrl })
                        .then(() => Swal.fire('æˆåŠŸ', 'å¤§é ­ç…§å·²æ›´æ–°', 'success'));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        // --- Leave Time Calculation Logic (NEW) ---
        window.switchLeaveMode = (mode) => {
            leaveMode = mode;
            if(mode === 'day') {
                document.getElementById('btnModeDay').classList.add('leave-mode-active');
                document.getElementById('btnModeTime').classList.remove('leave-mode-active');
                document.getElementById('inputDayMode').classList.remove('hidden');
                document.getElementById('inputTimeMode').classList.add('hidden');
                document.getElementById('leaveDays').value = 1; 
            } else {
                document.getElementById('btnModeDay').classList.remove('leave-mode-active');
                document.getElementById('btnModeTime').classList.add('leave-mode-active');
                document.getElementById('inputDayMode').classList.add('hidden');
                document.getElementById('inputTimeMode').classList.remove('hidden');
                document.getElementById('inputTimeMode').classList.add('grid');
                window.calcTimeDiff();
            }
            window.updateImpactInfo();
        };

        window.calcTimeDiff = () => {
            const start = document.getElementById('leaveStartTime').value;
            const end = document.getElementById('leaveEndTime').value;
            if(!start || !end) return;

            const startDate = new Date(`2000-01-01T${start}`);
            const endDate = new Date(`2000-01-01T${end}`);
            let diffMs = endDate - startDate;
            if(diffMs < 0) diffMs = 0; // handle overnight or error

            const diffHours = diffMs / (1000 * 60 * 60);
            document.getElementById('timeDiffDisplay').innerText = diffHours.toFixed(2);
            
            // Convert to Days (assuming 8hr work day for calculation consistency)
            // Storing exact hours is better, but to keep system simple, we store "days equivalent"
            // 1 hour = 0.125 days
            const days = diffHours / 8;
            document.getElementById('leaveDays').value = days.toFixed(4); // precise for calculation
            window.updateImpactInfo();
        };

        // --- Work Log (LINE ONLY) ---
        function renderLogForm() {
            const container = document.getElementById('logEntriesContainer');
            if(!container) return;
            if (container.children.length > 1 && container.querySelector('select')) return;

            container.innerHTML = '';
            const timeSlots = ["09:00 ~ 10:00", "10:00 ~ 11:00", "11:00 ~ 12:00", "13:30 ~ 14:30", "14:30 ~ 15:30", "15:30 ~ 16:30", "16:30 ~ 17:30", "17:30 ~ 18:30"];
            timeSlots.forEach(slot => {
                let optionsHtml = '<option value="">-- é¸æ“‡é …ç›® --</option>';
                taskOptions.forEach(opt => optionsHtml += `<option value="${opt}">${opt}</option>`);
                container.innerHTML += `
                    <div class="bg-white p-2 rounded border border-slate-200 flex flex-col md:flex-row gap-2 items-center shadow-sm">
                        <div class="text-xs font-bold text-slate-500 w-full md:w-24 bg-slate-50 p-1.5 rounded text-center">${slot}</div>
                        <select name="logTask" class="flex-1 p-1.5 text-sm border rounded w-full md:w-auto outline-none focus:border-blue-500">${optionsHtml}</select>
                        <input type="text" name="logDetail" class="flex-1 p-1.5 text-sm border rounded w-full md:w-auto outline-none focus:border-blue-500" placeholder="æ¡ˆä»¶æ—¥æœŸ / å®¢æˆ¶åç¨±">
                        <input type="hidden" name="logTime" value="${slot}">
                    </div>`;
            });
        }

        window.handleLogSubmit = (e) => {
            e.preventDefault();
            if (!currentUserId) return;
            const emp = employees[currentUserId];
            const date = document.getElementById('logDate').value;
            
            const entries = [];
            const rows = document.querySelectorAll('#logEntriesContainer > div');
            
            rows.forEach(row => {
                const time = row.querySelector('[name="logTime"]').value;
                const task = row.querySelector('[name="logTask"]').value;
                const detail = row.querySelector('[name="logDetail"]').value.trim();
                
                if (task) {
                    entries.push(`${time} ã€${task}ã€‘ ${detail}`);
                }
            });

            if (entries.length === 0) return Swal.fire('å…§å®¹ç©ºç™½', 'è«‹è‡³å°‘å¡«å¯«ä¸€å€‹æ™‚æ®µçš„å·¥ä½œå…§å®¹', 'warning');

            let msg = `ã€å·¥ä½œæ—¥èªŒã€‘${emp.name}\nğŸ“… æ—¥æœŸï¼š${date}\n------------------\n`;
            msg += entries.join('\n');
            msg += `\n------------------\n(Nexus V5.17 ç”Ÿæˆ)`;

            window.open('https://line.me/R/msg/text/?' + encodeURIComponent(msg));
        };

        // --- Google Calendar Sync Utility ---
        window.getGoogleCalendarUrl = (reqId) => {
            const req = requests[reqId];
            if(!req) return '#';
            let title = "", details = "", start = "", end = "";
            if(req.category === 'car') {
                title = `å…¬å‹™è»Šé ç´„: ${req.empName}`;
                details = `ç›®çš„åœ°: ${req.location}`;
                start = `${req.date}T${req.time.replace(':','')}:00`.replace(/-|:/g,"");
                end = start; // Simple point event
            } else {
                title = `è«‹å‡: ${req.empName} (${req.type})`;
                details = `åŸå› : ${req.reason}`;
                // Handle new Time Range logic in calendar
                if (req.timeStart && req.timeEnd) {
                    start = `${req.date}T${req.timeStart.replace(':','')}:00`.replace(/-|:/g,"");
                    end = `${req.date}T${req.timeEnd.replace(':','')}:00`.replace(/-|:/g,"");
                } else {
                    start = req.date.replace(/-|:/g,"");
                    end = start;
                }
            }
            return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${start}/${end}&details=${encodeURIComponent(details)}`;
        };

        // --- Device Binding & Login ---
        function updateEmpSelect() {
            const select = document.getElementById('empSelect');
            select.innerHTML = '';
            let boundUser = null;
            Object.values(employees).forEach(emp => {
                if (emp.devices && emp.devices.includes(myDeviceId)) boundUser = emp;
            });

            if (boundUser) {
                select.innerHTML = `<option value="${boundUser.id}">ğŸ”’ å·²ç¶å®šèº«åˆ†ï¼š${boundUser.name}</option>`;
                select.value = boundUser.id;
                if (!document.getElementById('loginSection').classList.contains('hidden-section')) {
                     document.getElementById('loginStatusMsg').classList.remove('hidden');
                     setTimeout(() => loadEmployeeDashboard(boundUser.id), 800);
                }
            } else {
                select.innerHTML = '<option value="">-- è«‹é¸æ“‡æ‚¨çš„å§“å (é¦–æ¬¡éœ€ç¶å®š) --</option>';
                Object.values(employees).forEach(emp => {
                    select.innerHTML += `<option value="${emp.id}">${emp.name}</option>`;
                });
            }
        }

        window.tryBindAndLogin = () => {
            const id = document.getElementById('empSelect').value;
            if (!id) return;
            const emp = employees[id];
            const currentDevices = emp.devices || [];

            if (currentDevices.includes(myDeviceId)) { loadEmployeeDashboard(id); return; }
            if (currentDevices.length >= 3) {
                Swal.fire({ icon: 'error', title: 'ç¶å®šå¤±æ•—', text: 'æ‚¨çš„å¸³è™Ÿå·²ç¶å®š 3 å°è£ç½® (ä¸Šé™)ã€‚è«‹è¯ç¹«ç®¡ç†å“¡è§£ç¶ã€‚' });
                document.getElementById('empSelect').value = ""; return;
            }

            Swal.fire({
                title: 'è£ç½®ç¶å®šç¢ºèª',
                html: `å³å°‡ç¶å®šæ­¤è£ç½®ç‚º <b>${emp.name}</b> çš„å°ˆç”¨è¨­å‚™ã€‚<br>ç›®å‰å·²ç”¨é¡åº¦: ${currentDevices.length}/3`,
                icon: 'warning', showCancelButton: true, confirmButtonText: 'ç¢ºèªç¶å®š'
            }).then((result) => {
                if (result.isConfirmed) {
                    const newDevices = [...currentDevices, myDeviceId];
                    update(ref(db, `employees/${id}`), { devices: newDevices }).then(() => {
                        Swal.fire('æˆåŠŸ', 'è£ç½®å·²ç¶å®š', 'success'); loadEmployeeDashboard(id);
                    });
                } else { document.getElementById('empSelect').value = ""; }
            });
        };

        window.loadEmployeeDashboard = (forcedId) => {
            const id = forcedId || document.getElementById('empSelect').value;
            if (!id) return;
            currentUserId = id;
            const emp = employees[id];
            if (emp) {
                document.getElementById('dashboardName').innerText = emp.name;
                document.getElementById('loginSection').classList.add('hidden-section');
                document.getElementById('employeeView').classList.remove('hidden-section');
                window.calculateOvertime(); window.updateImpactInfo();
            }
        };

        window.handlePunch = (type) => {
            if (!currentUserId || !navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition((position) => {
                const now = new Date();
                let status = "æ­£å¸¸";
                const nowMinutes = now.getHours() * 60 + now.getMinutes();
                if (type === 'ä¸Šç­' && nowMinutes > (8 * 60 + 30)) status = "é²åˆ°";
                if (type === 'ä¸‹ç­' && nowMinutes > (18 * 60)) status = "åŠ ç­";

                push(ref(db, 'attendance'), {
                    empId: currentUserId, empName: employees[currentUserId].name, type: type, timestamp: now.getTime(),
                    dateStr: now.toLocaleDateString(), timeStr: now.toLocaleTimeString(),
                    location: `${position.coords.latitude}, ${position.coords.longitude}`,
                    mapLink: `https://www.google.com/maps?q=${position.coords.latitude},${position.coords.longitude}`,
                    status: status
                });
                Swal.fire('æ‰“å¡æˆåŠŸ', `${type} @ ${now.toLocaleTimeString()}`, 'success');
            });
        };

        // --- Salary & Impact ---
        window.updateSalaryFromSlider = (val) => {
            document.getElementById('monthlySalary').value = val;
            document.getElementById('displaySalary').innerText = parseInt(val).toLocaleString();
            calculateOvertime(); updateImpactInfo();
        };
        window.updateSalaryFromInput = (val) => {
            document.getElementById('salarySlider').value = val;
            document.getElementById('displaySalary').innerText = parseInt(val).toLocaleString();
            calculateOvertime(); updateImpactInfo();
        };

        window.calculateOvertime = () => {
            const salary = parseInt(document.getElementById('monthlySalary').value) || 0;
            const hourlyRate = Math.round(salary / 240);
            const h1 = parseFloat(document.getElementById('calcHours1').value);
            const h2 = parseFloat(document.getElementById('calcHours2').value);
            const otTotal = Math.round((h1 * hourlyRate * 1.34) + (h2 * hourlyRate * 1.67));
            document.getElementById('calcHours1Val').innerText = h1;
            document.getElementById('calcHours2Val').innerText = h2;
            document.getElementById('calcOtTotal').innerText = otTotal.toLocaleString();
            document.getElementById('calcDeduction').innerText = currentDeduction.toLocaleString();
            document.getElementById('calcFinalTotal').innerText = (salary + otTotal - currentDeduction).toLocaleString();
        };

        window.updateImpactInfo = () => {
            const type = document.getElementById('leaveType').value;
            const days = parseFloat(document.getElementById('leaveDays').value) || 0;
            const salary = parseInt(document.getElementById('monthlySalary').value) || 30000;
            const dailyRate = Math.round(salary / 30);
            const card = document.getElementById('impactCard');
            let deduction = 0;

            card.classList.remove('impact-full', 'impact-half', 'impact-none');
            if (['ç‰¹ä¼‘','è£œä¼‘','å©šå‡'].includes(type)) {
                card.classList.add('impact-full'); document.getElementById('impactTitle').innerText = "å…¨è–ª";
            } else if (type === 'ç—…å‡') {
                card.classList.add('impact-half'); document.getElementById('impactTitle').innerText = "åŠè–ª";
                deduction = Math.round(dailyRate * days * 0.5);
            } else {
                card.classList.add('impact-none'); document.getElementById('impactTitle').innerText = "ç„¡è–ª";
                deduction = Math.round(dailyRate * days);
            }
            document.getElementById('impactAmount').innerText = deduction.toLocaleString();
            currentDeduction = deduction; window.calculateOvertime();
        };

        // --- Submissions ---
        window.handleLeaveSubmit = (e) => {
            e.preventDefault();
            const type = document.getElementById('leaveType').value;
            const days = parseFloat(document.getElementById('leaveDays').value);
            const date = document.getElementById('leaveDate').value;
            const reason = document.getElementById('leaveReason').value;
            
            // Collect Time Range Data
            let timeStart = null;
            let timeEnd = null;
            let timeStr = "";
            
            if(leaveMode === 'time') {
                timeStart = document.getElementById('leaveStartTime').value;
                timeEnd = document.getElementById('leaveEndTime').value;
                if(!timeStart || !timeEnd) return Swal.fire('è«‹å¡«å¯«æ™‚é–“', 'å°æ™‚æ¨¡å¼éœ€å¡«å¯«é–‹å§‹èˆ‡çµæŸæ™‚é–“', 'warning');
                timeStr = `(${timeStart} ~ ${timeEnd})`;
            }

            push(ref(db, 'requests'), {
                empId: currentUserId, empName: employees[currentUserId].name, category: 'leave',
                type, date, days, reason, 
                timeStart, timeEnd, // Save specific times
                status: 'pending', timestamp: Date.now()
            });
            const msg = `ã€è«‹å‡ç”³è«‹ã€‘\nğŸ‘¤ ${employees[currentUserId].name}\nğŸ“… ${date} ${timeStr}\nâ³ å…± ${days} å¤© (æˆ–æ™‚æ•¸æ›ç®—)\nğŸ·ï¸ ${type}\nğŸ“ ${reason}`;
            window.open('https://line.me/R/msg/text/?' + encodeURIComponent(msg));
            Swal.fire('å·²é€å‡º', 'ç”³è«‹å·²æäº¤', 'success');
        };

        window.handleCarSubmit = (e) => {
            e.preventDefault();
            const date = document.getElementById('carDate').value;
            const time = document.getElementById('carTime').value;
            const location = document.getElementById('carLocation').value;

            push(ref(db, 'requests'), {
                empId: currentUserId, empName: employees[currentUserId].name, category: 'car',
                date, time, location, status: 'pending', timestamp: Date.now()
            });
            const msg = `ã€å…¬å‹™è»Šé ç´„ã€‘\nğŸ‘¤ ${employees[currentUserId].name}\nğŸ“… ${date} ${time}\nğŸ“ ${location}`;
            window.open('https://line.me/R/msg/text/?' + encodeURIComponent(msg));
            Swal.fire('å·²é€å‡º', 'ç”³è«‹å·²æäº¤', 'success');
        };

        // --- Admin Processing ---
        window.processRequest = (reqId, action) => {
            const req = requests[reqId];
            if (!req) return;
            const actionText = action === 'approve' ? 'æ‰¹å‡†' : 'é§å›';
            
            Swal.fire({
                title: `ç¢ºèª${actionText}?`,
                text: `${req.empName} çš„ ${req.category==='car'?'ç”¨è»Š':'è«‹å‡'} ç”³è«‹`,
                icon: 'question', showCancelButton: true
            }).then((result) => {
                if (result.isConfirmed) {
                    if (action === 'approve' && req.category === 'leave') {
                        const emp = employees[req.empId];
                        const stats = emp.stats || { annual: 0, comp: 0, sick: 0, personal: 0 };
                        if (req.type === 'ç‰¹ä¼‘') stats.annual += req.days;
                        if (req.type === 'è£œä¼‘') stats.comp -= req.days;
                        if (req.type === 'ç—…å‡') stats.sick += req.days;
                        if (req.type === 'äº‹å‡') stats.personal += req.days;
                        update(ref(db, `employees/${req.empId}`), { stats: stats });
                    }
                    
                    update(ref(db, `requests/${reqId}`), { status: action === 'approve' ? 'approved' : 'rejected' }).then(() => {
                        if(action === 'approve') {
                            const calUrl = window.getGoogleCalendarUrl(reqId);
                            Swal.fire({
                                title: 'å·²æ‰¹å‡†',
                                html: `<p class="mb-4">ç”³è«‹å·²é€šéã€‚ä¸»ç®¡å¯é»æ“Šä¸‹æ–¹æŒ‰éˆ•åŒæ­¥è‡³è¡Œäº‹æ›†ï¼š</p>
                                       <a href="${calUrl}" target="_blank" class="block w-full bg-blue-600 text-white font-bold py-3 rounded-lg"><i class="fa-regular fa-calendar-plus mr-1"></i> åŠ å…¥è¡Œäº‹æ›†</a>`,
                                icon: 'success'
                            });
                        } else { Swal.fire('å·²é§å›', '', 'info'); }
                    });
                }
            });
        };

        // --- Admin Core Helpers ---
        window.openHistory = (empId) => {
            currentModalEmpId = empId;
            const emp = employees[empId];
            document.getElementById('modalEmpName').innerText = emp.name;
            const stats = emp.stats || { annual: 0, comp: 0, sick: 0, personal: 0 };
            document.getElementById('adjAnnualUsed').value = stats.annual;
            document.getElementById('adjCompBalance').value = stats.comp;
            document.getElementById('adjSickUsed').value = stats.sick;
            document.getElementById('adjPersonalUsed').value = stats.personal;
            
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            const myHistory = Object.entries(requests).map(([k, v]) => ({...v, id: k})).filter(r => r.empId === empId).sort((a,b) => b.timestamp - a.timestamp);
            myHistory.forEach(r => {
                const calBtn = r.status === 'approved' ? `<a href="${window.getGoogleCalendarUrl(r.id)}" target="_blank" class="text-blue-500"><i class="fa-regular fa-calendar-plus"></i></a>` : '-';
                tbody.innerHTML += `
                    <tr class="border-b text-xs">
                        <td class="p-2">${r.date}</td>
                        <td class="p-2">${r.category==='car'?'ç”¨è»Š':r.type}</td>
                        <td class="p-2">${r.category==='car'?r.location:(r.timeStart ? r.days.toFixed(2)+'å¤©' : r.days+'å¤©')}</td>
                        <td class="p-2 font-bold ${r.status==='approved'?'text-green-600':'text-orange-500'}">${r.status}</td>
                        <td class="p-2 text-center">${calBtn}</td>
                        <td class="p-2">--</td>
                        <td class="p-2 text-right"><button onclick="deleteHistoryItem('${r.id}')" class="text-red-400"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>`;
            });
            document.getElementById('historyModal').style.display = 'flex';
        };

        window.closeHistory = () => { document.getElementById('historyModal').style.display = 'none'; };

        window.saveAllAdjustments = () => {
            const stats = {
                annual: parseFloat(document.getElementById('adjAnnualUsed').value) || 0,
                comp: parseFloat(document.getElementById('adjCompBalance').value) || 0,
                sick: parseFloat(document.getElementById('adjSickUsed').value) || 0,
                personal: parseFloat(document.getElementById('adjPersonalUsed').value) || 0
            };
            update(ref(db, `employees/${currentModalEmpId}`), { stats: stats }).then(() => Swal.fire('ä¿®æ­£æˆåŠŸ', '', 'success'));
        };

        window.deleteHistoryItem = (id) => { remove(ref(db, `requests/${id}`)).then(() => openHistory(currentModalEmpId)); };
        window.saveBulletin = () => {
            set(ref(db, 'bulletin'), {
                title: document.getElementById('adminBulletinTitle').value,
                content: document.getElementById('adminBulletinContent').value,
                date: new Date().toLocaleDateString()
            });
            Swal.fire('å…¬å‘Šå·²æ›´æ–°');
        };

        window.addEmployee = () => {
            const name = document.getElementById('newAdminName').value;
            const date = document.getElementById('newAdminDate').value;
            if(!name || !date) return;
            const newRef = push(ref(db, 'employees'));
            set(newRef, { 
                id: newRef.key, name, gender: document.getElementById('newAdminGender').value,
                joinDate: date, birthday: document.getElementById('newAdminBirthday').value,
                devices: [], stats: {annual:0, comp:0, sick:0, personal:0}
            });
            Swal.fire('å“¡å·¥å·²æ–°å¢');
        };

        window.unbindDevice = (id, idx) => {
            const newDevices = [...employees[id].devices];
            newDevices.splice(idx, 1);
            update(ref(db, `employees/${id}`), { devices: newDevices });
        };

        // --- Render Helpers ---
        function renderApprovalQueue() {
            const tbody = document.getElementById('approvalTableBody');
            const pending = Object.entries(requests).map(([k,v])=>({...v,id:k})).filter(r=>r.status==='pending');
            tbody.innerHTML = '';
            document.getElementById('pendingCountBadge').innerText = pending.length;
            document.getElementById('pendingCountBadge').classList.toggle('hidden', pending.length===0);
            document.getElementById('noPendingMsg').classList.toggle('hidden', pending.length>0);
            pending.forEach(r => {
                const detail = r.category==='car' ? r.location : (r.timeStart ? `${r.timeStart}~${r.timeEnd} (${r.days.toFixed(2)}å¤©)` : `${r.days}å¤©`);
                tbody.innerHTML += `
                    <tr class="bg-white border-b">
                        <td class="p-3 font-bold">${r.empName}</td>
                        <td class="p-3">${r.category==='car'?'å…¬å‹™è»Š':r.type}<br><span class="text-[10px] text-slate-400">${r.date}</span></td>
                        <td class="p-3 text-xs">${detail} | ${r.reason||''}</td>
                        <td class="p-3 text-right">
                            <button onclick="processRequest('${r.id}','approve')" class="text-green-600 mx-1"><i class="fa-solid fa-check"></i></button>
                            <button onclick="processRequest('${r.id}','reject')" class="text-red-600 mx-1"><i class="fa-solid fa-xmark"></i></button>
                        </td>
                    </tr>`;
            });
        }

        // UPDATED: Calculate Tenure
        function calculateTenure(dateString) {
            if(!dateString) return "æœªè¨­å®š";
            const now = new Date();
            const join = new Date(dateString);
            let months = (now.getFullYear() - join.getFullYear()) * 12;
            months -= join.getMonth();
            months += now.getMonth();
            if (now.getDate() < join.getDate()) months--; 
            if (months < 0) return "å³å°‡åˆ°è·";
            const y = Math.floor(months / 12);
            const m = months % 12;
            if (y === 0 && m === 0) return "æœªæ»¿æœˆ";
            let result = "";
            if (y > 0) result += `${y}å¹´ `;
            if (m > 0) result += `${m}å€‹æœˆ`;
            return result.trim();
        }

        // FIXED: Admin Table Rendering matching Screenshot
        function renderAdminTable() {
            const tbody = document.getElementById('adminTableBody');
            tbody.innerHTML = '';
            Object.values(employees).forEach(emp => {
                const devs = (emp.devices || []).map((d,i)=>`<span class="device-badge cursor-pointer hover:bg-red-100" onclick="unbindDevice('${emp.id}',${i})">ğŸ“± ${d.substr(0,4)}</span>`).join(' ');
                const calc = calculateLeave(emp.joinDate);
                const stats = emp.stats || {annual:0};
                const tenure = calculateTenure(emp.joinDate);
                
                // Show avatar in admin list if exists
                const avatarHTML = emp.avatar 
                    ? `<img src="${emp.avatar}" class="w-8 h-8 rounded-full border border-slate-200 object-cover mr-2 inline-block">` 
                    : `<div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-xs mr-2 inline-block">ğŸ‘¤</div>`;

                // Layout matching Image 1
                tbody.innerHTML += `
                    <tr class="border-b text-sm">
                        <td class="p-3 font-bold text-slate-800 flex items-center">
                            ${avatarHTML}
                            ${emp.name}
                        </td>
                        <td class="p-3">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-slate-400 text-xs">åˆ°è·:</span> 
                                <span class="font-medium text-slate-700">${emp.joinDate || '--'}</span>
                                <span class="bg-slate-100 text-slate-500 text-[10px] px-2 py-0.5 rounded font-bold">${tenure}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-slate-400 text-xs">ç”Ÿæ—¥:</span> 
                                <span class="text-slate-600">${emp.birthday || '--'}</span>
                            </div>
                        </td>
                        <td class="p-3">ç¸½:${calc.days} | ç”¨:${stats.annual} | å‰©:${calc.days-stats.annual}</td>
                        <td class="p-3">${devs || 'æœªç¶å®š'}</td>
                        <td class="p-3 text-right"><button onclick="openHistory('${emp.id}')" class="text-blue-600"><i class="fa-solid fa-pen-to-square"></i></button></td>
                    </tr>`;
            });
        }

        function renderBulletin() {
            document.getElementById('displayBulletinTitle').innerText = bulletin.title;
            document.getElementById('displayBulletinContent').innerText = bulletin.content;
            document.getElementById('displayBulletinDate').innerText = bulletin.date;
        }

        function renderActivityFeed() {
            const feed = document.getElementById('activityFeed');
            const approved = Object.values(requests).filter(r=>r.status==='approved' && new Date(r.date) >= new Date().setHours(0,0,0,0)).sort((a,b)=>new Date(a.date)-new Date(b.date));
            if(approved.length===0) { feed.innerHTML='<div class="p-4 text-center text-xs text-slate-400">ç›®å‰ç„¡å‹•æ…‹</div>'; return; }
            feed.innerHTML = approved.map(r=>`
                <div class="p-3 border-b text-xs flex justify-between">
                    <span><b>${r.empName}</b>: ${r.category==='car'?'ç”¨è»Š':r.type}</span>
                    <span class="text-slate-400">${r.date.slice(5)}</span>
                </div>`).join('');
        }

        function renderAttendanceLog() {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = Object.values(attendance).sort((a,b)=>b.timestamp-a.timestamp).slice(0,30).map(l=>`
                <tr class="border-b">
                    <td class="p-2">${l.empName}</td>
                    <td class="p-2 ${l.type==='ä¸Šç­'?'text-blue-600':'text-orange-600'}">${l.type}</td>
                    <td class="p-2">${l.dateStr} ${l.timeStr}</td>
                    <td class="p-2">${l.status||'æ­£å¸¸'}</td>
                    <td class="p-2"><a href="${l.mapLink}" target="_blank" class="text-blue-400"><i class="fa-solid fa-map-pin"></i></a></td>
                </tr>`).join('');
        }

        function calculateLeave(joinDate) {
            const years = (new Date() - new Date(joinDate)) / (1000*60*60*24*365.25);
            let d = 0, r = "";
            if(years<0.5) d=0; else if(years<1) d=3; else if(years<2) d=7; else if(years<3) d=10; else if(years<5) d=14; else if(years<10) d=15; else d=Math.min(30, 15+Math.floor(years-10));
            return { days: d, rule: "å‹åŸºæ³•é€±å¹´åˆ¶" };
        }

        document.getElementById('leaveDate').valueAsDate = new Date();
        document.getElementById('carDate').valueAsDate = new Date();
        document.getElementById('logDate').valueAsDate = new Date();
    </script>
</body>
</html>