<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®åœ‹åœ°æ”¿|æ˜“ä¸åœ°æ”¿ - æ™ºæ…§æŒ‡æ®è‰™ (Nexus V5.3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .serif { font-family: 'Noto Serif TC', serif; }
        .brand-bg { background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%); } 
        .text-brand-gold { color: #facc15; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-radius: 1rem; transition: all 0.3s ease; }
        .input-modern { background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.5rem; transition: all 0.2s; }
        .input-modern:focus { background: #fff; border-color: #2563eb; outline: none; }
        .hidden-section { display: none; }
        
        .fade-in-up { animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* è–ªè³‡æ‹‰æ¢ */
        input[type=range] {
            -webkit-appearance: none; width: 100%; height: 6px; border-radius: 5px;
            background: #cbd5e1; outline: none; margin: 10px 0;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; 
            background: #2563eb; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        /* è–ªè³‡å½±éŸ¿æç¤ºå¡ */
        .impact-card { transition: all 0.3s ease; border-left: 4px solid; background-color: white; border: 1px solid #e2e8f0; }
        .impact-full { border-left-color: #22c55e; background-color: #f0fdf4; } 
        .impact-half { border-left-color: #f97316; background-color: #fff7ed; } 
        .impact-none { border-left-color: #ef4444; background-color: #fef2f2; } 

        .btn-punch:active { transform: scale(0.95); }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: bold; }
        .tab-inactive { color: #64748b; }
        .device-badge { font-family: monospace; font-size: 0.7rem; background: #e2e8f0; padding: 2px 6px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px; }

        /* Modal Overlay */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 95%; max-width: 900px; max-height: 90vh; border-radius: 1rem; padding: 0; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="brand-bg text-white sticky top-0 z-50 shadow-md">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white text-blue-900 rounded-lg flex items-center justify-center font-bold text-lg serif shadow-lg">å®</div>
                <div>
                    <h1 class="text-base md:text-lg font-bold tracking-wider serif">å®åœ‹åœ°æ”¿ | æ˜“ä¸åœ°æ”¿</h1>
                    <p class="text-[10px] text-blue-200 tracking-widest uppercase">Nexus V5.3 (Audit & Export)</p>
                </div>
            </div>
            <div class="flex bg-blue-900/50 rounded-full p-1">
                <button onclick="switchView('employee')" id="btnEmp" class="px-4 py-1.5 rounded-full text-xs md:text-sm font-medium transition-all bg-white text-blue-900 shadow-sm">åŒä»å°ˆå€</button>
                <button onclick="checkAdminLogin()" id="btnAdm" class="px-4 py-1.5 rounded-full text-xs md:text-sm font-medium text-blue-200 hover:text-white transition-all">ç®¡ç†å¾Œå°</button>
            </div>
        </div>
    </header>

    <main class="flex-grow p-4 md:p-6 max-w-7xl mx-auto w-full">
        <section id="loginSection" class="w-full glass-panel p-10 text-center max-w-lg mx-auto mt-12 fade-in-up">
            <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-2xl"><i class="fa-solid fa-mobile-screen-button"></i></div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">è£ç½®é©—è­‰ç³»çµ±</h2>
            <p class="text-slate-500 mb-4 text-sm">ç³»çµ±å°‡è‡ªå‹•è­˜åˆ¥æ‚¨çš„è£ç½®æ¬Šé™</p>
            
            <div class="bg-slate-100 p-2 rounded mb-6 text-xs text-slate-400 font-mono">
                æœ¬æ©Ÿ ID: <span id="myDeviceIdDisplay">åµæ¸¬ä¸­...</span>
            </div>

            <select id="empSelect" onchange="tryBindAndLogin()" class="w-full p-3 pl-4 text-lg input-modern cursor-pointer text-center font-bold text-slate-700 disabled:opacity-50 mb-4" disabled>
                <option value="">-- è³‡æ–™è¼‰å…¥ä¸­ --</option>
            </select>

            <div id="loginStatusMsg" class="text-sm text-blue-600 font-bold hidden">
                <i class="fa-solid fa-spinner fa-spin"></i> æ­£åœ¨é©—è­‰è£ç½®å®‰å…¨æ€§...
            </div>
        </section>

        <section id="employeeView" class="w-full space-y-6 hidden-section">
            <div class="brand-bg rounded-2xl p-6 text-white relative overflow-hidden shadow-xl fade-in-up">
                <div class="relative z-10 flex flex-col md:flex-row items-start gap-4">
                    <div class="bg-white/10 p-3 rounded-xl backdrop-blur-sm shrink-0"><i class="fa-solid fa-bullhorn text-brand-gold text-xl"></i></div>
                    <div class="w-full">
                        <div class="flex justify-between items-start">
                            <h3 id="displayBulletinTitle" class="font-bold text-lg text-brand-gold mb-1">...</h3>
                            <span id="displayBulletinDate" class="text-[10px] bg-black/20 px-2 py-1 rounded text-slate-300">--/--</span>
                        </div>
                        <p id="displayBulletinContent" class="text-slate-200 text-sm leading-relaxed whitespace-pre-wrap">...</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="glass-panel p-6 border-l-4 border-blue-600 fade-in-up relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-blue-50 px-4 py-2 rounded-bl-xl border-b border-l border-blue-100 shadow-sm">
                             <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider text-right">NOW</div>
                             <div class="text-xl font-black text-blue-700 font-mono" id="liveClock">00:00:00</div>
                        </div>

                        <div class="flex justify-between items-center mb-8 mt-2">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2 text-lg">
                                <i class="fa-solid fa-location-dot text-blue-600"></i> å®šä½æ‰“å¡
                            </h3>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="handlePunch('ä¸Šç­')" class="btn-punch flex flex-col items-center justify-center p-4 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl shadow-lg shadow-blue-500/30 hover:shadow-xl">
                                <i class="fa-solid fa-sun text-2xl mb-2"></i><span class="font-bold">ä¸Šç­æ‰“å¡</span>
                            </button>
                            <button onclick="handlePunch('ä¸‹ç­')" class="btn-punch flex flex-col items-center justify-center p-4 bg-gradient-to-br from-orange-400 to-red-500 text-white rounded-xl shadow-lg shadow-orange-500/30 hover:shadow-xl">
                                <i class="fa-solid fa-moon text-2xl mb-2"></i><span class="font-bold">ä¸‹ç­æ‰“å¡</span>
                            </button>
                        </div>
                    </div>

                    <div class="glass-panel p-6 border-t-4 border-brand-gold fade-in-up">
                        <div class="flex border-b border-gray-200 mb-4">
                            <button class="w-1/2 py-2 text-center text-sm tab-active" id="tab-leave" onclick="switchAppTab('leave')">è«‹å‡ç”³è«‹</button>
                            <button class="w-1/2 py-2 text-center text-sm tab-inactive" id="tab-car" onclick="switchAppTab('car')">å…¬å‹™è»Šé ç´„</button>
                        </div>

                        <form id="form-leave" onsubmit="handleLeaveSubmit(event)" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">å‡åˆ¥</label>
                                    <select id="leaveType" class="w-full p-2.5 input-modern" onchange="updateImpactInfo()">
                                        <option value="ç‰¹ä¼‘">ç‰¹ä¼‘ (å…¨è–ª)</option>
                                        <option value="ç—…å‡">ç—…å‡ (åŠè–ª)</option>
                                        <option value="äº‹å‡">äº‹å‡ (ç„¡è–ª)</option>
                                        <option value="è£œä¼‘">è£œä¼‘ (å…¨è–ª)</option>
                                        <option value="å©šå‡">å©šå‡ (å…¨è–ª)</option>
                                    </select>
                                </div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">æ—¥æœŸ</label><input type="date" id="leaveDate" class="w-full p-2.5 input-modern"></div>
                                <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 mb-1">å¤©æ•¸</label><input type="number" id="leaveDays" min="0.5" step="0.5" value="1" class="w-full p-2.5 input-modern" oninput="updateImpactInfo()"></div>
                                <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 mb-1">äº‹ç”±</label><input type="text" id="leaveReason" class="w-full p-2.5 input-modern" placeholder="ä¾‹ï¼šè™•ç†ç§äººäº‹å‹™"></div>
                            </div>
                            
                            <div id="impactCard" class="impact-card impact-full p-4 rounded-lg flex justify-between items-center mt-2">
                                <div>
                                    <div class="font-bold text-sm text-slate-700" id="impactTitle">å…¨è–ª</div>
                                    <div class="text-xs text-slate-500" id="impactDesc">å·¥è³‡ç…§çµ¦ï¼Œä¸æ‰£ç™¼è–ªè³‡ã€‚</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-slate-400">é ä¼°æ‰£è–ª</div>
                                    <div class="font-bold text-lg text-red-500">$<span id="impactAmount">0</span></div>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-[#06c755] hover:bg-[#05b34c] text-white font-bold py-3 rounded-lg shadow-lg transition flex justify-center items-center gap-2"><i class="fa-brands fa-line"></i> é€å‡ºä¸¦é€šçŸ¥ LINE ç¾¤çµ„</button>
                        </form>

                        <form id="form-car" onsubmit="handleCarSubmit(event)" class="space-y-4 hidden-section">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">é ç´„æ—¥æœŸ</label><input type="date" id="carDate" class="w-full p-2.5 input-modern"></div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">æ™‚é–“</label><input type="time" id="carTime" class="w-full p-2.5 input-modern"></div>
                                <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 mb-1">åœ°é» / ç”¨é€”</label><input type="text" id="carLocation" class="w-full p-2.5 input-modern" placeholder="ä¾‹ï¼šå‰å¾€å¸‚æ”¿åºœæ´½å…¬"></div>
                            </div>
                            <div class="bg-blue-50 text-blue-700 text-xs p-3 rounded">
                                <i class="fa-solid fa-circle-info mr-1"></i> å…¬å‹™è»Šéœ€ç¶“ç®¡ç†å“¡å¯©æ ¸ã€‚
                            </div>
                            <button type="submit" class="w-full bg-[#06c755] hover:bg-[#05b34c] text-white font-bold py-3 rounded-lg shadow-lg transition flex justify-center items-center gap-2"><i class="fa-brands fa-line"></i> é€å‡ºä¸¦é€šçŸ¥ LINE ç¾¤çµ„</button>
                        </form>
                    </div>

                    <div class="glass-panel p-6 fade-in-up">
                        <h3 class="font-bold text-slate-700 mb-4 text-sm uppercase tracking-wider">æœ€è¿‘ç”³è«‹ç´€éŒ„</h3>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left"><tbody id="myRequestsTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                </div>

                <div class="space-y-6 lg:col-span-1">
                    <div class="glass-panel p-6 bg-slate-900 text-white fade-in-up">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold flex items-center gap-2"><i class="fa-solid fa-calculator text-brand-gold"></i> è–ªè³‡è©¦ç®—å„€è¡¨</h3></div>
                        
                        <div class="space-y-6">
                            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                                <label class="flex justify-between text-xs text-slate-400 mb-2">
                                    <span>è¨­å®šæœˆè–ª</span>
                                    <span class="text-brand-gold font-mono">$<span id="displaySalary">30,000</span></span>
                                </label>
                                <input type="range" id="salarySlider" min="27000" max="80000" step="500" value="30000" oninput="updateSalaryFromSlider(this.value)">
                                <input type="number" id="monthlySalary" value="30000" class="w-full bg-slate-900 border border-slate-600 rounded p-1 text-center text-white font-bold" oninput="updateSalaryFromInput(this.value)">
                            </div>

                            <div>
                                <div class="flex justify-between text-xs mb-1 text-slate-400"><span>å¹³æ—¥åŠ ç­ (å‰2hr)</span><span class="text-white font-bold"><span id="calcHours1Val">0</span> hr</span></div>
                                <input type="range" id="calcHours1" min="0" max="20" step="0.5" value="0" oninput="calculateOvertime()">
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1 text-slate-400"><span>å¹³æ—¥åŠ ç­ (ç¬¬3hrèµ·)</span><span class="text-white font-bold"><span id="calcHours2Val">0</span> hr</span></div>
                                <input type="range" id="calcHours2" min="0" max="20" step="0.5" value="0" oninput="calculateOvertime()">
                            </div>

                            <div class="mt-4 pt-4 border-t border-slate-700 space-y-2">
                                <div class="flex justify-between text-xs text-slate-400">
                                    <span>é ä¼°åŠ ç­è²» (+)</span>
                                    <span class="text-green-400 font-mono">$<span id="calcOtTotal">0</span></span>
                                </div>
                                <div class="flex justify-between text-xs text-slate-400">
                                    <span>è«‹å‡æ‰£è–ª (-)</span>
                                    <span class="text-red-400 font-mono">$<span id="calcDeduction">0</span></span>
                                </div>
                                <div class="flex justify-between items-end mt-2 pt-2 border-t border-slate-700/50">
                                    <span class="text-sm font-bold text-white">é ä¼°å¯¦é ˜</span>
                                    <div class="text-2xl font-black text-brand-gold font-mono">$<span id="calcFinalTotal">0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass-panel p-6 flex flex-col items-center text-center fade-in-up">
                        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center text-2xl mb-2"><span id="dashboardAvatar">ğŸ‘¤</span></div>
                        <h2 id="dashboardName" class="text-xl font-bold text-slate-800">...</h2>
                        <div class="text-xs text-slate-500 mt-1">
                            <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-[10px] font-bold">
                                <i class="fa-solid fa-check-circle"></i> è£ç½®å·²é–å®š
                            </span>
                        </div>
                        <div class="mt-4 w-full grid grid-cols-2 gap-2 text-center">
                            <div class="bg-blue-50 p-2 rounded">
                                <div class="text-[10px] text-slate-400 uppercase">ç‰¹ä¼‘é¡åº¦</div>
                                <div class="font-bold text-blue-800" id="dashboardTotal">--</div>
                            </div>
                            <div class="bg-green-50 p-2 rounded">
                                <div class="text-[10px] text-slate-400 uppercase">ç‰¹ä¼‘å‰©é¤˜</div>
                                <div class="font-bold text-green-600" id="dashboardRemaining">--</div>
                            </div>
                        </div>
                        <div class="mt-2 text-xs text-slate-500">
                            è£œä¼‘é¤˜é¡: <span class="font-bold text-orange-600" id="dashboardComp">0</span> å¤©
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="adminView" class="hidden-section w-full fade-in-up">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 glass-panel p-6 border-t-4 border-blue-600">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-clipboard-check text-blue-600"></i> ç”³è«‹å¯©æ ¸ä¸­å¿ƒ 
                        <span id="pendingCountBadge" class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                    </h2>
                    <div class="overflow-x-auto"><table class="w-full text-left text-sm"><tbody id="approvalTableBody" class="divide-y divide-slate-100"></tbody></table></div>
                    <div id="noPendingMsg" class="text-center py-8 text-slate-400"><i class="fa-regular fa-circle-check text-4xl mb-2 text-slate-200"></i><p>ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„ç”³è«‹</p></div>
                </div>

                <div class="lg:col-span-1 glass-panel p-6 border-t-4 border-brand-gold">
                    <h2 class="text-lg font-bold text-slate-800 mb-4"><i class="fa-solid fa-bullhorn text-brand-gold mr-2"></i> å…¬å‘Šç®¡ç†</h2>
                    <input type="text" id="adminBulletinTitle" class="w-full p-2 mb-2 input-modern" placeholder="æ¨™é¡Œ">
                    <textarea id="adminBulletinContent" rows="4" class="w-full p-2 mb-2 input-modern" placeholder="å…§å®¹"></textarea>
                    <button onclick="saveBulletin()" class="w-full bg-slate-800 text-white p-2 rounded font-bold hover:bg-slate-700">æ›´æ–°ç™¼å¸ƒ</button>
                </div>

                <div class="lg:col-span-3 glass-panel p-6 border-t-4 border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-clock-rotate-left text-slate-700"></i> è€ƒå‹¤èˆ‡å ±è¡¨ä¸­å¿ƒ</h2>
                        <div class="flex gap-2">
                            <button onclick="exportLeaveRequests()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-2 rounded shadow flex items-center gap-1">
                                <i class="fa-solid fa-file-invoice"></i> åŒ¯å‡ºè«‹å‡æ˜ç´°(å«è¨»è¨˜)
                            </button>
                            <button onclick="exportAttendance()" class="bg-green-600 hover:bg-green-500 text-white text-xs px-3 py-2 rounded shadow flex items-center gap-1">
                                <i class="fa-solid fa-file-excel"></i> åŒ¯å‡ºæ‰“å¡ç´€éŒ„
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-60 overflow-y-auto custom-scrollbar">
                        <table class="w-full text-left text-sm"><tbody id="attendanceTableBody" class="divide-y divide-slate-100 text-xs"></tbody></table>
                    </div>
                </div>

                <div class="lg:col-span-3 glass-panel p-6">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-users mr-1"></i> å“¡å·¥å…¨æ–¹ä½ç®¡ç† <span class="text-xs text-slate-400 font-normal ml-2">(åˆ°è·æ—¥é€£å‹•å¹´è³‡)</span></h2>
                    
                    <div class="flex gap-2 mb-4 bg-slate-50 p-3 rounded-lg border border-slate-200">
                        <input type="text" id="newAdminName" placeholder="æ–°é€²å“¡å·¥å§“å" class="flex-1 p-2 input-modern">
                        <select id="newAdminGender" class="w-24 p-2 input-modern"><option value="M">ç”·</option><option value="F">å¥³</option></select>
                        <input type="date" id="newAdminDate" class="w-40 p-2 input-modern">
                        <button onclick="addEmployee()" class="bg-blue-600 text-white px-4 rounded font-bold hover:bg-blue-500">æ–°å¢</button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-100 text-slate-600 text-xs uppercase">
                                <tr>
                                    <th class="p-3">å§“å (å¯æ”¹)</th>
                                    <th class="p-3">å¹´è³‡ / åˆ°è·æ—¥ (å¯æ”¹)</th>
                                    <th class="p-3">ç‰¹ä¼‘æ¦‚æ³ (ç¸½/ç”¨/å‰©)</th>
                                    <th class="p-3 w-1/4">è£ç½®</th>
                                    <th class="p-3 text-right">ç®¡ç†</th>
                                </tr>
                            </thead>
                            <tbody id="adminTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <div id="historyModal" class="modal-overlay">
            <div class="modal-content">
                <div class="p-4 border-b bg-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800 text-lg"><i class="fa-solid fa-sliders mr-2"></i> å‡å‹¤æ•¸æ“šä¸­æ§å° - <span id="modalEmpName"></span></h3>
                    <button onclick="closeHistory()" class="text-slate-500 hover:text-red-500 text-xl"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-6 overflow-y-auto flex-1 bg-slate-50">
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg border border-blue-200 shadow-sm relative overflow-hidden">
                            <div class="absolute top-0 right-0 bg-blue-100 text-blue-800 text-[10px] px-2 py-1 font-bold">ç‰¹ä¼‘ (Annual)</div>
                            <div class="mt-2 space-y-2">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-slate-500">å·²ä½¿ç”¨å¤©æ•¸</span>
                                    <input type="number" id="adjAnnualUsed" class="border rounded w-16 text-center font-bold text-blue-700" step="0.5">
                                </div>
                                <div class="text-xs text-slate-400 text-right">ç³»çµ±è‡ªå‹•ç´¯è¨ˆ</div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg border border-orange-200 shadow-sm relative overflow-hidden">
                            <div class="absolute top-0 right-0 bg-orange-100 text-orange-800 text-[10px] px-2 py-1 font-bold">è£œä¼‘ (Comp)</div>
                            <div class="mt-2 space-y-2">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-slate-500">ç›®å‰é¤˜é¡</span>
                                    <input type="number" id="adjCompBalance" class="border rounded w-16 text-center font-bold text-orange-700" step="0.5">
                                </div>
                                <div class="text-xs text-slate-400 text-right">ç®¡ç†è€…æ‰‹å‹•ç™¼æ”¾</div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm relative overflow-hidden">
                            <div class="absolute top-0 right-0 bg-gray-100 text-gray-800 text-[10px] px-2 py-1 font-bold">ç—…/äº‹å‡</div>
                            <div class="mt-2 space-y-1">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-slate-500">ç—…å‡å·²ç”¨</span>
                                    <input type="number" id="adjSickUsed" class="border rounded w-16 text-center font-bold text-gray-700" step="0.5">
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-slate-500">äº‹å‡å·²ç”¨</span>
                                    <input type="number" id="adjPersonalUsed" class="border rounded w-16 text-center font-bold text-gray-700" step="0.5">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="saveAllAdjustments()" class="w-full bg-slate-800 text-white py-2 rounded mb-6 font-bold hover:bg-slate-700 shadow-md">
                        <i class="fa-solid fa-save mr-1"></i> å„²å­˜æ‰€æœ‰ä¿®æ­£
                    </button>

                    <h4 class="font-bold text-slate-700 mb-2">ğŸ“œ æ­·å²ç”³è«‹ç´€éŒ„ (é»æ“Šç­†åœ–ç¤ºå¯è¨»è¨˜)</h4>
                    <div class="overflow-x-auto bg-white rounded-lg border border-slate-200">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100 text-xs text-slate-500 uppercase">
                                <tr>
                                    <th class="p-2">æ—¥æœŸ</th>
                                    <th class="p-2">é¡å‹</th>
                                    <th class="p-2">å…§å®¹</th>
                                    <th class="p-2">ç‹€æ…‹</th>
                                    <th class="p-2">ç®¡ç†è¨»è¨˜</th>
                                    <th class="p-2 text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCcSH0HQutt6rYcFWjCKOpTSWkBDeinyvw",
            authDomain: "homego-system.firebaseapp.com",
            databaseURL: "https://homego-system-default-rtdb.firebaseio.com",
            projectId: "homego-system",
            storageBucket: "homego-system.firebasestorage.app",
            messagingSenderId: "679007509034",
            appId: "1:679007509034:web:df50010c5ab8cd7f964153"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const ADMIN_PASSWORD = "8888";

        let employees = {};
        let requests = {};
        let attendance = {};
        let bulletin = { title: "æ­¡è¿", content: "è³‡æ–™è®€å–ä¸­...", date: "" };
        let currentUserId = null;
        let currentDeduction = 0;
        let currentModalEmpId = null;

        // --- Device Fingerprint ---
        let myDeviceId = localStorage.getItem('hge_security_did');
        if (!myDeviceId) {
            myDeviceId = 'DID-' + Math.random().toString(36).substr(2, 6).toUpperCase() + '-' + Date.now().toString(36).substr(-4);
            localStorage.setItem('hge_security_did', myDeviceId);
        }
        document.getElementById('myDeviceIdDisplay').innerText = myDeviceId;

        // --- Clock ---
        setInterval(() => {
            document.getElementById('liveClock').innerText = new Date().toLocaleTimeString('zh-TW', {hour12: false});
        }, 1000);

        // --- UI ---
        window.switchView = (view) => {
            document.getElementById('employeeView').classList.add('hidden-section');
            document.getElementById('adminView').classList.add('hidden-section');
            document.getElementById('loginSection').classList.add('hidden-section');
            const btnEmp = document.getElementById('btnEmp');
            const btnAdm = document.getElementById('btnAdm');

            if (view === 'employee') {
                document.getElementById('loginSection').classList.remove('hidden-section');
                currentUserId = null;
                updateEmpSelect();
                btnEmp.className = "px-4 py-1.5 rounded-full text-xs md:text-sm font-medium transition-all bg-white text-blue-900 shadow-sm";
                btnAdm.className = "px-4 py-1.5 rounded-full text-xs md:text-sm font-medium text-blue-200 hover:text-white transition-all";
            } else {
                document.getElementById('adminView').classList.remove('hidden-section');
                btnAdm.className = "px-4 py-1.5 rounded-full text-xs md:text-sm font-medium transition-all bg-white text-blue-900 shadow-sm";
                btnEmp.className = "px-4 py-1.5 rounded-full text-xs md:text-sm font-medium text-blue-200 hover:text-white transition-all";
            }
        };

        window.checkAdminLogin = () => {
            let pass = prompt("ğŸ” è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
            if (pass === ADMIN_PASSWORD) window.switchView('admin');
            else if (pass !== null) alert("ğŸš« å¯†ç¢¼éŒ¯èª¤");
        };

        window.switchAppTab = (tab) => {
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.className = 'w-1/2 py-2 text-center text-sm tab-inactive');
            document.getElementById(`tab-${tab}`).className = 'w-1/2 py-2 text-center text-sm tab-active';
            document.getElementById('form-leave').classList.add('hidden-section');
            document.getElementById('form-car').classList.add('hidden-section');
            document.getElementById(`form-${tab}`).classList.remove('hidden-section');
        };

        // --- Firebase ---
        onValue(ref(db), (snapshot) => {
            const data = snapshot.val() || {};
            employees = data.employees || {};
            requests = data.requests || {};
            attendance = data.attendance || {};
            bulletin = data.bulletin || { title: "å°šç„¡å…¬å‘Š", content: "", date: "" };
            
            updateEmpSelect();
            renderBulletin();
            if (currentUserId) {
                 const emp = employees[currentUserId];
                 if(emp) {
                    const calc = calculateLeave(emp.joinDate);
                    const used = emp.stats?.annual || emp.usedLeave || 0; 
                    const comp = emp.stats?.comp || 0;
                    document.getElementById('dashboardRemaining').innerText = (calc.days - used) + " å¤©";
                    document.getElementById('dashboardComp').innerText = comp;
                 }
            }
            renderAdminTable();
            renderApprovalQueue();
            renderAttendanceLog();
            
            const select = document.getElementById('empSelect');
            select.disabled = false;
        });

        // --- Auth Logic ---
        function updateEmpSelect() {
            const select = document.getElementById('empSelect');
            select.innerHTML = '';
            let boundUser = null;
            Object.values(employees).forEach(emp => {
                if (emp.devices && emp.devices.includes(myDeviceId)) boundUser = emp;
            });

            if (boundUser) {
                const option = document.createElement('option');
                option.value = boundUser.id;
                option.innerText = `ğŸ”’ å·²ç¶å®šèº«åˆ†ï¼š${boundUser.name}`;
                select.appendChild(option);
                select.value = boundUser.id;
                if (!document.getElementById('loginSection').classList.contains('hidden-section')) {
                     document.getElementById('loginStatusMsg').classList.remove('hidden');
                     setTimeout(() => loadEmployeeDashboard(boundUser.id), 800);
                }
            } else {
                const defaultOpt = document.createElement('option');
                defaultOpt.value = "";
                defaultOpt.innerText = "-- è«‹é¸æ“‡æ‚¨çš„å§“å (é¦–æ¬¡éœ€ç¶å®š) --";
                select.appendChild(defaultOpt);
                Object.values(employees).forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.innerText = emp.name;
                    select.appendChild(option);
                });
            }
        }

        window.tryBindAndLogin = () => {
            const id = document.getElementById('empSelect').value;
            if (!id) return;
            const emp = employees[id];
            const currentDevices = emp.devices || [];

            if (currentDevices.includes(myDeviceId)) { loadEmployeeDashboard(id); return; }
            if (currentDevices.length >= 2) {
                Swal.fire({ icon: 'error', title: 'ç¶å®šå¤±æ•—', text: 'æ‚¨çš„å¸³è™Ÿå·²ç¶å®š 2 å°è£ç½®ã€‚è«‹è¯ç¹«ç®¡ç†å“¡è§£ç¶èˆŠè£ç½®ã€‚' });
                document.getElementById('empSelect').value = "";
                return;
            }

            Swal.fire({
                title: 'è£ç½®ç¶å®šç¢ºèª',
                html: `å³å°‡ç¶å®šæ­¤è£ç½®ç‚º <b>${emp.name}</b> çš„å°ˆç”¨è¨­å‚™ã€‚<br>ç¶å®šå¾Œç„¡æ³•åˆ‡æ›ç‚ºå…¶ä»–äººå“¡ã€‚<br><br>ç›®å‰å·²ç”¨é¡åº¦: ${currentDevices.length}/2`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#1e3a8a',
                confirmButtonText: 'ç¢ºèªç¶å®š'
            }).then((result) => {
                if (result.isConfirmed) {
                    const newDevices = [...currentDevices, myDeviceId];
                    update(ref(db, `employees/${id}`), { devices: newDevices }).then(() => {
                        Swal.fire('æˆåŠŸ', 'è£ç½®å·²ç¶å®š', 'success');
                        loadEmployeeDashboard(id);
                    });
                } else {
                    document.getElementById('empSelect').value = "";
                }
            });
        };

        window.loadEmployeeDashboard = (forcedId) => {
            const id = forcedId || document.getElementById('empSelect').value;
            if (!id) return;
            currentUserId = id;
            const emp = employees[id];
            
            if (emp) {
                const calc = calculateLeave(emp.joinDate);
                const used = emp.stats?.annual || emp.usedLeave || 0;
                const comp = emp.stats?.comp || 0;

                document.getElementById('dashboardName').innerText = emp.name;
                document.getElementById('dashboardAvatar').innerText = emp.gender === 'F' ? 'ğŸ‘©â€ğŸ’¼' : 'ğŸ‘¨â€ğŸ’¼';
                document.getElementById('dashboardTotal').innerText = calc.days + " å¤©";
                document.getElementById('dashboardRemaining').innerText = (calc.days - used) + " å¤©";
                document.getElementById('dashboardComp').innerText = comp;
                
                document.getElementById('loginSection').classList.add('hidden-section');
                document.getElementById('loginStatusMsg').classList.add('hidden');
                document.getElementById('employeeView').classList.remove('hidden-section');
                
                window.calculateOvertime();
                window.updateImpactInfo();
            }
        };

        window.handlePunch = (type) => {
            if (!currentUserId) return;
            const emp = employees[currentUserId];
            if (!emp.devices || !emp.devices.includes(myDeviceId)) return Swal.fire('å®‰å…¨è­¦å‘Š', 'æ­¤è£ç½®æœªç¶“æˆæ¬Š', 'error');
            if (!navigator.geolocation) return Swal.fire('éŒ¯èª¤', 'ä¸æ”¯æ´å®šä½', 'error');
            
            navigator.geolocation.getCurrentPosition((position) => {
                const now = new Date();
                push(ref(db, 'attendance'), {
                    empId: currentUserId, empName: emp.name, type: type, timestamp: now.getTime(),
                    dateStr: now.toLocaleDateString(), timeStr: now.toLocaleTimeString(),
                    location: `${position.coords.latitude}, ${position.coords.longitude}`,
                    mapLink: `http://maps.google.com/?q=${position.coords.latitude},${position.coords.longitude}`,
                    deviceId: myDeviceId
                });
                Swal.fire('æ‰“å¡æˆåŠŸ', `${type} @ ${now.toLocaleTimeString()}`, 'success');
            });
        };

        // --- Salary ---
        window.updateSalaryFromSlider = (val) => {
            document.getElementById('monthlySalary').value = val;
            document.getElementById('displaySalary').innerText = parseInt(val).toLocaleString();
            calculateOvertime(); updateImpactInfo();
        };
        window.updateSalaryFromInput = (val) => {
            document.getElementById('salarySlider').value = val;
            document.getElementById('displaySalary').innerText = parseInt(val).toLocaleString();
            calculateOvertime(); updateImpactInfo();
        };

        window.calculateOvertime = () => {
            const salary = parseInt(document.getElementById('monthlySalary').value) || 0;
            const hourlyRate = Math.round(salary / 240);
            const h1 = parseFloat(document.getElementById('calcHours1').value);
            const h2 = parseFloat(document.getElementById('calcHours2').value);
            document.getElementById('calcHours1Val').innerText = h1;
            document.getElementById('calcHours2Val').innerText = h2;
            const otTotal = Math.round((h1 * hourlyRate * 1.34) + (h2 * hourlyRate * 1.67));
            document.getElementById('calcOtTotal').innerText = otTotal.toLocaleString();
            const final = salary + otTotal - currentDeduction;
            document.getElementById('calcDeduction').innerText = currentDeduction.toLocaleString();
            document.getElementById('calcFinalTotal').innerText = final.toLocaleString();
        };

        window.updateImpactInfo = () => {
            const type = document.getElementById('leaveType').value;
            const days = parseFloat(document.getElementById('leaveDays').value) || 0;
            const salary = parseInt(document.getElementById('monthlySalary').value) || 30000;
            const dailyRate = Math.round(salary / 30);
            const card = document.getElementById('impactCard');
            const title = document.getElementById('impactTitle');
            const desc = document.getElementById('impactDesc');
            
            card.classList.remove('impact-full', 'impact-half', 'impact-none');
            let deduction = 0;

            if (['ç‰¹ä¼‘','è£œä¼‘','å©šå‡'].includes(type)) {
                card.classList.add('impact-full'); title.innerText = "å…¨è–ª"; desc.innerText = "å·¥è³‡ç…§çµ¦";
            } else if (['ç—…å‡'].includes(type)) {
                card.classList.add('impact-half'); title.innerText = "åŠè–ª"; desc.innerText = "å·¥è³‡æŠ˜åŠ";
                deduction = Math.round(dailyRate * days * 0.5);
            } else {
                card.classList.add('impact-none'); title.innerText = "ç„¡è–ª"; desc.innerText = "ä¸çµ¦ä»˜å·¥è³‡";
                deduction = Math.round(dailyRate * days);
            }
            
            document.getElementById('impactAmount').innerText = deduction.toLocaleString();
            currentDeduction = deduction;
            window.calculateOvertime();
        };

        // --- Submissions ---
        window.handleLeaveSubmit = (e) => {
            e.preventDefault();
            if (!currentUserId) return;
            const emp = employees[currentUserId];
            // Comp Leave Check
            const type = document.getElementById('leaveType').value;
            const days = parseFloat(document.getElementById('leaveDays').value);
            if (type === 'è£œä¼‘') {
                const balance = emp.stats?.comp || 0;
                if (balance < days) return Swal.fire('é¤˜é¡ä¸è¶³', `è£œä¼‘å‰©é¤˜ ${balance} å¤©ï¼Œç„¡æ³•ç”³è«‹ ${days} å¤©`, 'error');
            }

            const date = document.getElementById('leaveDate').value;
            const reason = document.getElementById('leaveReason').value;

            push(ref(db, 'requests'), {
                empId: currentUserId, empName: emp.name, category: 'leave',
                type, date, days, reason, status: 'pending', timestamp: Date.now()
            });

            const msg = `ã€è«‹å‡ç”³è«‹ã€‘\nğŸ‘¤ ${emp.name}\nğŸ“… ${date} (${days}å¤©)\nğŸ·ï¸ ${type}\nğŸ“ ${reason}`;
            window.open('https://line.me/R/msg/text/?' + encodeURIComponent(msg));
            Swal.fire('å·²é€å‡º', 'ç”³è«‹å·²æäº¤', 'success');
        };

        window.handleCarSubmit = (e) => {
            e.preventDefault();
            if (!currentUserId) return;
            const emp = employees[currentUserId];
            const date = document.getElementById('carDate').value;
            const time = document.getElementById('carTime').value;
            const location = document.getElementById('carLocation').value;

            push(ref(db, 'requests'), {
                empId: currentUserId, empName: emp.name, category: 'car',
                date, time, location, status: 'pending', timestamp: Date.now()
            });

            const msg = `ã€å…¬å‹™è»Šé ç´„ã€‘\nğŸ‘¤ ${emp.name}\nğŸ“… ${date} ${time}\nğŸ“ ${location}`;
            window.open('https://line.me/R/msg/text/?' + encodeURIComponent(msg));
            Swal.fire('å·²é€å‡º', 'ç”³è«‹å·²æäº¤', 'success');
        };

        // --- Admin Logic (Stats Update) ---
        window.processRequest = (reqId, action) => {
            const req = requests[reqId]; 
            if (!req) return Swal.fire('éŒ¯èª¤', 'æ‰¾ä¸åˆ°è©²ç”³è«‹ç´€éŒ„', 'error');
            
            const actionText = action === 'approve' ? 'æ‰¹å‡†' : 'é§å›';
            
            Swal.fire({
                title: `ç¢ºèª${actionText}?`,
                text: `${req.empName} çš„ ${req.category === 'car' ? 'å…¬å‹™è»Š' : req.type} ç”³è«‹`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: action === 'approve' ? '#059669' : '#DC2626',
                confirmButtonText: 'ç¢ºèªåŸ·è¡Œ'
            }).then((result) => {
                if (result.isConfirmed) {
                    try {
                        if (action === 'approve' && req.category === 'leave') {
                            const emp = employees[req.empId];
                            if (!emp) return Swal.fire('æ“ä½œå¤±æ•—', 'æ‰¾ä¸åˆ°è©²å“¡å·¥', 'error');
                            
                            const stats = emp.stats || { annual: emp.usedLeave || 0, comp: 0, sick: 0, personal: 0 };
                            
                            if (req.type === 'ç‰¹ä¼‘') stats.annual = (stats.annual || 0) + req.days;
                            if (req.type === 'è£œä¼‘') stats.comp = (stats.comp || 0) - req.days;
                            if (req.type === 'ç—…å‡') stats.sick = (stats.sick || 0) + req.days;
                            if (req.type === 'äº‹å‡') stats.personal = (stats.personal || 0) + req.days;

                            update(ref(db, `employees/${req.empId}`), { 
                                stats: stats,
                                usedLeave: stats.annual
                            });
                        }
                        
                        update(ref(db, `requests/${reqId}`), { status: action === 'approve' ? 'approved' : 'rejected' })
                            .then(() => Swal.fire('æˆåŠŸ', 'æ“ä½œå·²å®Œæˆ', 'success'))
                            .catch(err => Swal.fire('éŒ¯èª¤', err.message, 'error'));
                            
                    } catch (e) {
                        console.error(e);
                        Swal.fire('ç³»çµ±éŒ¯èª¤', 'åŸ·è¡Œéç¨‹ç™¼ç”Ÿç•°å¸¸', 'error');
                    }
                }
            });
        };

        window.openHistory = (empId) => {
            const emp = employees[empId];
            if(!emp) return;
            currentModalEmpId = empId;
            document.getElementById('modalEmpName').innerText = emp.name;
            
            const stats = emp.stats || { annual: emp.usedLeave || 0, comp: 0, sick: 0, personal: 0 };
            document.getElementById('adjAnnualUsed').value = stats.annual;
            document.getElementById('adjCompBalance').value = stats.comp;
            document.getElementById('adjSickUsed').value = stats.sick;
            document.getElementById('adjPersonalUsed').value = stats.personal;
            
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            const myHistory = Object.entries(requests)
                .map(([key, val]) => ({...val, id: key}))
                .filter(r => r.empId === empId)
                .sort((a,b) => b.timestamp - a.timestamp); 
            
            if(myHistory.length === 0) tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-slate-400">å°šç„¡ç´€éŒ„</td></tr>';
            else {
                myHistory.forEach(req => {
                    let statusColor = req.status === 'approved' ? 'text-green-600 font-bold' : req.status === 'rejected' ? 'text-red-500 font-bold' : 'text-orange-500 font-bold';
                    const detail = req.category === 'car' ? `å…¬å‹™è»Š: ${req.location}` : `${req.type} (${req.days}å¤©)`;
                    const note = req.adminNote ? `<span class="bg-yellow-100 text-yellow-800 text-[10px] px-2 py-1 rounded">${req.adminNote}</span>` : '<span class="text-slate-300 text-[10px]">-</span>';
                    
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-slate-50">
                            <td class="p-2 text-xs">${req.date}</td>
                            <td class="p-2 text-xs">${req.category==='car'?'ç”¨è»Š':'è«‹å‡'}</td>
                            <td class="p-2 text-sm text-slate-700">${detail}</td>
                            <td class="p-2 text-xs ${statusColor}">${req.status}</td>
                            <td class="p-2 cursor-pointer" onclick="window.editAdminNote('${req.id}')">${note} <i class="fa-solid fa-pen text-slate-300 text-[10px] ml-1"></i></td>
                            <td class="p-2 text-right"><button onclick="window.deleteHistoryItem('${req.id}')" class="text-red-400 hover:text-red-600 px-2"><i class="fa-solid fa-trash"></i></button></td>
                        </tr>`;
                });
            }
            document.getElementById('historyModal').style.display = 'flex';
        };

        window.closeHistory = () => { document.getElementById('historyModal').style.display = 'none'; };

        window.editAdminNote = async (reqId) => {
            const req = requests[reqId];
            const { value: text } = await Swal.fire({
                title: 'ç®¡ç†å“¡è¨»è¨˜',
                input: 'text',
                inputValue: req.adminNote || '',
                placeholder: 'ä¾‹å¦‚: å·²è£œè­‰æ˜...',
                showCancelButton: true
            });

            if (text !== undefined) {
                update(ref(db, `requests/${reqId}`), { adminNote: text })
                    .then(() => {
                        window.openHistory(currentModalEmpId); // Refresh modal
                    });
            }
        };

        window.saveAllAdjustments = () => {
            if(!currentModalEmpId) return;
            const stats = {
                annual: parseFloat(document.getElementById('adjAnnualUsed').value) || 0,
                comp: parseFloat(document.getElementById('adjCompBalance').value) || 0,
                sick: parseFloat(document.getElementById('adjSickUsed').value) || 0,
                personal: parseFloat(document.getElementById('adjPersonalUsed').value) || 0
            };
            update(ref(db, `employees/${currentModalEmpId}`), { stats: stats, usedLeave: stats.annual })
                .then(() => Swal.fire('æ›´æ–°æˆåŠŸ', 'æ‰€æœ‰å‡å‹¤æ•¸æ“šå·²æ ¡æ­£', 'success'));
        };

        window.deleteHistoryItem = (reqId) => {
            Swal.fire({ title: 'ç¢ºå®šåˆªé™¤?', text: 'åˆªé™¤å¾Œä¸å½±éŸ¿å·²æ‰£é™¤çš„é¡åº¦ (éœ€æ‰‹å‹•æ ¡æ­£)', icon: 'warning', showCancelButton: true, confirmButtonText: 'åˆªé™¤' }).then((result) => {
                if(result.isConfirmed) remove(ref(db, `requests/${reqId}`)).then(() => window.openHistory(currentModalEmpId));
            });
        };

        window.saveBulletin = () => {
            set(ref(db, 'bulletin'), {
                title: document.getElementById('adminBulletinTitle').value,
                content: document.getElementById('adminBulletinContent').value,
                date: new Date().toLocaleDateString()
            });
            Swal.fire('æˆåŠŸ', 'å…¬å‘Šå·²æ›´æ–°', 'success');
        };

        window.addEmployee = () => {
            const name = document.getElementById('newAdminName').value;
            const gender = document.getElementById('newAdminGender').value;
            const date = document.getElementById('newAdminDate').value;
            if(!name || !date) return Swal.fire('è³‡æ–™ä¸å®Œæ•´');
            const newRef = push(ref(db, 'employees'));
            set(newRef, { id: newRef.key, name, gender, joinDate: date, usedLeave: 0, devices: [], stats: {annual:0, comp:0, sick:0, personal:0} });
            document.getElementById('newAdminName').value = '';
            Swal.fire('æˆåŠŸ', 'å“¡å·¥å·²æ–°å¢', 'success');
        };

        window.updateEmpName = (id, newName) => { if(confirm(`ç¢ºå®šæ›´æ”¹å§“åç‚º ${newName}?`)) update(ref(db, `employees/${id}`), { name: newName }); };
        window.updateEmpDate = (id, newDate) => { update(ref(db, `employees/${id}`), { joinDate: newDate }); };
        window.deleteEmployee = (id) => { if(confirm("ç¢ºå®šåˆªé™¤æ­¤å“¡å·¥?")) remove(ref(db, `employees/${id}`)); };
        window.unbindDevice = (empId, deviceIndex) => {
            const emp = employees[empId];
            Swal.fire({ title: 'ç¢ºèªè§£é™¤ç¶å®š?', icon: 'warning', showCancelButton: true, confirmButtonText: 'ç§»é™¤' }).then((result) => {
                if (result.isConfirmed) {
                    const newDevices = [...emp.devices];
                    newDevices.splice(deviceIndex, 1);
                    update(ref(db, `employees/${empId}`), { devices: newDevices });
                    Swal.fire('å·²ç§»é™¤', '', 'success');
                }
            });
        };

        // --- Render Helpers ---
        function renderApprovalQueue() {
            const tbody = document.getElementById('approvalTableBody');
            const noMsg = document.getElementById('noPendingMsg');
            const badge = document.getElementById('pendingCountBadge');
            tbody.innerHTML = '';
            
            const pendingReqs = Object.entries(requests)
                .map(([key, val]) => ({ ...val, id: key }))
                .filter(r => r.status === 'pending')
                .sort((a,b) => a.timestamp - b.timestamp);
            
            if (pendingReqs.length > 0) {
                noMsg.classList.add('hidden');
                badge.innerText = pendingReqs.length;
                badge.classList.remove('hidden');
                pendingReqs.forEach(req => {
                    const isCar = req.category === 'car';
                    const icon = isCar ? '<i class="fa-solid fa-car"></i>' : '<i class="fa-solid fa-user-clock"></i>';
                    const typeLabel = isCar ? 'å…¬å‹™è»Š' : req.type;
                    const detail = isCar ? `${req.time} @ ${req.location}` : `${req.days} å¤© | ${req.reason}`;
                    const rowClass = isCar ? 'border-l-4 border-l-brand-gold' : 'border-l-4 border-l-blue-500';

                    tbody.innerHTML += `
                        <tr class="bg-white border-b hover:bg-slate-50 ${rowClass}">
                            <td class="p-3 font-bold text-slate-700 flex items-center gap-2">${icon} ${req.empName}</td>
                            <td class="p-3">
                                <div class="font-bold text-slate-800">${typeLabel}</div>
                                <div class="text-xs text-slate-500">${req.date}</div>
                            </td>
                            <td class="p-3 text-sm text-slate-600">${detail}</td>
                            <td class="p-3 text-right space-x-1">
                                <button onclick="window.processRequest('${req.id}', 'approve')" class="text-green-600 hover:bg-green-100 p-1 rounded"><i class="fa-solid fa-check"></i></button>
                                <button onclick="window.processRequest('${req.id}', 'reject')" class="text-red-600 hover:bg-red-100 p-1 rounded"><i class="fa-solid fa-xmark"></i></button>
                            </td>
                        </tr>`;
                });
            } else {
                noMsg.classList.remove('hidden');
                badge.classList.add('hidden');
            }
        }

        function renderAdminTable() {
            const tbody = document.getElementById('adminTableBody');
            tbody.innerHTML = '';
            Object.values(employees).forEach(emp => {
                const devices = emp.devices || [];
                let deviceHtml = devices.map((did, idx) => `<span class="device-badge cursor-pointer hover:bg-red-200 hover:text-red-800" onclick="window.unbindDevice('${emp.id}', ${idx})">ğŸ“± ${did.substr(0,4)}...</span>`).join(' ');
                if (devices.length === 0) deviceHtml = '<span class="text-xs text-slate-300">æœªç¶å®š</span>';

                const calc = calculateLeave(emp.joinDate);
                const stats = emp.stats || { annual: emp.usedLeave || 0, comp: 0 };
                const remaining = calc.days - stats.annual;

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 border-b">
                        <td class="p-3"><input type="text" value="${emp.name}" onchange="window.updateEmpName('${emp.id}', this.value)" class="border rounded px-2 py-1 w-20 text-sm font-bold text-slate-700 focus:border-blue-500 outline-none"></td>
                        <td class="p-3">
                            <div class="font-bold text-blue-900">${calc.years} å¹´</div>
                            <input type="date" value="${emp.joinDate}" onchange="window.updateEmpDate('${emp.id}', this.value)" class="text-xs text-slate-400 bg-transparent border-none outline-none p-0 cursor-pointer hover:text-blue-500">
                        </td>
                        <td class="p-3">
                            <div class="flex items-center gap-2 text-xs">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">ç¸½:${calc.days}</span>
                                <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded">ç”¨:${stats.annual}</span>
                                <span class="font-bold text-sm ${remaining<0?'text-red-500':'text-green-600'}">å‰©:${remaining}</span>
                            </div>
                        </td>
                        <td class="p-3">${deviceHtml}</td>
                        <td class="p-3 text-right space-x-1">
                             <button onclick="window.openHistory('${emp.id}')" class="bg-white border border-slate-200 text-slate-600 text-xs px-2 py-1 rounded hover:bg-slate-50 shadow-sm" title="ç´€éŒ„èˆ‡æ ¡æ­£"><i class="fa-solid fa-pen-to-square"></i></button>
                             <button onclick="window.deleteEmployee('${emp.id}')" class="text-slate-300 hover:text-red-500 px-2" title="åˆªé™¤å“¡å·¥"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        function calculateLeave(joinDate) {
            const now = new Date();
            const start = new Date(joinDate);
            const years = (now - start) / (1000 * 60 * 60 * 24 * 365.25);
            let days = 0;
            if (years >= 0.5 && years < 1) days = 3;
            else if (years >= 1 && years < 2) days = 7;
            else if (years >= 2 && years < 3) days = 10;
            else if (years >= 3 && years < 5) days = 14;
            else if (years >= 5 && years < 10) days = 15;
            else if (years >= 10) days = Math.min(30, 15 + Math.floor(years - 10));
            return { years: years.toFixed(1), days: days };
        }

        function renderBulletin() {
            document.getElementById('displayBulletinTitle').innerText = bulletin.title;
            document.getElementById('displayBulletinContent').innerText = bulletin.content;
            document.getElementById('displayBulletinDate').innerText = bulletin.date;
        }

        function renderAttendanceLog() {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';
            Object.values(attendance).sort((a,b) => b.timestamp - a.timestamp).forEach(log => {
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 border-b">
                        <td class="p-2 font-bold text-slate-700">${log.empName}</td>
                        <td class="p-2 ${log.type==='ä¸Šç­'?'text-blue-600':'text-orange-600'}">${log.type}</td>
                        <td class="p-2 text-slate-500">${log.dateStr} ${log.timeStr}</td>
                        <td class="p-2"><a href="${log.mapLink}" target="_blank" class="text-blue-500"><i class="fa-solid fa-map-location-dot"></i></a></td>
                    </tr>`;
            });
        }
        
        window.exportAttendance = () => {
             const logs = Object.values(attendance).sort((a,b) => b.timestamp - a.timestamp);
             if (logs.length === 0) return Swal.fire('å°šç„¡è³‡æ–™');
             let csv = "\uFEFFå§“å,é¡å‹,æ—¥æœŸ,æ™‚é–“,åœ°åœ–\n";
             logs.forEach(l => csv += `${l.empName},${l.type},${l.dateStr},${l.timeStr},${l.mapLink}\n`);
             const link = document.createElement("a");
             link.href = URL.createObjectURL(new Blob([csv], { type: "text/csv;charset=utf-8;" }));
             link.download = "è€ƒå‹¤ç´€éŒ„.csv";
             link.click();
        };

        // --- NEW EXPORT FUNCTION ---
        window.exportLeaveRequests = () => {
            const reqs = Object.values(requests).filter(r => r.category === 'leave').sort((a,b) => b.timestamp - a.timestamp);
            if (reqs.length === 0) return Swal.fire('å°šç„¡è«‹å‡è³‡æ–™');
            
            let csv = "\uFEFFå§“å,æ—¥æœŸ,å‡åˆ¥,å¤©æ•¸,äº‹ç”±,ç‹€æ…‹,ç®¡ç†å“¡è¨»è¨˜\n";
            reqs.forEach(r => {
                const note = r.adminNote ? r.adminNote.replace(/,/g, ' ') : ''; // Handle commas
                const reason = r.reason ? r.reason.replace(/,/g, ' ') : '';
                csv += `${r.empName},${r.date},${r.type},${r.days},${reason},${r.status},${note}\n`;
            });
            
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: "text/csv;charset=utf-8;" }));
            link.download = `è«‹å‡æ˜ç´°åŒ¯å‡º_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        };

        document.getElementById('leaveDate').valueAsDate = new Date();
        document.getElementById('carDate').valueAsDate = new Date();
    </script>
</body>
</html>