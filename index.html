<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®åœ‹åœ°æ”¿|æ˜“ä¸åœ°æ”¿ - æ™ºæ…§æŒ‡æ®è‰™ (Nexus V5.30 Admin-Edit)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        /* [Feature 2] ç•«é¢å›ºå®šèˆ‡é˜²ç ´åœ–æ ¸å¿ƒè¨­å®š */
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; overflow-x: hidden; width: 100%; }
        
        .serif { font-family: 'Noto Serif TC', serif; }
        .brand-bg { background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%); } 
        .text-brand-gold { color: #facc15; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-radius: 1rem; transition: all 0.3s ease; }
        .input-modern { background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.5rem; transition: all 0.2s; }
        .input-modern:focus { background: #fff; border-color: #2563eb; outline: none; }
        .hidden-section { display: none; }
        .fade-in-up { animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* è–ªè³‡æ‹‰æ¢ */
        input[type=range] { -webkit-appearance: none; width: 100%; height: 6px; border-radius: 5px; background: #cbd5e1; outline: none; margin: 10px 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #2563eb; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        
        .impact-card { transition: all 0.3s ease; border-left: 4px solid; background-color: white; border: 1px solid #e2e8f0; }
        .impact-full { border-left-color: #22c55e; background-color: #f0fdf4; } 
        .impact-half { border-left-color: #f97316; background-color: #fff7ed; } 
        .impact-none { border-left-color: #ef4444; background-color: #fef2f2; } 
        .btn-punch:active { transform: scale(0.95); }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: bold; background-color: #f0f9ff; }
        .tab-inactive { color: #64748b; background-color: transparent; }
        .device-badge { font-family: monospace; font-size: 0.7rem; background: #e2e8f0; padding: 2px 6px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 95%; max-width: 900px; max-height: 90vh; border-radius: 1rem; padding: 0; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        
        /* æ²è»¸å„ªåŒ– */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .lsa-badge { font-size: 0.65rem; background-color: #e0f2fe; color: #0369a1; padding: 2px 6px; border-radius: 4px; border: 1px solid #bae6fd; display: inline-block; margin-top: 4px; }
        .avatar-hover-container { position: relative; cursor: pointer; transition: transform 0.2s; }
        .avatar-hover-container:active { transform: scale(0.95); }
        .avatar-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.4); border-radius: 9999px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
        .avatar-hover-container:hover .avatar-overlay { opacity: 1; }
        .leave-mode-btn { border: 1px solid #cbd5e1; color: #64748b; background: white; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; flex: 1; transition: all 0.2s; }
        .leave-mode-active { background-color: #eff6ff; border-color: #2563eb; color: #2563eb; font-weight: bold; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-cell { min-height: 100px; border: 1px solid #e2e8f0; border-radius: 6px; padding: 4px; font-size: 0.75rem; background: white; transition: all 0.2s; }
        .calendar-cell:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-color: #cbd5e1; }
        .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 0.8rem; font-weight: bold; color: #64748b; padding-bottom: 8px; }
        .cal-today { border: 2px solid #3b82f6; background-color: #eff6ff; }
        .cal-past { background-color: #f8fafc; color: #94a3b8; }

        /* [Feature 2] è¡¨æ ¼å¼·åˆ¶ä¸æ›è¡Œ (é˜²ç ´åœ–é—œéµ) */
        .table-fixed-layout th, .table-fixed-layout td { white-space: nowrap; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="brand-bg text-white sticky top-0 z-50 shadow-md">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white text-blue-900 rounded-lg flex items-center justify-center font-bold text-lg serif shadow-lg">å®</div>
                <div>
                    <h1 class="text-base md:text-lg font-bold tracking-wider serif">å®åœ‹åœ°æ”¿ | æ˜“ä¸åœ°æ”¿</h1>
                    <p class="text-[10px] text-blue-200 tracking-widest uppercase">Nexus V5.30 Admin-Edit</p>
                </div>
            </div>
            <div class="flex bg-blue-900/50 rounded-full p-1">
                <button onclick="switchView('employee')" id="btnEmp" class="px-4 py-1.5 rounded-full text-xs md:text-sm font-medium transition-all bg-white text-blue-900 shadow-sm">åŒä»å°ˆå€</button>
                <button onclick="checkAdminLogin()" id="btnAdm" class="px-4 py-1.5 rounded-full text-xs md:text-sm font-medium text-blue-200 hover:text-white transition-all">ç®¡ç†å¾Œå°</button>
            </div>
        </div>
    </header>

    <main class="flex-grow p-4 md:p-6 max-w-7xl mx-auto w-full overflow-x-hidden">
        <section id="loginSection" class="w-full glass-panel p-10 text-center max-w-lg mx-auto mt-12 fade-in-up">
            <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-2xl"><i class="fa-solid fa-shield-halved"></i></div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">èº«åˆ†é©—è­‰ç³»çµ±</h2>
            <p class="text-slate-500 mb-6 text-sm">ç³»çµ±å·²å•Ÿç”¨è£ç½®é–å®šä¿è­·</p>
            <div class="space-y-4">
                <button onclick="handleBiometricLogin()" class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all transform active:scale-95">
                    <i class="fa-solid fa-fingerprint text-2xl"></i>
                    <div class="text-left"><div class="font-bold text-lg">ç”Ÿç‰©è¾¨è­˜ç™»å…¥</div><div class="text-[10px] opacity-80">FaceID / TouchID / Windows Hello</div></div>
                </button>
                <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-slate-200"></div><span class="flex-shrink-0 mx-4 text-slate-400 text-xs">è£ç½®ç¶å®šç‹€æ…‹</span><div class="flex-grow border-t border-slate-200"></div></div>
                <div id="userSelectContainer">
                    <select id="empSelect" onchange="tryBindAndLogin()" class="w-full p-3 pl-4 text-lg input-modern cursor-pointer text-center font-bold text-slate-700 disabled:opacity-50" disabled><option value="">-- è®€å–è³‡æ–™ä¸­ --</option></select>
                    <div class="text-[10px] text-red-400 mt-1"><i class="fa-solid fa-triangle-exclamation mr-1"></i> æ³¨æ„ï¼šé¦–æ¬¡ç™»å…¥å°‡è‡ªå‹•ç¶å®šæ­¤è£ç½®ï¼Œç„¡æ³•æ›´æ”¹ã€‚</div>
                </div>
                <div id="deviceLockedMsg" class="hidden p-4 bg-slate-50 border border-slate-200 rounded-lg">
                    <div class="text-center"><i class="fa-solid fa-lock text-2xl text-blue-600 mb-2"></i><div class="text-sm font-bold text-slate-700">æ­¤è£ç½®å·²é–å®š</div><div class="text-xs text-slate-500 mt-1">å°ˆå±¬ä½¿ç”¨è€…ï¼š<span id="lockedUserName" class="font-bold text-blue-800 text-lg block mt-1">--</span></div><button onclick="loadEmployeeDashboard()" class="mt-3 w-full bg-blue-600 text-white text-xs py-2 rounded hover:bg-blue-700">é€²å…¥ç³»çµ±</button></div>
                </div>
                <div id="loginStatusMsg" class="text-sm text-blue-600 font-bold hidden mt-2"><i class="fa-solid fa-spinner fa-spin"></i> é©—è­‰ä¸­...</div>
                <div class="bg-slate-50 p-2 rounded text-[10px] text-slate-400 font-mono">Device ID: <span id="myDeviceIdDisplay">...</span></div>
            </div>
        </section>

        <section id="employeeView" class="w-full space-y-6 hidden-section">
            <input type="file" id="avatarInput" accept="image/*" class="hidden" onchange="handleAvatarChange(event)">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in-up">
                <div class="lg:col-span-2 brand-bg rounded-2xl p-6 text-white relative overflow-hidden shadow-xl flex flex-col justify-center min-h-[160px]">
                    <div class="absolute top-0 right-0 bg-white/10 px-3 py-1 rounded-bl-lg text-[10px] font-bold tracking-widest uppercase text-blue-200">Official Notice</div>
                    <div class="relative z-10 flex flex-col md:flex-row items-start gap-4">
                        <div class="bg-white/10 p-3 rounded-xl backdrop-blur-sm shrink-0"><i class="fa-solid fa-bullhorn text-brand-gold text-2xl"></i></div>
                        <div class="w-full"><h3 id="displayBulletinTitle" class="font-bold text-xl text-brand-gold mb-2">...</h3><p id="displayBulletinContent" class="text-slate-100 text-sm leading-relaxed whitespace-pre-wrap opacity-90">...</p><div class="mt-4 text-[10px] text-blue-300 border-t border-blue-800 pt-2 flex justify-between"><span><i class="fa-solid fa-user-tie mr-1"></i> ç®¡ç†è™•ç™¼å¸ƒ</span><span id="displayBulletinDate">--/--</span></div></div>
                    </div>
                </div>
                <div class="lg:col-span-1 glass-panel p-0 overflow-hidden flex flex-col h-auto lg:h-full border-t-4 border-green-500">
                    <div class="p-3 bg-slate-50 border-b border-slate-200 flex justify-between items-center shrink-0"><h3 class="font-bold text-slate-700 text-sm"><i class="fa-solid fa-rss text-green-600 mr-2"></i> åœ˜éšŠå³æ™‚å‹•æ…‹</h3><span class="text-[10px] bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Approved</span></div>
                    <div class="flex-1 overflow-y-auto p-0 custom-scrollbar h-[200px] lg:h-auto" id="activityFeed"><div class="p-4 text-center text-xs text-slate-400">ç›®å‰æ²’æœ‰å³å°‡ç™¼ç”Ÿçš„å‹•æ…‹</div></div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="glass-panel p-6 border-l-4 border-blue-600 fade-in-up relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-blue-50 px-4 py-2 rounded-bl-xl border-b border-l border-blue-100 shadow-sm text-right"><div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">æ¨™æº–: 08:30 - 18:00</div><div class="text-xl font-black text-blue-700 font-mono" id="liveClock">00:00:00</div><div id="clockStatusBadge" class="text-[10px] font-bold text-slate-400 mt-1">æª¢æ¸¬ä¸­...</div></div>
                        <div class="flex justify-between items-center mb-8 mt-2"><h3 class="font-bold text-slate-800 flex items-center gap-2 text-lg"><i class="fa-solid fa-location-dot text-blue-600"></i> å®šä½æ‰“å¡</h3></div>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="handlePunch('ä¸Šç­')" class="btn-punch flex flex-col items-center justify-center p-4 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl shadow-lg shadow-blue-500/30 hover:shadow-xl"><i class="fa-solid fa-sun text-2xl mb-2"></i><span class="font-bold">ä¸Šç­æ‰“å¡</span><span class="text-[10px] opacity-70 mt-1">é²åˆ°åŸºæº–: 08:30</span></button>
                            <button onclick="handlePunch('ä¸‹ç­')" class="btn-punch flex flex-col items-center justify-center p-4 bg-gradient-to-br from-orange-400 to-red-500 text-white rounded-xl shadow-lg shadow-orange-500/30 hover:shadow-xl"><i class="fa-solid fa-moon text-2xl mb-2"></i><span class="font-bold">ä¸‹ç­æ‰“å¡</span><span class="text-[10px] opacity-70 mt-1">åŠ ç­èµ·å§‹: 18:00</span></button>
                        </div>
                    </div>
                    <div class="glass-panel p-6 border-t-4 border-brand-gold fade-in-up">
                        <div class="flex border-b border-gray-200 mb-4">
                            <button class="flex-1 py-2 text-center text-sm tab-active transition-colors" id="tab-leave" onclick="switchAppTab('leave')">è«‹å‡</button>
                            <button class="flex-1 py-2 text-center text-sm tab-inactive transition-colors" id="tab-car" onclick="switchAppTab('car')">å…¬å‹™è»Š</button>
                            <button class="flex-1 py-2 text-center text-sm tab-inactive transition-colors font-bold text-purple-600" id="tab-log" onclick="switchAppTab('log')">å·¥ä½œæ—¥èªŒ</button>
                        </div>
                        <form id="form-leave" onsubmit="handleLeaveSubmit(event)" class="space-y-4">
                            <div class="flex gap-2 mb-2"><button type="button" id="btnModeDay" class="leave-mode-btn leave-mode-active" onclick="switchLeaveMode('day')"><i class="fa-regular fa-calendar mr-1"></i> å…¨å¤©å–®ä½</button><button type="button" id="btnModeTime" class="leave-mode-btn" onclick="switchLeaveMode('time')"><i class="fa-regular fa-clock mr-1"></i> å°æ™‚ (å€é–“)</button></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">å‡åˆ¥</label><select id="leaveType" class="w-full p-2.5 input-modern" onchange="updateImpactInfo()"><option value="ç‰¹ä¼‘">ç‰¹ä¼‘ (å…¨è–ª)</option><option value="ç—…å‡">ç—…å‡ (åŠè–ª)</option><option value="äº‹å‡">äº‹å‡ (ç„¡è–ª)</option><option value="è£œä¼‘">è£œä¼‘ (å…¨è–ª)</option><option value="å©šå‡">å©šå‡ (å…¨è–ª)</option></select></div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">æ—¥æœŸ</label><input type="date" id="leaveDate" class="w-full p-2.5 input-modern"></div>
                                <div id="inputDayMode" class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 mb-1">å¤©æ•¸</label><input type="number" id="leaveDays" min="0.5" step="0.5" value="1" class="w-full p-2.5 input-modern" oninput="updateImpactInfo()"></div>
                                <div id="inputTimeMode" class="hidden md:col-span-2 grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-500 mb-1">é–‹å§‹</label><input type="time" id="leaveStartTime" class="w-full p-2.5 input-modern" onchange="calcTimeDiff()"></div><div><label class="block text-xs font-bold text-slate-500 mb-1">çµæŸ</label><input type="time" id="leaveEndTime" class="w-full p-2.5 input-modern" onchange="calcTimeDiff()"></div><div class="col-span-2 text-xs text-blue-600 bg-blue-50 p-2 rounded text-center">é è¨ˆ: <span id="timeDiffDisplay" class="font-bold">0</span> å°æ™‚</div></div>
                                <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 mb-1">äº‹ç”±</label><input type="text" id="leaveReason" class="w-full p-2.5 input-modern" placeholder="ä¾‹ï¼šè™•ç†ç§äººäº‹å‹™"></div>
                            </div>
                            <div id="impactCard" class="impact-card impact-full p-4 rounded-lg flex justify-between items-center mt-2"><div><div class="font-bold text-sm text-slate-700" id="impactTitle">å…¨è–ª</div><div class="text-xs text-slate-500" id="impactDesc">å·¥è³‡ç…§çµ¦ã€‚</div></div><div class="text-right"><div class="text-xs text-slate-400">é ä¼°æ‰£è–ª</div><div class="font-bold text-lg text-red-500">$<span id="impactAmount">0</span></div></div></div>
                            <button type="submit" class="w-full bg-[#06c755] hover:bg-[#05b34c] text-white font-bold py-3 rounded-lg shadow-lg transition flex justify-center items-center gap-2"><i class="fa-brands fa-line"></i> é€å‡ºä¸¦é€šçŸ¥ LINE</button>
                        </form>
                        <form id="form-car" onsubmit="handleCarSubmit(event)" class="space-y-4 hidden-section"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-500 mb-1">é ç´„æ—¥æœŸ</label><input type="date" id="carDate" class="w-full p-2.5 input-modern"></div><div><label class="block text-xs font-bold text-slate-500 mb-1">æ™‚é–“</label><input type="time" id="carTime" class="w-full p-2.5 input-modern"></div><div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 mb-1">åœ°é» / ç”¨é€”</label><input type="text" id="carLocation" class="w-full p-2.5 input-modern" placeholder="ä¾‹ï¼šå¸‚æ”¿åºœæ´½å…¬"></div></div><button type="submit" class="w-full bg-[#06c755] hover:bg-[#05b34c] text-white font-bold py-3 rounded-lg shadow-lg transition flex justify-center items-center gap-2"><i class="fa-brands fa-line"></i> é€å‡ºä¸¦é€šçŸ¥ LINE</button></form>
                        <form id="form-log" onsubmit="handleLogSubmit(event)" class="space-y-4 hidden-section"><div class="flex justify-between items-end mb-2"><div class="w-2/3"><label class="block text-xs font-bold text-slate-500 mb-1">æ—¥æœŸ</label><input type="date" id="logDate" class="w-full p-2 input-modern"></div><button type="button" onclick="addNewTaskType()" class="text-xs bg-slate-800 text-white px-3 py-2 rounded hover:bg-slate-700 shadow"><i class="fa-solid fa-plus mr-1"></i></button></div><div class="space-y-2" id="logEntriesContainer"><div class="text-center text-sm text-slate-400 py-4"><i class="fa-solid fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</div></div><button type="submit" class="w-full bg-[#06c755] hover:bg-[#05b34c] text-white font-bold py-3 rounded-lg shadow-lg transition flex justify-center items-center gap-2 mt-4"><i class="fa-brands fa-line"></i> åŒ¯å ± LINE</button></form>
                    </div>
                    <div class="glass-panel p-6 border-t-4 border-indigo-500 fade-in-up">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-calendar-check text-indigo-600"></i> æˆ‘çš„è€ƒå‹¤è¡Œäº‹æ›†</h3><div class="flex items-center gap-2 text-sm"><button onclick="changeEmpMonth(-1)" class="bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded text-slate-600"><i class="fa-solid fa-chevron-left"></i></button><span id="empCalTitle" class="font-bold text-slate-700 min-w-[80px] text-center">--/--</span><button onclick="changeEmpMonth(1)" class="bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded text-slate-600"><i class="fa-solid fa-chevron-right"></i></button></div></div>
                        <div class="calendar-header"><div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div></div><div id="empCalendarGrid" class="calendar-grid"><div class="p-4 text-center text-slate-400 col-span-7">è¼‰å…¥ä¸­...</div></div>
                    </div>
                    <div class="glass-panel p-6 fade-in-up"><h3 class="font-bold text-slate-700 mb-4 text-sm uppercase tracking-wider">æœ€è¿‘ç”³è«‹ç´€éŒ„</h3><div class="overflow-x-auto"><table class="w-full text-sm text-left table-fixed-layout"><tbody id="myRequestsTable" class="divide-y divide-slate-100"></tbody></table></div></div>
                </div>
                <div class="space-y-6 lg:col-span-1">
                    <div class="glass-panel p-6 bg-slate-900 text-white fade-in-up">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold flex items-center gap-2"><i class="fa-solid fa-calculator text-brand-gold"></i> è–ªè³‡è©¦ç®—å„€è¡¨</h3></div>
                        <div class="space-y-6">
                            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700"><label class="flex justify-between text-xs text-slate-400 mb-2"><span>è¨­å®šæœˆè–ª</span><span class="text-brand-gold font-mono">$<span id="displaySalary">30,000</span></span></label><input type="range" id="salarySlider" min="27000" max="80000" step="500" value="30000" oninput="updateSalaryFromSlider(this.value)"><input type="number" id="monthlySalary" value="30000" class="w-full bg-slate-900 border border-slate-600 rounded p-1 text-center text-white font-bold" oninput="updateSalaryFromInput(this.value)"></div>
                            <div><div class="flex justify-between text-xs mb-1 text-slate-400"><span>åŠ ç­(å‰2hr)</span><span class="text-white font-bold"><span id="calcHours1Val">0</span> hr</span></div><input type="range" id="calcHours1" min="0" max="20" step="0.5" value="0" oninput="calculateOvertime()"></div>
                            <div><div class="flex justify-between text-xs mb-1 text-slate-400"><span>åŠ ç­(ç¬¬3hrèµ·)</span><span class="text-white font-bold"><span id="calcHours2Val">0</span> hr</span></div><input type="range" id="calcHours2" min="0" max="20" step="0.5" value="0" oninput="calculateOvertime()"></div>
                            <div class="mt-4 pt-4 border-t border-slate-700 space-y-2"><div class="flex justify-between text-xs text-slate-400"><span>åŠ ç­è²» (+)</span><span class="text-green-400 font-mono">$<span id="calcOtTotal">0</span></span></div><div class="flex justify-between text-xs text-slate-400"><span>æ‰£è–ª (-)</span><span class="text-red-400 font-mono">$<span id="calcDeduction">0</span></span></div><div class="flex justify-between items-end mt-2 pt-2 border-t border-slate-700/50"><span class="text-sm font-bold text-white">é ä¼°å¯¦é ˜</span><div class="text-2xl font-black text-brand-gold font-mono">$<span id="calcFinalTotal">0</span></div></div></div>
                        </div>
                    </div>
                    <div class="glass-panel p-6 flex flex-col items-center text-center fade-in-up relative group">
                        <div class="absolute top-3 right-3 text-slate-300 hover:text-blue-500 cursor-pointer" onclick="toggleLegalInfo()"><i class="fa-solid fa-scale-balanced"></i></div>
                        <div class="avatar-hover-container w-24 h-24 mb-2 relative" onclick="triggerAvatarUpload()" title="é»æ“Šæ›´æ›é ­åƒ"><img id="dashboardAvatarImg" src="" class="w-full h-full rounded-full object-cover border-4 border-white shadow-lg bg-slate-100 hidden"><div id="dashboardAvatarPlaceholder" class="w-full h-full bg-slate-100 rounded-full flex items-center justify-center text-4xl text-slate-300 border-4 border-white shadow-lg">ğŸ‘¤</div><div class="avatar-overlay"><i class="fa-solid fa-camera text-white text-xl"></i></div></div>
                        <h2 id="dashboardName" class="text-xl font-bold text-slate-800 mt-2">...</h2>
                        <div class="flex flex-col items-center gap-1 mt-1"><div class="text-xs font-mono text-slate-500 bg-slate-100 px-3 py-1 rounded-lg border border-slate-200 shadow-sm flex items-center"><i class="fa-regular fa-calendar-check mr-1"></i> å…¥è·ï¼š<span id="dashboardJoinDate" class="font-bold mx-1">--</span><span id="dashboardTenure" class="ml-1 bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded text-[10px] font-bold">--</span></div><span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-[10px] font-bold mt-1"><i class="fa-solid fa-check-circle"></i> è£ç½®å·²é–å®š</span></div>
                        <div class="mt-4 w-full grid grid-cols-2 gap-2 text-center"><div class="bg-blue-50 p-2 rounded relative"><div class="absolute -top-2 -left-1 bg-amber-400 text-white text-[9px] px-1 rounded shadow">é€±å¹´åˆ¶</div><div class="text-[10px] text-slate-400 uppercase mt-1">ç‰¹ä¼‘é¡åº¦</div><div class="font-bold text-blue-800 text-lg" id="dashboardTotal">--</div></div><div class="bg-green-50 p-2 rounded"><div class="text-[10px] text-slate-400 uppercase mt-1">ç‰¹ä¼‘å‰©é¤˜</div><div class="font-bold text-green-600 text-lg" id="dashboardRemaining">--</div></div></div>
                        <div class="mt-4 border-t pt-2 w-full"><button onclick="registerWebAuthn()" class="w-full bg-slate-100 text-slate-600 text-xs py-2 rounded hover:bg-slate-200 flex items-center justify-center gap-1"><i class="fa-solid fa-link"></i> ç¶å®šæ­¤è£ç½® (FaceID/æŒ‡ç´‹)</button></div>
                        <div id="legalInfoCard" class="hidden absolute inset-0 bg-white/95 backdrop-blur z-20 rounded-xl p-4 flex flex-col justify-center text-left border border-blue-200"><h4 class="font-bold text-blue-800 mb-2 border-b pb-1">ğŸ“œ å‹åŸºæ³•ç¬¬38æ¢</h4><ul class="text-xs space-y-1 text-slate-600 list-disc pl-4"><li>6æœˆ-1å¹´: 3æ—¥</li><li>1-2å¹´: 7æ—¥</li><li>2-3å¹´: 10æ—¥</li><li>3-5å¹´: 14æ—¥</li><li>5-10å¹´: 15æ—¥</li><li>10å¹´ä»¥ä¸Š: +1/å¹´ (ä¸Šé™30)</li></ul><button onclick="toggleLegalInfo()" class="mt-4 w-full bg-slate-100 text-slate-500 text-xs py-1 rounded hover:bg-slate-200">é—œé–‰</button></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="adminView" class="hidden-section w-full fade-in-up">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-3 glass-panel p-6 border-t-4 border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left text-slate-700"></i> è€ƒå‹¤èˆ‡å ±è¡¨ä¸­å¿ƒ</h2>
                        <div class="flex items-center gap-2">
                            <select id="adminFilterSelect" onchange="handleAdminFilterChange(this.value)" class="p-1.5 text-xs border rounded bg-white text-slate-600 font-bold"><option value="all">ğŸ‘¥ é¡¯ç¤ºå…¨é«”å“¡å·¥</option></select>
                            <button onclick="exportLeaveRequests()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-2 rounded shadow flex items-center gap-1"><i class="fa-solid fa-file-invoice"></i> åŒ¯å‡ºè«‹å‡</button>
                            <button onclick="exportAttendance()" class="bg-green-600 hover:bg-green-500 text-white text-xs px-3 py-2 rounded shadow flex items-center gap-1"><i class="fa-solid fa-file-excel"></i> åŒ¯å‡ºæ‰“å¡</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-60 overflow-y-auto custom-scrollbar"><table class="w-full text-left text-sm table-fixed-layout"><thead class="bg-slate-100 text-slate-500 text-xs"><tr><th class="p-2">å§“å</th><th class="p-2">é¡å‹</th><th class="p-2">æ™‚é–“</th><th class="p-2">ç‹€æ…‹</th><th class="p-2 text-right">ç·¨è¼¯</th></tr></thead><tbody id="attendanceTableBody" class="divide-y divide-slate-100 text-xs"></tbody></table></div>
                </div>

                <div class="lg:col-span-3 glass-panel p-6 border-t-4 border-purple-500 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-calendar-days text-purple-600"></i> åœ˜éšŠå‡ºå‹¤ç¸½è¦½</h2>
                        <div class="flex items-center gap-2">
                            <button onclick="changeMonth(-1)" class="bg-slate-100 hover:bg-slate-200 px-3 py-1 rounded text-slate-600"><i class="fa-solid fa-chevron-left"></i></button>
                            <span id="calendarTitle" class="font-bold text-slate-700 min-w-[100px] text-center">--/--</span>
                            <button onclick="changeMonth(1)" class="bg-slate-100 hover:bg-slate-200 px-3 py-1 rounded text-slate-600"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="calendar-header"><div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div></div>
                    <div id="calendarGrid" class="calendar-grid"><div class="p-4 text-center text-slate-400 text-sm col-span-7">è¼‰å…¥ä¸­...</div></div>
                </div>

                <div class="lg:col-span-2 glass-panel p-6 border-t-4 border-blue-600"><h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-clipboard-check text-blue-600"></i> ç”³è«‹å¯©æ ¸ä¸­å¿ƒ <span id="pendingCountBadge" class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span></h2><div class="overflow-x-auto"><table class="w-full text-left text-sm table-fixed-layout"><tbody id="approvalTableBody" class="divide-y divide-slate-100"></tbody></table></div><div id="noPendingMsg" class="text-center py-8 text-slate-400"><i class="fa-regular fa-circle-check text-4xl mb-2 text-slate-200"></i><p>ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„ç”³è«‹</p></div></div>
                <div class="lg:col-span-1 glass-panel p-6 border-t-4 border-brand-gold"><h2 class="text-lg font-bold text-slate-800 mb-4"><i class="fa-solid fa-bullhorn text-brand-gold mr-2"></i> ç½®é ‚å…¬å‘Šç®¡ç†</h2><input type="text" id="adminBulletinTitle" class="w-full p-2 mb-2 input-modern" placeholder="æ¨™é¡Œ"><textarea id="adminBulletinContent" rows="4" class="w-full p-2 mb-2 input-modern" placeholder="å…§å®¹"></textarea><button onclick="saveBulletin()" class="w-full bg-slate-800 text-white p-2 rounded font-bold hover:bg-slate-700">æ›´æ–°ç½®é ‚ç™¼å¸ƒ</button></div>
                
                <div class="lg:col-span-3 glass-panel p-6"><h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-users mr-1"></i> å“¡å·¥å…¨æ–¹ä½ç®¡ç†</h2><div class="flex flex-wrap gap-2 mb-4 bg-slate-50 p-3 rounded-lg border border-slate-200"><input type="text" id="newAdminName" placeholder="æ–°é€²å“¡å·¥å§“å" class="flex-1 min-w-[120px] p-2 input-modern"><select id="newAdminGender" class="w-20 p-2 input-modern"><option value="M">ç”·</option><option value="F">å¥³</option></select><div class="flex items-center gap-1"><span class="text-xs text-slate-500">åˆ°è·:</span><input type="date" id="newAdminDate" class="w-36 p-2 input-modern"></div><div class="flex items-center gap-1"><span class="text-xs text-slate-500">ç”Ÿæ—¥:</span><input type="date" id="newAdminBirthday" class="w-36 p-2 input-modern"></div><button onclick="addEmployee()" class="bg-blue-600 text-white px-4 rounded font-bold hover:bg-blue-500">æ–°å¢</button></div><div class="overflow-x-auto"><table class="w-full text-left text-sm table-fixed-layout"><thead class="bg-slate-100 text-slate-600 text-xs uppercase"><tr><th class="p-3">å§“å</th><th class="p-3">è³‡æ–™</th><th class="p-3">ç‰¹ä¼‘</th><th class="p-3 w-1/4">è£ç½®</th><th class="p-3 text-right">ç®¡ç†</th></tr></thead><tbody id="adminTableBody" class="divide-y divide-slate-100"></tbody></table></div></div>
                <div class="lg:col-span-3 glass-panel p-6 border-t-4 border-indigo-600 mb-6"><h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-gear text-indigo-600"></i> å…¨åŸŸè–ªè³‡è¦å‰‡ (é è¨­åŸºæº–)</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="space-y-3"><h3 class="font-bold text-sm text-slate-600 border-b pb-1">ğŸ’° åŸºæœ¬åƒæ•¸</h3><div><label class="block text-xs font-bold text-slate-500 mb-1">é è¨­åº•è–ª</label><input type="number" id="settingBaseSalary" class="w-full p-2 input-modern" value="30000"></div><div><label class="block text-xs font-bold text-slate-500 mb-1">æœˆå·¥æ™‚</label><input type="number" id="settingWorkHours" class="w-full p-2 input-modern" value="240"></div></div><div class="space-y-3"><h3 class="font-bold text-sm text-slate-600 border-b pb-1">ğŸ”¥ åŠ ç­è²»å€ç‡</h3><div class="flex gap-2"><div class="flex-1"><label class="block text-xs font-bold text-slate-500 mb-1">å‰2å°æ™‚</label><input type="number" id="settingOtRate1" class="w-full p-2 input-modern bg-slate-100" value="1.34" step="0.01"></div><div class="flex-1"><label class="block text-xs font-bold text-slate-500 mb-1">ç¬¬3å°æ™‚èµ·</label><input type="number" id="settingOtRate2" class="w-full p-2 input-modern bg-slate-100" value="1.67" step="0.01"></div></div></div><div class="space-y-3"><h3 class="font-bold text-sm text-slate-600 border-b pb-1">â° é²åˆ°æ‰£æ¬¾</h3><div class="flex gap-2"><div class="flex-1"><label class="block text-xs font-bold text-slate-500 mb-1">å¯¬é™(åˆ†)</label><input type="number" id="settingLateBuffer" class="w-full p-2 input-modern" value="10"></div><div class="flex-1"><label class="block text-xs font-bold text-slate-500 mb-1">æ¯åˆ†æ‰£è–ª</label><input type="number" id="settingLatePenalty" class="w-full p-2 input-modern" value="0"></div></div><div class="text-[10px] text-slate-500 mt-1">* è¨­ç‚º 0 å‰‡ä¾æ™‚è–ªæ¯”ä¾‹æ‰£æ¬¾</div><button onclick="saveSalarySettings()" class="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-500 shadow mt-2"><i class="fa-solid fa-save mr-1"></i> å„²å­˜è¦å‰‡</button></div></div></div>
            </div>
        </section>

        <div id="historyModal" class="modal-overlay"><div class="modal-content"><div class="p-4 border-b bg-slate-100 flex justify-between items-center"><h3 class="font-bold text-slate-800 text-lg">å‡å‹¤æ•¸æ“šä¸­æ§</h3><button onclick="closeHistory()" class="text-slate-500 hover:text-red-500 text-xl"><i class="fa-solid fa-times"></i></button></div><div class="p-6 overflow-y-auto flex-1 bg-slate-50"><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"><div class="bg-white p-4 rounded-lg border border-blue-200 shadow-sm relative"><div class="absolute top-0 right-0 bg-blue-100 text-blue-800 text-[10px] px-2 py-1 font-bold">ç‰¹ä¼‘ (Annual)</div><div class="mt-2 space-y-2"><div class="flex justify-between items-center text-sm"><span class="text-slate-500">å·²ä½¿ç”¨</span><input type="number" id="adjAnnualUsed" class="border rounded w-16 text-center font-bold text-blue-700" step="0.125"></div></div></div><div class="bg-white p-4 rounded-lg border border-orange-200 shadow-sm relative"><div class="absolute top-0 right-0 bg-orange-100 text-orange-800 text-[10px] px-2 py-1 font-bold">è£œä¼‘ (Comp)</div><div class="mt-2 space-y-2"><div class="flex justify-between items-center text-sm"><span class="text-slate-500">é¤˜é¡</span><input type="number" id="adjCompBalance" class="border rounded w-16 text-center font-bold text-orange-700" step="0.125"></div></div></div><div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm relative"><div class="absolute top-0 right-0 bg-gray-100 text-gray-800 text-[10px] px-2 py-1 font-bold">ç—…/äº‹å‡</div><div class="mt-2 space-y-1"><div class="flex justify-between items-center text-sm"><span class="text-slate-500">ç—…å‡</span><input type="number" id="adjSickUsed" class="border rounded w-16 text-center font-bold text-gray-700" step="0.125"></div><div class="flex justify-between items-center text-sm"><span class="text-slate-500">äº‹å‡</span><input type="number" id="adjPersonalUsed" class="border rounded w-16 text-center font-bold text-gray-700" step="0.125"></div></div></div></div><button onclick="saveAllAdjustments()" class="w-full bg-slate-800 text-white py-2 rounded mb-6 font-bold hover:bg-slate-700 shadow-md">å„²å­˜ä¿®æ­£</button><h4 class="font-bold text-slate-700 mb-2">ğŸ“œ ç”³è«‹ç´€éŒ„</h4><div class="overflow-x-auto bg-white rounded-lg border border-slate-200"><table class="w-full text-sm text-left table-fixed-layout"><tbody id="historyTableBody" class="divide-y divide-slate-100"></tbody></table></div></div></div></div>
        <div id="salaryModal" class="modal-overlay"><div class="modal-content max-w-lg"><div class="p-4 border-b bg-indigo-600 text-white flex justify-between items-center"><h3 class="font-bold">å€‹åˆ¥è–ªè³‡è¨­å®š</h3><button onclick="closeSalaryModal()" class="text-white hover:text-red-300"><i class="fa-solid fa-times"></i></button></div><div class="p-6 space-y-4 bg-white"><input type="hidden" id="salaryEmpId"><div class="bg-yellow-50 p-3 rounded text-xs text-yellow-800 border border-yellow-200"><i class="fa-solid fa-circle-exclamation mr-1"></i> è¨­å®šæ­¤è™•å°‡æœƒã€Œè¦†è“‹ã€å…¨åŸŸé è¨­å€¼ã€‚</div><div><label class="block text-xs font-bold text-slate-500 mb-1">åº•è–ª</label><input type="number" id="indBaseSalary" class="w-full p-2 input-modern" placeholder="é è¨­: 30000"></div><div><label class="block text-xs font-bold text-slate-500 mb-1">æœˆå·¥æ™‚</label><input type="number" id="indWorkHours" class="w-full p-2 input-modern" placeholder="é è¨­: 240"></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-500 mb-1">åŠ ç­å€ç‡1</label><input type="number" id="indOtRate1" class="w-full p-2 input-modern" placeholder="é è¨­: 1.34"></div><div><label class="block text-xs font-bold text-slate-500 mb-1">åŠ ç­å€ç‡2</label><input type="number" id="indOtRate2" class="w-full p-2 input-modern" placeholder="é è¨­: 1.67"></div></div><button onclick="saveIndividualSalary()" class="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-500 shadow mt-2">å„²å­˜å€‹äººè¨­å®š</button></div></div></div>
        
        <div id="adminEditModal" class="modal-overlay">
            <div class="modal-content max-w-sm">
                <div class="p-4 border-b bg-slate-800 text-white flex justify-between items-center">
                    <h3 class="font-bold"><i class="fa-solid fa-pen-to-square mr-2"></i> ä¿®æ”¹è€ƒå‹¤ç‹€æ…‹</h3>
                    <button onclick="closeAdminEdit()" class="text-white hover:text-red-300"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-6 space-y-4 bg-white">
                    <input type="hidden" id="editAttKey">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">ç‹€æ…‹ (Status)</label>
                        <select id="editAttStatus" class="w-full p-2 input-modern border rounded">
                            <option value="æ­£å¸¸">ğŸŸ¢ æ­£å¸¸ (Normal)</option>
                            <option value="é²åˆ°">ğŸ”´ é²åˆ° (Late)</option>
                            <option value="æ—©é€€">ğŸŸ  æ—©é€€ (Early)</option>
                            <option value="åŠ ç­">ğŸŸ£ åŠ ç­ (Overtime)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">æ™‚é–“ (Time)</label>
                        <input type="text" id="editAttTime" class="w-full p-2 input-modern border rounded" placeholder="ä¾‹å¦‚ 08:25:00">
                    </div>
                    <button onclick="saveAdminEdit()" class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-500 shadow-lg mt-2">å„²å­˜ä¿®æ­£</button>
                    <button onclick="deleteAttendance()" class="w-full bg-red-50 text-red-600 py-2 rounded font-bold text-xs hover:bg-red-100 border border-red-200 mt-2">åˆªé™¤æ­¤ç´€éŒ„</button>
                </div>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyCcSH0HQutt6rYcFWjCKOpTSWkBDeinyvw", authDomain: "homego-system.firebaseapp.com", databaseURL: "https://homego-system-default-rtdb.firebaseio.com", projectId: "homego-system", storageBucket: "homego-system.firebasestorage.app", messagingSenderId: "679007509034", appId: "1:679007509034:web:df50010c5ab8cd7f964153" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const ADMIN_PASSWORD = "8888";

        let employees = {};
        let requests = {};
        let attendance = {};
        let bulletin = { title: "æ­¡è¿", content: "...", date: "" };
        let settings = {}; 
        let currentUserId = null;
        let currentDeduction = 0;
        let currentModalEmpId = null;
        let leaveMode = 'day';
        let currentCalDate = new Date();
        let currentEmpCalDate = new Date();
        let adminFilterId = 'all';

        const DEFAULT_TASKS = ["åœ°æ”¿éæˆ¶", "è²¸æ¬¾", "çµæ¡ˆè³‡æ–™æ•´ç†", "éæ°´é›»", "ç”¨å°", "å°ä¿", "å¡—éŠ·"];
        let taskOptions = DEFAULT_TASKS;

        let myDeviceId = localStorage.getItem('hge_security_did');
        if (!myDeviceId) {
            myDeviceId = 'DID-' + Math.random().toString(36).substr(2, 6).toUpperCase() + '-' + Date.now().toString(36).substr(-4);
            localStorage.setItem('hge_security_did', myDeviceId);
        }
        document.getElementById('myDeviceIdDisplay').innerText = myDeviceId;

        setInterval(() => {
            const now = new Date();
            document.getElementById('liveClock').innerText = now.toLocaleTimeString('zh-TW', {hour12: false});
            const min = now.getHours() * 60 + now.getMinutes();
            const badge = document.getElementById('clockStatusBadge');
            if(min < 510) { badge.className="text-[10px] font-bold text-green-600 mt-1"; badge.innerText="æ—©å®‰ï¼æº–æ™‚"; }
            else if(min >= 510 && min < 1080) { badge.className="text-[10px] font-bold text-orange-600 mt-1"; badge.innerText="ä¸Šç­ä¸­"; }
            else { badge.className="text-[10px] font-bold text-purple-600 mt-1"; badge.innerText="ä¸‹ç­/åŠ ç­"; }
        }, 1000);

        window.toggleLegalInfo = () => document.getElementById('legalInfoCard').classList.toggle('hidden');
        window.switchView = (view) => {
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden-section'));
            if(view === 'employee') {
                document.getElementById('loginSection').classList.remove('hidden-section');
                currentUserId = null; updateEmpSelect();
            } else {
                document.getElementById('adminView').classList.remove('hidden-section');
            }
        };
        window.checkAdminLogin = async () => {
            const { value: pass } = await Swal.fire({ title: 'ç®¡ç†å“¡é©—è­‰', input: 'password', showCancelButton: true });
            if (pass === ADMIN_PASSWORD) window.switchView('admin'); else if(pass) Swal.fire('éŒ¯èª¤', 'å¯†ç¢¼ä¸æ­£ç¢º', 'error');
        };
        window.switchAppTab = (tab) => {
            ['leave','car','log'].forEach(t => {
                document.getElementById('tab-'+t).className = (t===tab) ? 'flex-1 py-2 text-center text-sm tab-active transition-colors' : 'flex-1 py-2 text-center text-sm tab-inactive transition-colors';
                document.getElementById('form-'+t).classList.add('hidden-section');
            });
            document.getElementById('form-'+tab).classList.remove('hidden-section');
        };

        const bufferDecode = (value) => Uint8Array.from(atob(value), c => c.charCodeAt(0));
        const bufferEncode = (value) => btoa(String.fromCharCode.apply(null, new Uint8Array(value))).replace(/\+/g, "-").replace(/\//g, "_").replace(/=/g, "");

        window.registerWebAuthn = async () => {
            if (!currentUserId) return;
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') return Swal.fire('å®‰å…¨é™åˆ¶', 'ç”Ÿç‰©è¾¨è­˜åƒ…æ”¯æ´ HTTPS æˆ– Localhost ç’°å¢ƒ', 'error');
            try {
                const publicKey = { challenge: new Uint8Array(32), rp: { name: "HomeGo HR System" }, user: { id: Uint8Array.from(currentUserId, c => c.charCodeAt(0)), name: employees[currentUserId].name, displayName: employees[currentUserId].name }, pubKeyCredParams: [{ type: "public-key", alg: -7 }] };
                const credential = await navigator.credentials.create({ publicKey });
                const credentialId = bufferEncode(credential.rawId);
                await update(ref(db, `employees/${currentUserId}`), { webAuthnId: credentialId });
                Swal.fire('ç¶å®šæˆåŠŸ', 'æ‚¨ç¾åœ¨å¯ä»¥ä½¿ç”¨ç”Ÿç‰©è¾¨è­˜ç™»å…¥', 'success');
            } catch (err) { console.error(err); Swal.fire('ç¶å®šå¤±æ•—', err.message, 'error'); }
        };

        window.handleBiometricLogin = async () => {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') return Swal.fire('å®‰å…¨é™åˆ¶', 'ç”Ÿç‰©è¾¨è­˜åƒ…æ”¯æ´ HTTPS æˆ– Localhost ç’°å¢ƒ', 'error');
            try {
                const publicKey = { challenge: new Uint8Array(32) };
                const credential = await navigator.credentials.get({ publicKey });
                const credentialId = bufferEncode(credential.rawId);
                const emp = Object.values(employees).find(e => e.webAuthnId === credentialId);
                if (emp) { Swal.fire({ title: `æ­¡è¿å›ä¾†, ${emp.name}`, icon: 'success', timer: 1500, showConfirmButton: false }); loadEmployeeDashboard(emp.id); } else { Swal.fire('é©—è­‰å¤±æ•—', 'æ­¤è£ç½®å°šæœªç¶å®šä»»ä½•å“¡å·¥', 'error'); }
            } catch (err) { console.error(err); }
        };

        onValue(ref(db), (snapshot) => {
            const data = snapshot.val() || {};
            employees = data.employees || {};
            requests = data.requests || {};
            attendance = data.attendance || {};
            bulletin = data.bulletin || { title: "å°šç„¡å…¬å‘Š", content: "", date: "" };
            settings = data.settings || {}; 
            taskOptions = data.settings?.taskTypes || DEFAULT_TASKS;

            if(settings.salary) {
                document.getElementById('settingBaseSalary').value = settings.salary.baseSalary || 30000;
                document.getElementById('settingWorkHours').value = settings.salary.workHours || 240;
                document.getElementById('settingOtRate1').value = settings.salary.otRate1 || 1.34;
                document.getElementById('settingOtRate2').value = settings.salary.otRate2 || 1.67;
                document.getElementById('settingLateBuffer').value = settings.salary.lateBuffer || 10;
                document.getElementById('settingLatePenalty').value = settings.salary.latePenalty || 0;
            }

            renderLogForm(); 
            
            const today = new Date();
            const todayStr = (today.getMonth()+1).toString().padStart(2,'0') + '-' + today.getDate().toString().padStart(2,'0');
            const todayFullDate = today.toLocaleDateString();
            let bdayNames = [];
            Object.values(employees).forEach(emp => { if(emp.birthday && emp.birthday.slice(5) === todayStr) bdayNames.push(emp.name); });
            if (bdayNames.length > 0 && bulletin.date !== todayFullDate) {
                const newTitle = "ğŸ‚ ç”Ÿæ—¥å¿«æ¨‚ï¼";
                const newContent = `ä»Šå¤©æ˜¯ ${bdayNames.join(' & ')} çš„ç”Ÿæ—¥ï¼\nç¥ç¦å·¥ä½œé †åˆ©ï¼Œèº«é«”å¥åº·ï¼ğŸ‰\n(ç³»çµ±è‡ªå‹•ç™¼å¸ƒ)`;
                set(ref(db, 'bulletin'), { title: newTitle, content: newContent, date: todayFullDate });
            }

            updateEmpSelect(); updateAdminFilterSelect(); renderBulletin(); renderActivityFeed();
            if (currentUserId) { renderEmployeeStats(employees[currentUserId]); window.renderEmployeePersonalCalendar(); }
            renderAdminTable(); window.renderApprovalQueue(); renderAttendanceLog(); window.renderMonthCalendar();
            document.getElementById('empSelect').disabled = false;
        });

        window.updateEmpSelect = () => { 
            const select = document.getElementById('empSelect');
            const container = document.getElementById('userSelectContainer');
            const lockedMsg = document.getElementById('deviceLockedMsg');
            const lockedName = document.getElementById('lockedUserName');
            
            select.innerHTML = '<option value="">-- è«‹é¸æ“‡æ‚¨çš„å§“å (é¦–æ¬¡éœ€ç¶å®š) --</option>'; 
            
            let boundUser = null;
            Object.values(employees).forEach(emp => { if (emp.devices && emp.devices.includes(myDeviceId)) boundUser = emp; });

            if (boundUser) {
                container.classList.add('hidden');
                lockedMsg.classList.remove('hidden');
                lockedName.innerText = boundUser.name;
            } else {
                container.classList.remove('hidden');
                lockedMsg.classList.add('hidden');
                Object.values(employees).forEach(emp => { select.innerHTML += `<option value="${emp.id}">${emp.name}</option>`; });
            }
        };

        window.tryBindAndLogin = () => {
            const id = document.getElementById('empSelect').value;
            if (!id) return;
            const emp = employees[id];
            const currentDevices = emp.devices || [];
            if (currentDevices.includes(myDeviceId)) { loadEmployeeDashboard(id); return; }
            if (currentDevices.length >= 3) { Swal.fire({ icon: 'error', title: 'ç¶å®šå¤±æ•—', text: 'æ‚¨çš„å¸³è™Ÿå·²ç¶å®š 3 å°è£ç½® (ä¸Šé™)ã€‚è«‹è¯ç¹«ç®¡ç†å“¡è§£ç¶ã€‚' }); document.getElementById('empSelect').value = ""; return; }
            Swal.fire({ title: 'ğŸ”’ è£ç½®ç¶å®šè­¦å‘Š', html: `ç‚ºäº†é˜²æ­¢ä»£æ‰“å¡ï¼Œç¶å®šå¾Œæ­¤è£ç½®å°‡<b>é–å®šç‚º ${emp.name} å°ˆç”¨</b>ã€‚<br>æ‚¨å°‡ç„¡æ³•åœ¨æ­¤è£ç½®ç™»å…¥å…¶ä»–å¸³è™Ÿã€‚<br><br>ç¢ºå®šè¦ç¶å®šå—ï¼Ÿ`, icon: 'warning', showCancelButton: true, confirmButtonText: 'ç¢ºèªç¶å®šä¸¦ç™»å…¥', confirmButtonColor: '#d33', cancelButtonText: 'å–æ¶ˆ' }).then((result) => {
                if (result.isConfirmed) { const newDevices = [...currentDevices, myDeviceId]; update(ref(db, `employees/${id}`), { devices: newDevices }).then(() => { Swal.fire('ç¶å®šæˆåŠŸ', 'è£ç½®å·²é–å®š', 'success'); loadEmployeeDashboard(id); }); } else { document.getElementById('empSelect').value = ""; }
            });
        };

        window.loadEmployeeDashboard = (fid) => {
            let targetId = fid;
            if (!targetId) {
                const lockedName = document.getElementById('lockedUserName').innerText;
                if(lockedName !== '--') { Object.values(employees).forEach(emp => { if (emp.devices && emp.devices.includes(myDeviceId)) targetId = emp.id; }); } else { targetId = document.getElementById('empSelect').value; }
            }
            if(targetId) { currentUserId = targetId; document.getElementById('loginSection').classList.add('hidden-section'); document.getElementById('employeeView').classList.remove('hidden-section'); renderEmployeeStats(employees[currentUserId]); window.renderEmployeePersonalCalendar(); }
        };

        window.handleAdminFilterChange = (val) => { 
            adminFilterId = val; 
            renderAttendanceLog(); 
            window.renderMonthCalendar();
        };
        
        window.updateAdminFilterSelect = () => {
            const sel = document.getElementById('adminFilterSelect');
            let html = '<option value="all">ğŸ‘¥ é¡¯ç¤ºå…¨é«”å“¡å·¥</option>';
            Object.values(employees).forEach(emp => { html += `<option value="${emp.id}">${emp.name}</option>`; });
            sel.innerHTML = html;
            sel.value = adminFilterId;
        };

        window.changeEmpMonth = (delta) => { currentEmpCalDate.setMonth(currentEmpCalDate.getMonth() + delta); window.renderEmployeePersonalCalendar(); };
        window.renderEmployeePersonalCalendar = () => {
            const grid = document.getElementById('empCalendarGrid'); const title = document.getElementById('empCalTitle'); if(!grid || !title || !currentUserId) return;
            grid.innerHTML = ''; const year = currentEmpCalDate.getFullYear(); const month = currentEmpCalDate.getMonth(); title.innerText = `${year}å¹´ ${month+1}æœˆ`;
            const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const todayStr = new Date().toISOString().split('T')[0];
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="calendar-cell bg-slate-50"></div>`;
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const isToday = (dateStr === todayStr); let evHtml = '';
                const atts = Object.values(attendance).filter(a => { const aDate = new Date(a.timestamp); return a.empId === currentUserId && aDate.getFullYear()===year && aDate.getMonth()===month && aDate.getDate()===d; });
                atts.forEach(a => { 
                    const isLate = a.status === 'é²åˆ°'; 
                    const isOt = a.status === 'åŠ ç­';
                    let color = 'text-blue-600 bg-blue-50 border-blue-200';
                    if (isLate) color = 'text-red-600 bg-red-50 border-red-200';
                    if (isOt) color = 'text-purple-600 bg-purple-50 border-purple-200';
                    
                    const timeOnly = a.timeStr.split(':')[0] + ':' + a.timeStr.split(':')[1]; 
                    evHtml += `<div class="${color} text-[9px] px-1 rounded mt-1 border truncate">${a.type} <strong>${timeOnly}</strong></div>`; 
                });
                const reqs = Object.values(requests).filter(r => r.empId === currentUserId && r.status === 'approved' && r.date === dateStr);
                reqs.forEach(r => { evHtml += `<div class="text-slate-500 bg-slate-100 border border-slate-200 text-[9px] px-1 rounded mt-1 truncate">[${r.category==='car'?'è»Š':r.type}]</div>`; });
                grid.innerHTML += `<div class="calendar-cell ${isToday?'cal-today':''}"><div class="text-right font-bold text-xs text-slate-600">${d}</div><div class="overflow-y-auto max-h-[70px] custom-scrollbar">${evHtml}</div></div>`;
            }
        };

        window.changeMonth = (delta) => { currentCalDate.setMonth(currentCalDate.getMonth() + delta); window.renderMonthCalendar(); };
        window.renderMonthCalendar = () => {
            const grid = document.getElementById('calendarGrid'); const title = document.getElementById('calendarTitle'); if(!grid || !title) return;
            grid.innerHTML = ''; const year = currentCalDate.getFullYear(); const month = currentCalDate.getMonth(); title.innerText = `${year}å¹´ ${month+1}æœˆ`;
            const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const todayStr = new Date().toISOString().split('T')[0];
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="calendar-cell bg-slate-50"></div>`;
            
            let dataAtt = Object.values(attendance);
            let dataReq = Object.values(requests);
            if (adminFilterId !== 'all') {
                dataAtt = dataAtt.filter(a => a.empId === adminFilterId);
                dataReq = dataReq.filter(r => r.empId === adminFilterId);
            }

            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const isToday = (dateStr === todayStr); const isPast = (new Date(dateStr) < new Date().setHours(0,0,0,0)); let evHtml = '';
                
                const atts = dataAtt.filter(a => { const aDate = new Date(a.timestamp); return aDate.getFullYear()===year && aDate.getMonth()===month && aDate.getDate()===d; });
                atts.forEach(a => { 
                    let colorClass = 'text-blue-600 bg-blue-50 border-blue-200';
                    if (a.status === 'é²åˆ°') colorClass = 'text-red-600 bg-red-50 border-red-200';
                    if (a.status === 'åŠ ç­') colorClass = 'text-purple-600 bg-purple-50 border-purple-200';
                    const timeOnly = a.timeStr.split(':')[0] + ':' + a.timeStr.split(':')[1]; 
                    evHtml += `<div class="${colorClass} text-[10px] px-1 rounded mt-1 border truncate"><strong>${timeOnly}</strong> ${a.empName} <span class="opacity-75">(${a.status})</span></div>`; 
                });
                
                const reqs = dataReq.filter(r => r.status === 'approved' && r.date === dateStr);
                reqs.forEach(r => { evHtml += `<div class="text-slate-500 bg-slate-100 border border-slate-200 text-[10px] px-1 rounded mt-1 truncate">[${r.category==='car'?'è»Š':r.type}] ${r.empName}</div>`; });
                
                grid.innerHTML += `<div class="calendar-cell ${isToday?'cal-today':''} ${isPast?'cal-past':''}"><div class="text-right font-bold text-xs ${[0,6].includes(new Date(dateStr).getDay())?'text-red-400':'text-slate-600'}">${d}</div><div class="overflow-y-auto max-h-[70px] custom-scrollbar">${evHtml}</div></div>`;
            }
        };

        window.exportAttendance = () => { 
            const rows = [['å§“å', 'é¡å‹', 'æ—¥æœŸ', 'æ™‚é–“', 'ç‹€æ…‹']]; 
            let data = Object.values(attendance).sort((a,b)=>b.timestamp-a.timestamp);
            if(adminFilterId !== 'all') data = data.filter(a => a.empId === adminFilterId); 
            data.forEach(a => { rows.push([a.empName, a.type, a.dateStr, a.timeStr, a.status]); }); 
            downloadCSV(rows, `æ‰“å¡ç´€éŒ„_${adminFilterId==='all'?'å…¨é«”':employees[adminFilterId].name}.csv`); 
        };
        window.exportLeaveRequests = () => { 
            const rows = [['å§“å', 'é¡åˆ¥', 'å‡åˆ¥/åœ°é»', 'æ—¥æœŸ', 'å¤©æ•¸/æ™‚é–“', 'äº‹ç”±', 'ç‹€æ…‹']]; 
            let data = Object.values(requests);
            if(adminFilterId !== 'all') data = data.filter(r => r.empId === adminFilterId); 
            data.forEach(r => { rows.push([r.empName, r.category==='car'?'ç”¨è»Š':'è«‹å‡', r.category==='car'?r.location:r.type, r.date, r.days, r.reason, r.status]); }); 
            downloadCSV(rows, `è«‹å‡æ˜ç´°_${adminFilterId==='all'?'å…¨é«”':employees[adminFilterId].name}.csv`); 
        };
        function downloadCSV(rows, filename) { let csvContent = "\uFEFF"; rows.forEach(row => { csvContent += row.join(",") + "\n"; }); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); if (link.download !== undefined) { const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", filename); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); } }
        
        window.openSalaryModal = (empId) => { const emp = employees[empId]; if(!emp) return; document.getElementById('salaryEmpId').value = empId; const s = emp.salarySettings || {}; document.getElementById('indBaseSalary').value = s.baseSalary || ''; document.getElementById('indWorkHours').value = s.workHours || ''; document.getElementById('indOtRate1').value = s.otRate1 || ''; document.getElementById('indOtRate2').value = s.otRate2 || ''; document.getElementById('salaryModal').style.display = 'flex'; };
        window.closeSalaryModal = () => document.getElementById('salaryModal').style.display = 'none';
        window.saveIndividualSalary = () => { const id = document.getElementById('salaryEmpId').value; const settings = { baseSalary: document.getElementById('indBaseSalary').value, workHours: document.getElementById('indWorkHours').value, otRate1: document.getElementById('indOtRate1').value, otRate2: document.getElementById('indOtRate2').value }; update(ref(db, `employees/${id}/salarySettings`), settings).then(() => { Swal.fire('æˆåŠŸ', 'å€‹äººè–ªè³‡è¨­å®šå·²å„²å­˜', 'success'); closeSalaryModal(); }); };
        function getSalaryConfig(empId) { const emp = employees[empId] || {}; const ind = emp.salarySettings || {}; const glo = settings.salary || {}; return { base: parseInt(ind.baseSalary || glo.baseSalary || 30000), hours: parseInt(ind.workHours || glo.workHours || 240), r1: parseFloat(ind.otRate1 || glo.otRate1 || 1.34), r2: parseFloat(ind.otRate2 || glo.otRate2 || 1.67), latePen: parseInt(glo.latePenalty || 0) }; }
        window.calculateOvertime = () => { if(!currentUserId) return; const config = getSalaryConfig(currentUserId); const inputSalary = parseInt(document.getElementById('monthlySalary').value); const base = inputSalary || config.base; const hourly = Math.round(base / config.hours); const h1 = parseFloat(document.getElementById('calcHours1').value); const h2 = parseFloat(document.getElementById('calcHours2').value); const ot = Math.round((h1 * hourly * config.r1) + (h2 * hourly * config.r2)); document.getElementById('calcHours1Val').innerText = h1; document.getElementById('calcHours2Val').innerText = h2; document.getElementById('calcOtTotal').innerText = ot.toLocaleString(); document.getElementById('calcDeduction').innerText = currentDeduction.toLocaleString(); document.getElementById('calcFinalTotal').innerText = (base + ot - currentDeduction).toLocaleString(); };
        window.updateImpactInfo = () => { if(!currentUserId) return; const type = document.getElementById('leaveType').value; const days = parseFloat(document.getElementById('leaveDays').value) || 0; const config = getSalaryConfig(currentUserId); const inputSalary = parseInt(document.getElementById('monthlySalary').value); const hourly = Math.round((inputSalary || config.base) / config.hours); const daily = hourly * 8; const card = document.getElementById('impactCard'); let ded = 0; card.classList.remove('impact-full','impact-half','impact-none'); if(['ç‰¹ä¼‘','è£œä¼‘','å©šå‡'].includes(type)) { card.classList.add('impact-full'); document.getElementById('impactTitle').innerText="å…¨è–ª"; document.getElementById('impactDesc').innerText="å·¥è³‡ç…§çµ¦"; } else if(type==='ç—…å‡') { card.classList.add('impact-half'); document.getElementById('impactTitle').innerText="åŠè–ª"; document.getElementById('impactDesc').innerText="æ‰£é™¤åŠè–ª"; ded = Math.round(daily * days * 0.5); } else { card.classList.add('impact-none'); document.getElementById('impactTitle').innerText="ç„¡è–ª"; if(type==='é²åˆ°' && config.latePen > 0) { document.getElementById('impactDesc').innerText="ä¾è¨­å®šæ‰£æ¬¾"; ded = Math.round(daily * days); } else { document.getElementById('impactDesc').innerText="ä¾å·¥æ™‚æ¯”ä¾‹æ‰£é™¤"; ded = Math.round(daily * days); } } document.getElementById('impactAmount').innerText = ded.toLocaleString(); currentDeduction = ded; window.calculateOvertime(); };

        function renderEmployeeStats(emp) {
            if(!emp) return;
            document.getElementById('dashboardName').innerText = emp.name;
            const avatarImg = document.getElementById('dashboardAvatarImg'); const avatarPlace = document.getElementById('dashboardAvatarPlaceholder');
            if (emp.avatar) { avatarImg.src = emp.avatar; avatarImg.classList.remove('hidden'); avatarPlace.classList.add('hidden'); } else { avatarImg.classList.add('hidden'); avatarPlace.classList.remove('hidden'); }
            const calc = calculateLeave(emp.joinDate); document.getElementById('dashboardRemaining').innerText = (calc.days - (emp.stats?.annual||0)) + " å¤©"; document.getElementById('dashboardTotal').innerText = calc.days + " å¤©"; document.getElementById('dashboardJoinDate').innerText = emp.joinDate || "æœªè¨­å®š"; document.getElementById('dashboardTenure').innerText = calculateTenure(emp.joinDate);
            const tbody = document.getElementById('myRequestsTable'); const myReqs = Object.values(requests).filter(r => r.empId === emp.id).sort((a,b) => b.timestamp - a.timestamp).slice(0, 5); tbody.innerHTML = myReqs.length ? myReqs.map(r => `<tr class="border-b"><td class="p-2 text-xs text-slate-500">${r.date.slice(5)}</td><td class="p-2 font-bold text-slate-700">${r.category==='car'?'ç”¨è»Š':r.type}</td><td class="p-2 text-right"><span class="px-2 py-0.5 rounded text-[10px] ${r.status==='approved'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}">${r.status}</span></td></tr>`).join('') : '<tr><td colspan="3" class="p-4 text-center text-slate-400 text-xs">ç„¡ç´€éŒ„</td></tr>';
            const conf = getSalaryConfig(emp.id); document.getElementById('monthlySalary').value = conf.base; document.getElementById('displaySalary').innerText = conf.base.toLocaleString(); document.getElementById('salarySlider').value = conf.base;
        }
        window.triggerAvatarUpload = () => document.getElementById('avatarInput').click();
        window.handleAvatarChange = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { const img = new Image(); img.onload = function() { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const MAX_WIDTH = 300; const scaleSize = MAX_WIDTH / Math.max(img.width, img.height); canvas.width = img.width * scaleSize; canvas.height = img.height * scaleSize; ctx.drawImage(img, 0, 0, canvas.width, canvas.height); const dataUrl = canvas.toDataURL('image/jpeg', 0.7); update(ref(db, `employees/${currentUserId}`), { avatar: dataUrl }).then(() => Swal.fire('æˆåŠŸ', 'å¤§é ­ç…§å·²æ›´æ–°', 'success')); }; img.src = e.target.result; }; reader.readAsDataURL(file); };
        function renderAdminTable() { const tbody = document.getElementById('adminTableBody'); tbody.innerHTML = ''; Object.values(employees).forEach(emp => { const devs = (emp.devices||[]).map((d,i)=>`<span class="device-badge cursor-pointer hover:bg-red-100" onclick="unbindDevice('${emp.id}',${i})">ğŸ“± ${d.substr(0,4)}</span>`).join(' '); const calc = calculateLeave(emp.joinDate); const avatarHTML = emp.avatar ? `<img src="${emp.avatar}" class="w-8 h-8 rounded-full border border-slate-200 object-cover mr-2 inline-block">` : `<div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-xs mr-2 inline-block">ğŸ‘¤</div>`; tbody.innerHTML += `<tr class="border-b text-sm"><td class="p-3 font-bold text-slate-800 flex items-center">${avatarHTML} ${emp.name}</td><td class="p-3"><div class="text-xs text-slate-500">${emp.joinDate||'--'}</div><div class="text-xs text-slate-400">${calculateTenure(emp.joinDate)}</div></td><td class="p-3">å‰©:${calc.days-(emp.stats?.annual||0)}</td><td class="p-3">${devs || 'æœªç¶å®š'}</td><td class="p-3 text-right"><button onclick="openSalaryModal('${emp.id}')" class="text-indigo-600 mr-2" title="è–ªè³‡"><i class="fa-solid fa-sack-dollar"></i></button><button onclick="openHistory('${emp.id}')" class="text-blue-600"><i class="fa-solid fa-pen-to-square"></i></button></td></tr>`; }); }
        window.saveSalarySettings = () => { const s = { baseSalary: document.getElementById('settingBaseSalary').value, workHours: document.getElementById('settingWorkHours').value, otRate1: document.getElementById('settingOtRate1').value, otRate2: document.getElementById('settingOtRate2').value, lateBuffer: document.getElementById('settingLateBuffer').value, latePenalty: document.getElementById('settingLatePenalty').value }; update(ref(db, 'settings/salary'), s).then(() => Swal.fire('å…¨åŸŸè¨­å®šå·²å„²å­˜', '', 'success')); };
        function calculateLeave(joinDate) { if(!joinDate) return { days: 0, rule: "æœªè¨­å®š" }; const years = (new Date() - new Date(joinDate)) / (1000*60*60*24*365.25); let d = 0; if(years<0.5) d=0; else if(years<1) d=3; else if(years<2) d=7; else if(years<3) d=10; else if(years<5) d=14; else if(years<10) d=15; else d=Math.min(30, 15+Math.floor(years-10)); return { days: d, rule: "é€±å¹´åˆ¶" }; }
        function calculateTenure(d) { if(!d) return "--"; const m = Math.floor((new Date() - new Date(d)) / (1000*60*60*24*30.44)); return m < 12 ? `${m}å€‹æœˆ` : `${Math.floor(m/12)}å¹´${m%12}æœˆ`; }
        
        // [Feature 1] Logic Updated
        window.handlePunch = (t) => { 
            if(!currentUserId) return; 
            navigator.geolocation.getCurrentPosition(p=>{ 
                const now = new Date();
                const nowMinutes = now.getHours() * 60 + now.getMinutes();
                let status = "æ­£å¸¸";
                
                // 08:30 = 8*60 + 30 = 510
                if (t === 'ä¸Šç­' && nowMinutes > 510) status = "é²åˆ°";
                // 18:00 = 18*60 = 1080
                if (t === 'ä¸‹ç­' && nowMinutes > 1080) status = "åŠ ç­";

                push(ref(db,'attendance'),{
                    empId:currentUserId,
                    empName:employees[currentUserId].name,
                    type:t,
                    timestamp:now.getTime(),
                    dateStr:now.toLocaleDateString(),
                    timeStr:now.toLocaleTimeString(),
                    location:`${p.coords.latitude},${p.coords.longitude}`,
                    status: status
                }); 
                Swal.fire('æ‰“å¡æˆåŠŸ', `${t} (${status})`,'success'); 
            }); 
        };

        window.handleLogSubmit = (e) => { e.preventDefault(); Swal.fire('æ¨¡æ“¬ç™¼é€','å·²é–‹å•Ÿ LINE','success'); };
        window.renderApprovalQueue = () => { const t=document.getElementById('approvalTableBody'); t.innerHTML=''; Object.entries(requests).filter(([k,v])=>v.status==='pending').forEach(([k,r])=>{ t.innerHTML+=`<tr class="border-b"><td class="p-2">${r.empName}</td><td class="p-2">${r.type}</td><td class="p-2 text-right"><button onclick="processRequest('${k}','approve')" class="text-green-600 mr-2">âœ”</button><button onclick="processRequest('${k}','reject')" class="text-red-600">âœ˜</button></td></tr>`; }); };
        window.processRequest = (k,s) => update(ref(db,`requests/${k}`),{status:s==='approve'?'approved':'rejected'}).then(()=>window.renderApprovalQueue());
        window.openHistory = (id) => { currentModalEmpId=id; document.getElementById('historyModal').style.display='flex'; };
        window.closeHistory = () => document.getElementById('historyModal').style.display='none';
        window.unbindDevice = (id, idx) => { const nd = [...employees[id].devices]; nd.splice(idx, 1); update(ref(db, `employees/${id}`), { devices: nd }); };
        window.addEmployee = () => { const n=document.getElementById('newAdminName').value; if(n) push(ref(db,'employees'),{name:n,joinDate:document.getElementById('newAdminDate').value,id:Date.now()}); };
        window.checkBirthdayEvents = () => {}; 
        window.renderBulletin = () => { document.getElementById('displayBulletinTitle').innerText = bulletin.title; document.getElementById('displayBulletinContent').innerText = bulletin.content; document.getElementById('displayBulletinDate').innerText = bulletin.date; };
        window.renderActivityFeed = () => { const feed = document.getElementById('activityFeed'); const approved = Object.values(requests).filter(r=>r.status==='approved' && new Date(r.date) >= new Date().setHours(0,0,0,0)).sort((a,b)=>new Date(a.date)-new Date(b.date)); if(approved.length===0) { feed.innerHTML='<div class="p-4 text-center text-xs text-slate-400">ç›®å‰ç„¡å‹•æ…‹</div>'; return; } feed.innerHTML = approved.map(r=>`<div class="p-3 border-b text-xs flex justify-between"><span><b>${r.empName}</b>: ${r.category==='car'?'ç”¨è»Š':r.type}</span><span class="text-slate-400">${r.date.slice(5)}</span></div>`).join(''); };
        
        // [MODIFIED] Added Edit Logic to Attendance Table
        window.renderAttendanceLog = () => { 
            const tbody = document.getElementById('attendanceTableBody'); 
            tbody.innerHTML = '';
            // Change Object.values to Object.entries to get the Key
            let data = Object.entries(attendance).sort((a,b)=>b[1].timestamp-a[1].timestamp);
            
            if(adminFilterId !== 'all') { 
                data = data.filter(([k,v]) => v.empId === adminFilterId); 
            }
            
            data.slice(0,30).forEach(([key, l]) => { 
                let statusColor = "text-slate-600";
                if(l.status === 'é²åˆ°') statusColor = "text-red-600 font-bold bg-red-50 px-2 py-0.5 rounded border border-red-100";
                if(l.status === 'åŠ ç­') statusColor = "text-purple-600 font-bold bg-purple-50 px-2 py-0.5 rounded border border-purple-100";
                
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-slate-50 transition">
                        <td class="p-2">${l.empName}</td>
                        <td class="p-2 ${l.type==='ä¸Šç­'?'text-blue-600':'text-orange-600'}">${l.type}</td>
                        <td class="p-2">${l.dateStr} <span class="text-[10px] text-slate-400">${l.timeStr}</span></td>
                        <td class="p-2"><span class="${statusColor}">${l.status||'æ­£å¸¸'}</span></td>
                        <td class="p-2 text-right">
                            <button onclick="openAdminEdit('${key}')" class="text-slate-400 hover:text-blue-600 px-2">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                        </td>
                    </tr>`; 
            }); 
        };

        // [NEW] Admin Edit Functions
        window.openAdminEdit = (key) => {
            const record = attendance[key];
            if(!record) return;
            document.getElementById('editAttKey').value = key;
            document.getElementById('editAttStatus').value = record.status || 'æ­£å¸¸';
            document.getElementById('editAttTime').value = record.timeStr;
            document.getElementById('adminEditModal').style.display = 'flex';
        };

        window.closeAdminEdit = () => {
            document.getElementById('adminEditModal').style.display = 'none';
        };

        window.saveAdminEdit = () => {
            const key = document.getElementById('editAttKey').value;
            const status = document.getElementById('editAttStatus').value;
            const timeStr = document.getElementById('editAttTime').value;
            
            update(ref(db, `attendance/${key}`), {
                status: status,
                timeStr: timeStr
            }).then(() => {
                Swal.fire('ä¿®æ”¹æˆåŠŸ', 'è€ƒå‹¤ç‹€æ…‹å·²æ›´æ–°', 'success');
                closeAdminEdit();
            });
        };

        window.deleteAttendance = () => {
            const key = document.getElementById('editAttKey').value;
            Swal.fire({
                title: 'ç¢ºå®šåˆªé™¤?',
                text: "æ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'åˆªé™¤'
            }).then((result) => {
                if (result.isConfirmed) {
                    remove(ref(db, `attendance/${key}`)).then(() => {
                        Swal.fire('å·²åˆªé™¤', '', 'success');
                        closeAdminEdit();
                    });
                }
            });
        };

        window.renderLogForm = () => { const c = document.getElementById('logEntriesContainer'); if(!c || c.children.length > 1) return; c.innerHTML=''; ["09:00 ~ 10:00", "10:00 ~ 11:00", "11:00 ~ 12:00", "13:30 ~ 14:30", "14:30 ~ 15:30", "15:30 ~ 16:30", "16:30 ~ 17:30", "17:30 ~ 18:30"].forEach(s=>{ let o='<option value="">-- é¸æ“‡ --</option>'; taskOptions.forEach(op=>o+=`<option value="${op}">${op}</option>`); c.innerHTML+=`<div class="bg-white p-2 rounded border border-slate-200 flex flex-col md:flex-row gap-2 items-center shadow-sm"><div class="text-xs font-bold text-slate-500 w-full md:w-24 bg-slate-50 p-1.5 rounded text-center">${s}</div><select name="logTask" class="flex-1 p-1.5 text-sm border rounded w-full md:w-auto outline-none focus:border-blue-500">${o}</select><input type="text" name="logDetail" class="flex-1 p-1.5 text-sm border rounded w-full md:w-auto outline-none focus:border-blue-500" placeholder="å…§å®¹"><input type="hidden" name="logTime" value="${s}"></div>`; }); };
        window.saveBulletin = () => { set(ref(db, 'bulletin'), { title: document.getElementById('adminBulletinTitle').value, content: document.getElementById('adminBulletinContent').value, date: new Date().toLocaleDateString() }); Swal.fire('å…¬å‘Šå·²æ›´æ–°'); };
        document.getElementById('leaveDate').valueAsDate = new Date(); document.getElementById('carDate').valueAsDate = new Date(); document.getElementById('logDate').valueAsDate = new Date();
    </script>
</body>
</html>