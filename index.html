<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®åœ‹åœ°æ”¿|æ˜“ä¸åœ°æ”¿ - æ™ºæ…§æŒ‡æ®è‰™ (Ultimate)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .serif { font-family: 'Noto Serif TC', serif; }
        .brand-bg { background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%); } 
        .text-brand-gold { color: #facc15; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-radius: 1rem; }
        .input-modern { background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.5rem; transition: all 0.2s; }
        .input-modern:focus { background: #fff; border-color: #2563eb; outline: none; }
        .hidden-section { display: none; }
        
        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-badge { padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: bold; }
        .status-pending { background-color: #fef3c7; color: #d97706; }
        .status-approved { background-color: #dcfce7; color: #166534; }
        .status-rejected { background-color: #fee2e2; color: #991b1b; }
        .fade-in-up { animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* è–ªè³‡å½±éŸ¿æç¤ºå¡ (é—œéµæ¨£å¼) */
        .impact-card { transition: all 0.3s ease; border-left: 4px solid; background-color: white; border: 1px solid #e2e8f0; border-left-width: 4px; }
        .impact-full { border-left-color: #22c55e; background-color: #f0fdf4; } /* å…¨è–ª (ç¶ ) */
        .impact-half { border-left-color: #f97316; background-color: #fff7ed; } /* åŠè–ª (æ©˜) */
        .impact-none { border-left-color: #ef4444; background-color: #fef2f2; } /* ç„¡è–ª (ç´…) */

        /* æ‰“å¡æŒ‰éˆ•ç‰¹æ•ˆ */
        .btn-punch { transition: transform 0.1s; }
        .btn-punch:active { transform: scale(0.95); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="brand-bg text-white sticky top-0 z-50 shadow-md">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white text-blue-900 rounded-lg flex items-center justify-center font-bold text-lg serif shadow-lg">å®</div>
                <div>
                    <h1 class="text-base md:text-lg font-bold tracking-wider serif">å®åœ‹åœ°æ”¿ | æ˜“ä¸åœ°æ”¿</h1>
                    <p class="text-[10px] text-blue-200 tracking-widest uppercase">HR & Attendance System</p>
                </div>
            </div>
            <div class="flex bg-blue-900/50 rounded-full p-1">
                <button onclick="switchView('employee')" id="btnEmp" class="px-4 py-1.5 rounded-full text-xs md:text-sm font-medium transition-all bg-white text-blue-900 shadow-sm">åŒä»å°ˆå€</button>
                <button onclick="checkAdminLogin()" id="btnAdm" class="px-4 py-1.5 rounded-full text-xs md:text-sm font-medium text-blue-200 hover:text-white transition-all">ç®¡ç†å¾Œå°</button>
            </div>
        </div>
    </header>

    <main class="flex-grow p-4 md:p-6 max-w-7xl mx-auto w-full">
        <section id="loginSection" class="w-full glass-panel p-10 text-center max-w-lg mx-auto mt-12 fade-in-up">
            <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-2xl"><i class="fa-solid fa-bolt"></i></div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">ç³»çµ±é€£ç·šä¸­...</h2>
            <p class="text-slate-500 mb-6 text-sm">æ­£åœ¨åŒæ­¥æœ€æ–°å“¡å·¥è³‡æ–™</p>
            <select id="empSelect" onchange="loadEmployeeDashboard()" class="w-full p-3 pl-4 text-lg input-modern cursor-pointer text-center font-bold text-slate-700 disabled:opacity-50" disabled>
                <option value="">-- è³‡æ–™è¼‰å…¥ä¸­ --</option>
            </select>
        </section>

        <section id="employeeView" class="w-full space-y-6 hidden-section">
             <div class="brand-bg rounded-2xl p-6 text-white relative overflow-hidden shadow-xl fade-in-up">
                <div class="relative z-10 flex flex-col md:flex-row items-start gap-4">
                    <div class="bg-white/10 p-3 rounded-xl backdrop-blur-sm shrink-0"><i class="fa-solid fa-bullhorn text-brand-gold text-xl"></i></div>
                    <div class="w-full">
                        <div class="flex justify-between items-start">
                            <h3 id="displayBulletinTitle" class="font-bold text-lg text-brand-gold mb-1">...</h3>
                            <span id="displayBulletinDate" class="text-[10px] bg-black/20 px-2 py-1 rounded text-slate-300">--/--</span>
                        </div>
                        <p id="displayBulletinContent" class="text-slate-200 text-sm leading-relaxed whitespace-pre-wrap">...</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="glass-panel p-6 border-l-4 border-blue-600 fade-in-up">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2">
                                <i class="fa-solid fa-location-dot text-blue-600"></i> å®šä½æ‰“å¡
                            </h3>
                            <span class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded" id="clockTime">--:--:--</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="handlePunch('ä¸Šç­')" class="btn-punch flex flex-col items-center justify-center p-4 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl shadow-lg shadow-blue-500/30 hover:shadow-xl">
                                <i class="fa-solid fa-sun text-2xl mb-2"></i>
                                <span class="font-bold">ä¸Šç­æ‰“å¡</span>
                            </button>
                            <button onclick="handlePunch('ä¸‹ç­')" class="btn-punch flex flex-col items-center justify-center p-4 bg-gradient-to-br from-orange-400 to-red-500 text-white rounded-xl shadow-lg shadow-orange-500/30 hover:shadow-xl">
                                <i class="fa-solid fa-moon text-2xl mb-2"></i>
                                <span class="font-bold">ä¸‹ç­æ‰“å¡</span>
                            </button>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-2 text-center"><i class="fa-solid fa-circle-info"></i> é»æ“Šå¾Œç³»çµ±å°‡å­˜å–æ‚¨çš„ GPS ä½ç½®ç´€éŒ„</p>
                    </div>

                    <div class="glass-panel p-6 flex flex-col sm:flex-row justify-between items-center bg-gradient-to-r from-white to-blue-50/30 fade-in-up">
                        <div class="flex items-center gap-4 w-full sm:w-auto">
                            <div class="w-14 h-14 bg-slate-800 text-white rounded-full flex items-center justify-center text-xl shadow-lg"><span id="dashboardAvatar">ğŸ‘¤</span></div>
                            <div>
                                <h2 id="dashboardName" class="text-xl font-bold text-slate-800">...</h2>
                                <div class="text-slate-500 text-xs mt-1 flex gap-2">
                                    <span class="bg-slate-100 px-2 py-0.5 rounded">å¹´è³‡ <span id="dashboardYears">--</span> å¹´</span>
                                    <span class="bg-slate-100 px-2 py-0.5 rounded">ç‰¹ä¼‘é¡åº¦ <span id="dashboardTotal">--</span> å¤©</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 sm:mt-0 text-center w-full sm:w-auto bg-white border border-blue-100 px-6 py-3 rounded-xl shadow-sm">
                            <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">ç‰¹ä¼‘å‰©é¤˜</p>
                            <div id="dashboardRemaining" class="text-3xl font-black text-blue-600 font-mono">0.0</div>
                        </div>
                    </div>

                    <div class="glass-panel p-6 border-t-4 border-brand-gold fade-in-up">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-file-signature text-brand-gold"></i> æäº¤è«‹å‡ç”³è«‹</h3>
                        <form onsubmit="handleLeaveSubmit(event)" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">å‡åˆ¥</label>
                                    <select id="leaveType" class="w-full p-2.5 input-modern" onchange="updateImpactInfo()">
                                        <option value="ç‰¹ä¼‘">ç‰¹ä¼‘ (Annual Leave)</option>
                                        <option value="ç—…å‡">ç—…å‡ (Sick Leave)</option>
                                        <option value="äº‹å‡">äº‹å‡ (Personal Leave)</option>
                                        <option value="è£œä¼‘">è£œä¼‘ (Compensatory)</option>
                                        <option value="å©šå‡">å©šå‡ (Marriage)</option>
                                        <option value="å–ªå‡">å–ªå‡ (Bereavement)</option>
                                        <option value="ç”Ÿç†å‡">ç”Ÿç†å‡ (Menstrual)</option>
                                    </select>
                                </div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">æ—¥æœŸ</label><input type="date" id="leaveDate" class="w-full p-2.5 input-modern"></div>
                                <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 mb-1">å¤©æ•¸</label><input type="number" id="leaveDays" min="0.5" step="0.5" value="1" class="w-full p-2.5 input-modern" oninput="updateImpactInfo()"></div>
                                <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 mb-1">äº‹ç”±</label><input type="text" id="leaveReason" class="w-full p-2.5 input-modern" placeholder="ä¾‹ï¼šè™•ç†ç§äººäº‹å‹™"></div>
                            </div>
                            
                            <div id="impactCard" class="impact-card impact-full p-4 rounded-lg flex justify-between items-center mt-2">
                                <div>
                                    <div class="font-bold text-sm text-slate-700" id="impactTitle">å…¨è–ª (å·¥è³‡ç…§çµ¦)</div>
                                    <div class="text-xs text-slate-500" id="impactDesc">ä¾å‹åŸºæ³•è¦å®šï¼Œæ­¤å‡åˆ¥æœŸé–“å·¥è³‡ç…§çµ¦ï¼Œä¸æ‰£ç™¼è–ªè³‡ã€‚</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-slate-400">é ä¼°æ‰£è–ª</div>
                                    <div class="font-bold text-lg text-slate-800">$<span id="impactAmount">0</span></div>
                                </div>
                            </div>

                            <button type="submit" class="w-full bg-[#06c755] hover:bg-[#05b34c] text-white font-bold py-3 rounded-lg shadow-lg transition active:scale-95 flex justify-center items-center gap-2"><i class="fa-brands fa-line"></i> é€å‡ºç”³è«‹ä¸¦é€šçŸ¥</button>
                        </form>
                    </div>

                    <div class="glass-panel p-6 fade-in-up">
                        <h3 class="font-bold text-slate-700 mb-4 text-sm uppercase tracking-wider">æœ€è¿‘è«‹å‡ç´€éŒ„</h3>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left"><tbody id="myRequestsTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                </div>

                <div class="space-y-6 lg:col-span-1">
                    <div class="glass-panel p-6 bg-slate-900 text-white fade-in-up">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold flex items-center gap-2"><i class="fa-solid fa-calculator text-brand-gold"></i> è–ªè³‡è¨­å®š</h3></div>
                        <div class="space-y-5">
                            <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                                <label class="block text-xs text-slate-400 mb-1">æ‚¨çš„æœˆè–ª (ç”¨æ–¼è¨ˆç®—æ‰£è–ª/åŠ ç­è²»)</label>
                                <input type="number" id="monthlySalary" value="30000" class="bg-transparent text-white font-bold text-lg w-full outline-none" oninput="calculateOvertime(); updateImpactInfo();">
                                <div class="text-right text-[10px] text-slate-400 mt-1">æ™‚è–ªç´„ $<span id="displayHourlyRate">125</span></div>
                            </div>
                            <div><div class="flex justify-between text-xs mb-1 text-slate-400"><span>å¹³æ—¥åŠ ç­ (å‰2hr)</span><span class="text-white font-bold"><span id="calcHours1Val">0</span> hr</span></div><input type="range" id="calcHours1" min="0" max="10" step="0.5" value="0" oninput="calculateOvertime()"></div>
                            <div><div class="flex justify-between text-xs mb-1 text-slate-400"><span>å¹³æ—¥åŠ ç­ (ç¬¬3hrèµ·)</span><span class="text-white font-bold"><span id="calcHours2Val">0</span> hr</span></div><input type="range" id="calcHours2" min="0" max="10" step="0.5" value="0" oninput="calculateOvertime()"></div>
                        </div>
                        <div class="mt-6 pt-4 border-t border-slate-700 text-center"><p class="text-xs text-slate-400 uppercase tracking-widest">é ä¼°åŠ ç­è²»</p><div class="text-3xl font-bold text-brand-gold mt-1">$<span id="calcTotal">0</span></div></div>
                    </div>
                    
                    <div class="glass-panel p-5 text-sm space-y-3 fade-in-up">
                        <h4 class="font-bold text-slate-700 border-b pb-2">å‡åˆ¥æ¬Šç›Šé€ŸæŸ¥ (å‹åŸºæ³•)</h4>
                        <div class="flex justify-between items-center"><span class="text-slate-500"><i class="fa-solid fa-plane-departure text-blue-400 w-5"></i>ç‰¹ä¼‘</span><span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded font-bold">å…¨è–ª (å·¥è³‡ç…§çµ¦)</span></div>
                        <div class="flex justify-between items-center"><span class="text-slate-500"><i class="fa-solid fa-notes-medical text-orange-400 w-5"></i>ç—…å‡</span><span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded font-bold">åŠè–ª (30å¤©å…§)</span></div>
                        <div class="flex justify-between items-center"><span class="text-slate-500"><i class="fa-solid fa-briefcase text-red-400 w-5"></i>äº‹å‡</span><span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded font-bold">ç„¡è–ª (æ‰£å…¨é¡)</span></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="adminView" class="hidden-section w-full fade-in-up">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <div class="lg:col-span-3 glass-panel p-6 border-t-4 border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-clock-rotate-left text-slate-700"></i> è€ƒå‹¤æ‰“å¡ç´€éŒ„
                        </h2>
                        <button onclick="exportAttendance()" class="bg-green-600 hover:bg-green-500 text-white text-xs px-3 py-2 rounded flex items-center gap-1 shadow">
                            <i class="fa-solid fa-file-excel"></i> åŒ¯å‡º Excel
                        </button>
                    </div>
                    <div class="overflow-x-auto max-h-60 overflow-y-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-100 text-slate-600 sticky top-0">
                                <tr>
                                    <th class="p-2">å§“å</th>
                                    <th class="p-2">é¡å‹</th>
                                    <th class="p-2">æ—¥æœŸ/æ™‚é–“</th>
                                    <th class="p-2">åœ°é»</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody" class="divide-y divide-slate-100 text-xs"></tbody>
                        </table>
                    </div>
                </div>

                <div class="lg:col-span-2 glass-panel p-6 border-t-4 border-blue-600">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-clipboard-check text-blue-600"></i> è«‹å‡å¯©æ ¸ä¸­å¿ƒ <span id="pendingCountBadge" class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span></h2>
                    <div class="overflow-x-auto"><table class="w-full text-left text-sm"><tbody id="approvalTableBody" class="divide-y divide-slate-100"></tbody></table></div>
                    <div id="noPendingMsg" class="text-center py-8 text-slate-400"><i class="fa-regular fa-circle-check text-4xl mb-2 text-slate-200"></i><p>ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„ç”³è«‹</p></div>
                </div>
                <div class="lg:col-span-1 glass-panel p-6 border-t-4 border-brand-gold">
                    <h2 class="text-lg font-bold text-slate-800 mb-4"><i class="fa-solid fa-bullhorn text-brand-gold mr-2"></i> å…¬å‘Šç®¡ç†</h2>
                    <input type="text" id="adminBulletinTitle" class="w-full p-2 mb-2 input-modern" placeholder="æ¨™é¡Œ">
                    <textarea id="adminBulletinContent" rows="4" class="w-full p-2 mb-2 input-modern" placeholder="å…§å®¹"></textarea>
                    <button onclick="saveBulletin()" class="w-full bg-slate-800 text-white p-2 rounded font-bold hover:bg-slate-700">ç™¼å¸ƒ</button>
                </div>
                <div class="lg:col-span-3 glass-panel p-6">
                    <h2 class="text-lg font-bold text-slate-800 mb-4"><i class="fa-solid fa-users mr-2"></i> å“¡å·¥è³‡æ–™åº«</h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="newAdminName" placeholder="å§“å" class="w-1/3 p-2 input-modern">
                        <select id="newAdminGender" class="w-1/3 p-2 input-modern"><option value="M">ç”·</option><option value="F">å¥³</option></select>
                        <input type="date" id="newAdminDate" class="w-1/3 p-2 input-modern">
                        <button onclick="addEmployee()" class="bg-blue-600 text-white px-4 rounded font-bold hover:bg-blue-500">æ–°å¢</button>
                    </div>
                    <div class="overflow-x-auto"><table class="w-full text-left text-sm"><tbody id="adminTableBody" class="divide-y divide-slate-100"></tbody></table></div>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js";

        // Config
        const firebaseConfig = {
            apiKey: "AIzaSyCcSH0HQutt6rYcFWjCKOpTSWkBDeinyvw",
            authDomain: "homego-system.firebaseapp.com",
            databaseURL: "https://homego-system-default-rtdb.firebaseio.com",
            projectId: "homego-system",
            storageBucket: "homego-system.firebasestorage.app",
            messagingSenderId: "679007509034",
            appId: "1:679007509034:web:df50010c5ab8cd7f964153",
            measurementId: "G-E7J5PVQJ4L"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const analytics = getAnalytics(app);
        const ADMIN_PASSWORD = "8888";

        let employees = {};
        let requests = {};
        let attendance = {};
        let bulletin = { title: "æ­¡è¿", content: "è³‡æ–™è®€å–ä¸­...", date: "" };
        let currentUserId = null;

        // æ™‚é˜
        setInterval(() => {
            const now = new Date();
            document.getElementById('clockTime').innerText = now.toLocaleTimeString();
        }, 1000);

        // --- Firebase Listener ---
        onValue(ref(db), (snapshot) => {
            const data = snapshot.val() || {};
            employees = data.employees || {};
            requests = data.requests || {};
            attendance = data.attendance || {};
            bulletin = data.bulletin || { title: "å°šç„¡å…¬å‘Š", content: "", date: "" };
            
            console.log("ğŸ”¥ Data Synced");
            updateEmpSelect();
            renderBulletin();
            if (currentUserId) loadEmployeeDashboard();
            renderAdminTable();
            renderApprovalQueue();
            renderAttendanceLog();
            
            const select = document.getElementById('empSelect');
            select.disabled = false;
            if(select.options[0].text === "-- è³‡æ–™è¼‰å…¥ä¸­ --") {
                select.options[0].text = "-- è«‹é¸æ“‡æ‚¨çš„å§“å --";
                document.querySelector('#loginSection h2').innerText = "æ­¡è¿å›ä¾†ï¼Œå¤¥ä¼´";
            }
        });

        // --- View Logic ---
        window.switchView = (view) => {
            document.getElementById('employeeView').classList.add('hidden-section');
            document.getElementById('adminView').classList.add('hidden-section');
            document.getElementById('loginSection').classList.add('hidden-section');
            const btnEmp = document.getElementById('btnEmp');
            const btnAdm = document.getElementById('btnAdm');

            if (view === 'employee') {
                document.getElementById('loginSection').classList.remove('hidden-section');
                currentUserId = null;
                document.getElementById('empSelect').value = "";
                btnEmp.classList.replace('text-blue-200', 'text-blue-900'); btnEmp.classList.replace('hover:text-white', 'bg-white');
                btnAdm.classList.replace('text-blue-900', 'text-blue-200'); btnAdm.classList.replace('bg-white', 'hover:text-white');
            } else {
                document.getElementById('adminView').classList.remove('hidden-section');
                btnAdm.classList.replace('text-blue-200', 'text-blue-900'); btnAdm.classList.replace('hover:text-white', 'bg-white');
                btnEmp.classList.replace('text-blue-900', 'text-blue-200'); btnEmp.classList.replace('bg-white', 'hover:text-white');
            }
        };

        window.checkAdminLogin = () => {
            let pass = prompt("ğŸ” è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
            if (pass === ADMIN_PASSWORD) window.switchView('admin');
            else if (pass !== null) alert("ğŸš« å¯†ç¢¼éŒ¯èª¤");
        };

        window.loadEmployeeDashboard = () => {
            const id = document.getElementById('empSelect').value;
            if (!id) return;
            currentUserId = id;
            const emp = employees[id];
            
            if (emp) {
                const calc = calculateLeave(emp.joinDate);
                const remaining = calc.days - (emp.usedLeave || 0);

                document.getElementById('dashboardName').innerText = emp.name;
                document.getElementById('dashboardAvatar').innerText = emp.gender === 'F' ? 'ğŸ‘©â€ğŸ’¼' : 'ğŸ‘¨â€ğŸ’¼';
                document.getElementById('dashboardYears').innerText = calc.years;
                document.getElementById('dashboardTotal').innerText = calc.days;
                
                const remEl = document.getElementById('dashboardRemaining');
                remEl.innerText = remaining;
                remEl.className = remaining < 0 ? "text-3xl font-black text-red-500 font-mono" : "text-3xl font-black text-blue-600 font-mono";

                document.getElementById('loginSection').classList.add('hidden-section');
                document.getElementById('employeeView').classList.remove('hidden-section');
                
                // ç¢ºä¿ç™»å…¥å¾Œç«‹å³æ›´æ–°è–ªè³‡èˆ‡å½±éŸ¿
                window.calculateOvertime();
                window.updateImpactInfo();
            }
        };

        // --- GPS Punch In/Out ---
        window.handlePunch = (type) => {
            if (!currentUserId) return;
            const emp = employees[currentUserId];
            
            if (!navigator.geolocation) {
                alert("âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½");
                return;
            }

            alert(`ğŸ“ æ­£åœ¨è®€å– GPS ä½ç½®ï¼Œè«‹ç¨å€™...`);

            navigator.geolocation.getCurrentPosition((position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const now = new Date();
                const timestamp = now.getTime();
                const dateStr = now.toLocaleDateString();
                const timeStr = now.toLocaleTimeString();

                const newRef = push(ref(db, 'attendance'));
                set(newRef, {
                    id: newRef.key,
                    empId: currentUserId,
                    empName: emp.name,
                    type: type, 
                    timestamp: timestamp,
                    dateStr: dateStr,
                    timeStr: timeStr,
                    location: `${lat}, ${lng}`,
                    mapLink: `https://www.google.com/maps?q=${lat},${lng}`
                });

                alert(`âœ… ${type}æ‰“å¡æˆåŠŸï¼\næ™‚é–“ï¼š${timeStr}\nä½ç½®å·²ç´€éŒ„ã€‚`);

            }, (error) => {
                alert(`âŒ æ‰“å¡å¤±æ•—ï¼šè«‹å…è¨±ç€è¦½å™¨è®€å–ä½ç½®æ¬Šé™ã€‚\n(éŒ¯èª¤ä»£ç¢¼: ${error.code})`);
            });
        };

        // --- Admin: Render Attendance Log ---
        function renderAttendanceLog() {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';
            const logs = Object.values(attendance).sort((a,b) => b.timestamp - a.timestamp);
            
            logs.forEach(log => {
                const colorClass = log.type === 'ä¸Šç­' ? 'text-blue-600' : 'text-orange-600';
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 border-b">
                        <td class="p-2 font-bold text-slate-700">${log.empName}</td>
                        <td class="p-2 font-bold ${colorClass}">${log.type}</td>
                        <td class="p-2 text-slate-500">${log.dateStr}<br>${log.timeStr}</td>
                        <td class="p-2">
                            <a href="${log.mapLink}" target="_blank" class="text-blue-500 hover:text-blue-700 underline text-xs">
                                <i class="fa-solid fa-map-location-dot"></i> æŸ¥çœ‹
                            </a>
                        </td>
                    </tr>
                `;
            });
        }

        window.exportAttendance = () => {
            const logs = Object.values(attendance).sort((a,b) => b.timestamp - a.timestamp);
            if (logs.length === 0) return alert("å°šç„¡æ‰“å¡ç´€éŒ„å¯åŒ¯å‡º");

            let csvContent = "\uFEFFå§“å,é¡å‹,æ—¥æœŸ,æ™‚é–“,Googleåœ°åœ–é€£çµ\n";
            logs.forEach(log => {
                const row = [
                    log.empName,
                    log.type,
                    log.dateStr,
                    log.timeStr,
                    log.mapLink
                ];
                csvContent += row.join(",") + "\n";
            });

            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `è€ƒå‹¤ç´€éŒ„_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- Leave Impact Logic (å‹åŸºæ³•æ¬Šç›Šæ ¸å¿ƒ) ---
        window.updateImpactInfo = () => {
            const type = document.getElementById('leaveType').value;
            const days = parseFloat(document.getElementById('leaveDays').value) || 0;
            const salary = parseInt(document.getElementById('monthlySalary').value) || 30000;
            const dailyRate = Math.round(salary / 30);
            
            const card = document.getElementById('impactCard');
            const title = document.getElementById('impactTitle');
            const desc = document.getElementById('impactDesc');
            const amount = document.getElementById('impactAmount');

            // ç§»é™¤èˆŠæ¨£å¼
            card.classList.remove('impact-full', 'impact-half', 'impact-none');
            let deduction = 0;

            switch(type) {
                case 'ç‰¹ä¼‘': case 'å©šå‡': case 'å–ªå‡': case 'è£œä¼‘':
                    card.classList.add('impact-full');
                    title.innerText = "å…¨è–ª (å·¥è³‡ç…§çµ¦)";
                    desc.innerText = "ä¾å‹åŸºæ³•è¦å®šï¼Œæ­¤å‡åˆ¥æœŸé–“å·¥è³‡ç…§çµ¦ï¼Œä¸æ‰£ç™¼è–ªè³‡ã€‚";
                    deduction = 0;
                    break;
                case 'ç—…å‡': case 'ç”Ÿç†å‡':
                    card.classList.add('impact-half');
                    title.innerText = "åŠè–ª (ç™¼çµ¦ä¸€åŠå·¥è³‡)";
                    desc.innerText = "ä¾å‹åŸºæ³•è¦å®šï¼Œæ™®é€šå‚·ç—…/ç”Ÿç†å‡æœŸé–“ï¼Œå·¥è³‡æŠ˜åŠç™¼çµ¦ã€‚";
                    deduction = Math.round(dailyRate * days * 0.5);
                    break;
                case 'äº‹å‡':
                    card.classList.add('impact-none');
                    title.innerText = "ç„¡è–ª (ä¸çµ¦å·¥è³‡)";
                    desc.innerText = "ä¾å‹åŸºæ³•è¦å®šï¼Œäº‹å‡æœŸé–“ä¸çµ¦ä»˜å·¥è³‡ã€‚";
                    deduction = Math.round(dailyRate * days);
                    break;
            }
            amount.innerText = deduction.toLocaleString();
        };

        window.handleLeaveSubmit = (e) => {
            e.preventDefault();
            if (!currentUserId) return;
            const emp = employees[currentUserId];
            const type = document.getElementById('leaveType').value;
            const date = document.getElementById('leaveDate').value;
            const days = parseFloat(document.getElementById('leaveDays').value);
            const reason = document.getElementById('leaveReason').value;

            const newReqRef = push(ref(db, 'requests'));
            set(newReqRef, {
                id: newReqRef.key,
                empId: currentUserId,
                empName: emp.name,
                type, date, days, reason,
                status: 'pending',
                timestamp: Date.now()
            });

            alert("âœ… ç”³è«‹å·²é€å‡ºï¼å¾…ç®¡ç†å“¡å¯©æ ¸ã€‚");
            const msg = `ã€è«‹å‡ç”³è«‹ã€‘\nğŸ‘¤ ${emp.name}\nğŸ“… ${date} (${days}å¤©)\nğŸ·ï¸ ${type}\nğŸ“ ${reason}`;
            window.open(`https://line.me/R/msg/text/?${encodeURIComponent(msg)}`);
            document.getElementById('leaveReason').value = '';
        };

        window.processRequest = (reqId, action) => {
            const req = requests[reqId];
            if (!req) return;
            if (action === 'approve') {
                if(!confirm(`ç¢ºèªæ‰¹å‡† ${req.empName} çš„è«‹å‡ï¼Ÿ`)) return;
                if (req.type === 'ç‰¹ä¼‘') {
                    const empRef = ref(db, `employees/${req.empId}/usedLeave`);
                    const currentUsed = employees[req.empId].usedLeave || 0;
                    set(empRef, currentUsed + req.days);
                }
                update(ref(db, `requests/${reqId}`), { status: 'approved' });
            } else {
                if(!confirm("ç¢ºèªé§å›ï¼Ÿ")) return;
                update(ref(db, `requests/${reqId}`), { status: 'rejected' });
            }
        };

        window.addEmployee = () => {
            const name = document.getElementById('newAdminName').value;
            const gender = document.getElementById('newAdminGender').value;
            const date = document.getElementById('newAdminDate').value;
            if(!name || !date) return alert("è³‡æ–™ä¸å®Œæ•´");
            const newEmpRef = push(ref(db, 'employees'));
            set(newEmpRef, { id: newEmpRef.key, name, gender, joinDate: date, usedLeave: 0 });
            document.getElementById('newAdminName').value = '';
        };

        window.deleteEmployee = (id) => {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤å“¡å·¥ï¼Ÿ")) remove(ref(db, `employees/${id}`));
        };

        window.saveBulletin = () => {
            set(ref(db, 'bulletin'), {
                title: document.getElementById('adminBulletinTitle').value,
                content: document.getElementById('adminBulletinContent').value,
                date: new Date().toLocaleDateString()
            });
            alert("å…¬å‘Šå·²æ›´æ–°");
        };

        function calculateLeave(joinDate) {
            const now = new Date();
            const start = new Date(joinDate);
            const diffTime = now - start;
            if (diffTime < 0) return { years: "0.0", days: 0 };
            const years = diffTime / (1000 * 60 * 60 * 24 * 365.25);
            let days = 0;
            if (years >= 0.5 && years < 1) days = 3;
            else if (years >= 1 && years < 2) days = 7;
            else if (years >= 2 && years < 3) days = 10;
            else if (years >= 3 && years < 5) days = 14;
            else if (years >= 5 && years < 10) days = 15;
            else if (years >= 10) days = Math.min(30, 15 + Math.floor(years - 10));
            return { years: years.toFixed(1), days: days };
        }

        function updateEmpSelect() {
            const select = document.getElementById('empSelect');
            const oldValue = select.value;
            select.innerHTML = '<option value="">-- è«‹é¸æ“‡æ‚¨çš„å§“å --</option>';
            Object.values(employees).forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.innerText = emp.name;
                select.appendChild(option);
            });
            if(employees[oldValue]) select.value = oldValue;
        }

        function renderAdminTable() {
            const tbody = document.getElementById('adminTableBody');
            tbody.innerHTML = '';
            Object.values(employees).forEach(emp => {
                const calc = calculateLeave(emp.joinDate);
                const remaining = calc.days - (emp.usedLeave || 0);
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 border-b">
                        <td class="p-3"><button onclick="deleteEmployee('${emp.id}')" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></td>
                        <td class="p-3 font-bold">${emp.name}</td>
                        <td class="p-3 text-xs text-slate-500">${emp.joinDate}<br>${calc.years}å¹´</td>
                        <td class="p-3 text-center">${calc.days}</td>
                        <td class="p-3 text-center">${emp.usedLeave || 0}</td>
                        <td class="p-3 text-center font-bold ${remaining < 0 ? 'text-red-500' : 'text-green-600'}">${remaining}</td>
                    </tr>`;
            });
        }

        function renderApprovalQueue() {
            const tbody = document.getElementById('approvalTableBody');
            const noMsg = document.getElementById('noPendingMsg');
            const badge = document.getElementById('pendingCountBadge');
            tbody.innerHTML = '';
            const pendingReqs = Object.values(requests).filter(r => r.status === 'pending').sort((a,b) => a.timestamp - b.timestamp);
            if (pendingReqs.length > 0) {
                noMsg.classList.add('hidden');
                badge.innerText = pendingReqs.length;
                badge.classList.remove('hidden');
                pendingReqs.forEach(req => {
                    tbody.innerHTML += `
                        <tr class="bg-white border-b hover:bg-slate-50">
                            <td class="p-3 font-bold text-slate-700">${req.empName}</td>
                            <td class="p-3"><div class="font-bold text-blue-900">${req.date}</div><div class="text-xs text-slate-500">${req.type} | ${req.days} å¤©</div></td>
                            <td class="p-3 text-sm text-slate-600">${req.reason}</td>
                            <td class="p-3 text-right space-x-2">
                                <button onclick="processRequest('${req.id}', 'approve')" class="bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200 text-xs font-bold">å‡†å‡</button>
                                <button onclick="processRequest('${req.id}', 'reject')" class="bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200 text-xs font-bold">é§å›</button>
                            </td>
                        </tr>`;
                });
            } else {
                noMsg.classList.remove('hidden');
                badge.classList.add('hidden');
            }
        }

        function renderBulletin() {
            document.getElementById('displayBulletinTitle').innerText = bulletin.title;
            document.getElementById('displayBulletinContent').innerText = bulletin.content;
            document.getElementById('displayBulletinDate').innerText = bulletin.date;
        }

        window.calculateOvertime = () => {
            const salary = parseInt(document.getElementById('monthlySalary').value) || 0;
            const hourlyRate = Math.round(salary / 240);
            const h1 = parseFloat(document.getElementById('calcHours1').value);
            const h2 = parseFloat(document.getElementById('calcHours2').value);
            document.getElementById('displayHourlyRate').innerText = hourlyRate;
            document.getElementById('calcHours1Val').innerText = h1;
            document.getElementById('calcHours2Val').innerText = h2;
            document.getElementById('calcTotal').innerText = Math.round((h1 * hourlyRate * 1.34) + (h2 * hourlyRate * 1.67)).toLocaleString();
        };

        document.getElementById('leaveDate').valueAsDate = new Date();
    </script>
</body>
</html>